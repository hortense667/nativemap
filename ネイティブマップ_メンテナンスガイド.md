# ネイティブマップ メンテナンスガイド

Copyright (c) 2025 Satoshi Endoh / @hortense667

## 概要

このガイドは、ネイティブマップの管理者向けの技術的な情報とメンテナンス手順を説明します。

## システム構成

### アーキテクチャ
- **フロントエンド**: HTML5 + JavaScript (`nativemap101.html`)
- **データストレージ**: GitHub REST Contents API + `localStorage`
- **デプロイ**: GitHub Pages / ローカルは `server.js`（Express）
- **認証**: GitHub Personal Access Token (PAT)
- **設定管理**: URLパラメータ + localStorage + 手動設定

### ファイル構成
```
nativemap/
├── nativemap101.html          # メインアプリケーション
├── timeline.json              # データファイル（運用で保護）
├── README.md                  # プロジェクト説明
├── LICENSE                    # ライセンス情報
├── ネイティブマップ_ユーザーガイド.md
└── ネイティブマップ_メンテナンスガイド.md
```

## URLパラメータ機能

### 概要
v1.0から追加された機能で、起動時にURLパラメータでリポジトリ情報を指定できます。これにより、異なるデータソースを簡単に切り替えることができます。

### 技術仕様
```javascript
// URLパラメータの解析
function getUrlParams() {
  const urlParams = new URLSearchParams(window.location.search);
  return {
    owner: urlParams.get('owner'),
    repo: urlParams.get('repo'),
    filePath: urlParams.get('filePath') || urlParams.get('path')
  };
}

// GitHub設定の更新
function updateGitHubConfigFromUrl() {
  const urlParams = getUrlParams();
  let configUpdated = false;

  if (urlParams.owner) {
    githubConfig.owner = urlParams.owner;
    configUpdated = true;
  }
  if (urlParams.repo) {
    githubConfig.repo = urlParams.repo;
    configUpdated = true;
  }
  if (urlParams.filePath) {
    githubConfig.filePath = urlParams.filePath;
    configUpdated = true;
  }

  if (configUpdated) {
    saveGitHubConfig();
  }
}
```

### 対応パラメータ
- **owner**: リポジトリ所有者（GitHubユーザー名または組織名）
- **repo**: リポジトリ名
- **filePath**: ファイルパス（`path`パラメータでも指定可能）

### 使用例
```
# 基本的な指定
nativemap101.html?owner=hortense667&repo=nativemap&filePath=timeline.json

# ファイルパスを省略（デフォルトのtimeline.jsonを使用）
nativemap101.html?owner=myusername&repo=mytimeline

# pathパラメータを使用
nativemap101.html?owner=myusername&repo=mytimeline&path=data.json
```

### 設定の優先順位
1. **URLパラメータ**（最優先）
2. **localStorage**（保存された設定）
3. **デフォルト値**（フォールバック）

### 運用上の注意点
- URLパラメータで指定された設定は自動的にlocalStorageに保存されます
- 設定画面での手動設定は、URLパラメータで上書きされます
- ヘッダーに現在のリポジトリ情報が表示されます（URLパラメータが指定された場合のみ）

## 管理者権限の設定

### GitHubリポジトリの権限設定

#### 1. リポジトリの設定
- **リポジトリ**: hortense667/nativemap
- **可視性**: Public
- **GitHub Pages**: 有効

#### 2. ファイル権限の制限
- **timeline.json**: ブランチ保護/レビュー必須で保護
- **nativemap101.html**: 公開
- **その他のファイル**: 運用ポリシーに準拠

#### 3. mainブランチ保護の設定手順
1) GitHub → リポジトリ → Settings → Branches → Branch protection rules → New rule
2) Branch name pattern: `main`
3) チェック推奨:
   - Require a pull request before merging（直接push禁止）
   - Require approvals（管理者の承認必須）
   - Require status checks to pass（任意）
   - Include administrators（必要なら管理者にも適用）
   - Restrict who can push to matching branches（管理者のみ許可）
4) 保存（Create / Save changes）

> 効果: 他ユーザーは`main`に直接変更できず、PR経由＋承認必須になります。`index.html`や`nativemap101.html`、`timeline.json`の誤変更を防止できます。

### 共同編集（コラボレーターのClassic Token運用）
- **目的**: 管理者以外のコラボレーターが、各自のGitHub Classic Token（`repo`スコープ）を本アプリの**Personal Access Token**に設定して、`timeline.json`を読み書きできるようにする。
- **前提条件**:
  - コラボレーターを対象リポジトリに招待し、少なくとも「Write」権限を付与
  - ブランチ保護ルール（PR必須/承認必須など）を理解し準拠
- **トークン要件（Classic）**:
  - 発行場所: `Settings > Developer settings > Personal access tokens > Tokens (classic)`
  - スコープ: `repo`
  - 保存: 秘密情報として取り扱い。漏えい時は即時Revoke
- **アプリ設定**:
  - 本アプリの「設定」画面で、各自のClassic Tokenを**Personal Access Token**に入力して保存
  - 所有者/リポジトリ/ファイルパスが実運用のものと一致していることを確認
- **運用上の注意**:
  - 編集前に「同期」で最新データ取得、編集後に必ず「同期」でGitHubへ保存
  - 同時編集の衝突を避けるため、編集担当・時間帯を分けるか、PRベースのワークフローを採用
  - ブランチ保護下では、直接保存が409や権限で失敗する場合があります。PR経由で反映してください
  - `raw.githubusercontent.com`のキャッシュにより反映に遅延が出る場合、ハードリロードやファイルパス一時変更で回避
- **トラブル対応**:
  - 保存失敗: トークン権限（`repo`）と有効期限、ブランチ保護の設定を確認
  - 反映されない: `main`ブランチの該当ファイルにコミットされているか、アプリ設定の`filePath`が一致しているか、JSONトップの`genres`/`events`構造の整合性を確認
  - 競合発生: 先に「同期」で最新を取得し、必要に応じて手動マージ or PRで解決

### Personal Access Token (PAT) の管理

#### 管理者用PAT
- **スコープ**: repo（読み取り/書き込み）
- **用途**: timeline.jsonの読み書き（Contents API）

#### 一般ユーザー用PAT
- **スコープ**: repo（読み取り中心。書き込みが必要な場合のみ付与）
- **用途**: timeline.jsonの読み取り

## データ管理

### 運用ルール（同期と並び順）
- 編集作業に入る前に、必ず**「同期」**でGitHubから最新データを取得してください。
- 編集作業（追加・削除・修正・詳細一覧でのドラッグ&ドロップによる順序変更）後は、必ず**「同期」**でGitHubに保存・反映してください。
- 同期前に複数端末/複数人で編集した場合、後から同期した内容で上書きされる可能性があります。編集開始前の取得と編集終了時の保存を徹底してください。

### データ構造
```json
{
  "genres": [
    {"code": "TVP", "label": "テレビ番組"},
    {"code": "JAPAN", "label": "[日本]", "conjunction": true}
  ],
  "events": {
    "1952": [
      { "label": "テレビ放送開始", "genre": "TVP", "imp": 5,
        "url": "https://ja.wikipedia.org/wiki/テレビ放送", "note": "日本初のテレビ放送開始" },
      { "label": "日本テレビ開局", "genre": ["TVP", "JAPAN"], "imp": 5,
        "url": "https://ja.wikipedia.org/wiki/日本テレビ放送網", "note": "民放初のテレビ局" }
    ]
  },
  "eraSettings": [
    { "enabled": true, "label": "テレビの時代", "start": 1950, "end": 1969, "fill": "#eef", "opacity": 0.3 }
  ]
}
```

### CSV/TSV読み込み形式
```csv
開始年;終了年;ラベル;ジャンル;重要度;URL;注釈
1946;;ENIAC;HAR;5;https://ja.wikipedia.org/wiki/ENIAC;初の大規模電子計算機
1983;1994;ファミコン;GAM;5;https://ja.wikipedia.org/wiki/ファミリーコンピュータ;家庭用ゲーム機の革命
1996;ongoing;東京ゲームショウ;EVT;5;https://ja.wikipedia.org/wiki/東京ゲームショウ;国内最大級のゲーム見本市
1953;;日本テレビ開局;TVP・JAPAN;5;https://ja.wikipedia.org/wiki/日本テレビ放送網;民放初のテレビ局
```

#### 技術仕様
- **区切り文字**: タブ、セミコロン、カンマ（自動検出）
- **ヘッダー行**: 「年」を含む行は自動スキップ
- **コメント行**: 「#」で始まる行は無視
- **文字コード**: UTF-8必須
- **検証項目**: 年齢範囲、重複チェック、ジャンル形式
- **複数ジャンル**: セミコロン区切りで複数ジャンルを指定可能（例：`TVP・JAPAN`）
- **conjunctionジャンル**: 複数ジャンル指定時にconjunction指定されたジャンルが含まれる場合、AND条件で絞り込み

#### ジャンル定義（genres）
- トップレベルに`genres`を追加することで、アプリのジャンル一覧（コードと表示名）を上書きできます。新規ジャンルセットへの入れ替えが可能です。
- サポート形式1（推奨・配列型）:
```json
{
  "genres": [
    {"code": "NEW", "label": "新ジャンル"},
    {"code": "ABC", "label": "独自カテゴリ"},
    {"code": "JAPAN", "label": "[日本]", "conjunction": true}
  ],
  "events": { /* ... */ },
  "eraSettings": [ /* ... */ ]
}
```
- サポート形式2（互換・オブジェクト型）:
```json
{
  "genres": {
    "list": ["NEW", "ABC"],
    "labels": { "NEW": "新ジャンル", "ABC": "独自カテゴリ" }
  },
  "events": { /* ... */ },
  "eraSettings": [ /* ... */ ]
}
```
- **conjunction機能**:
  - `"conjunction": true`を指定したジャンルは、選択時にAND条件で絞り込み
  - UIでは`[ジャンル名]`の形式で表示され、緑色系の色で区別
  - 例：`[日本]`ジャンルが選択された場合、そのジャンルが含まれるイベントのみが表示される
  - 通常ジャンル（OR条件）とconjunctionジャンル（AND条件）が混在する場合も正しく処理
- 運用のポイント:
  - `code`は英大文字推奨。イベントの`genre`も同じコードを使用
  - conjunction指定されたジャンルは、ラベル名を`[ジャンル名]`の形式で囲むことを推奨
  - 反映はGitHub上の対象ファイル（通常`timeline.json`）の更新後、アプリの「表示中の全ラベルをクリアしてGitHubから読み込み」で適用
  - ブランチ保護やPRフローの場合、`main`に反映されていることを確認
  - **重要**: `genres`項目は読み込み専用で、同期時にリモートJSONに書き戻されません

### データの整合性チェック
```javascript
// データ検証関数
function validateData(data) {
  const errors = [];
  const events = data.events || data;
  for (const [year, items] of Object.entries(events)) {
    if (!Number.isInteger(parseInt(year)) || parseInt(year) < 1945 || parseInt(year) > 2059) {
      errors.push(`Invalid year: ${year}`);
    }
    for (const item of items) {
      if (!item.label) errors.push(`Missing label in ${year}`);
      const genres = Array.isArray(item.genre) ? item.genre : (item.genre ? [item.genre] : []);
      for (const g of genres) {
        if (g && !GENRES.includes(String(g).toUpperCase())) {
          errors.push(`Invalid genre: ${g} in ${year}`);
        }
      }
      if (item.imp && (item.imp < 1 || item.imp > 5)) {
        errors.push(`Invalid importance: ${item.imp} in ${year}`);
      }
    }
  }
  return errors;
}
```

### バックアップ戦略
1. **GitHub**: 自動バックアップ（Git履歴）
2. **ローカル**: 定期的なtimeline.jsonのエクスポート
3. **外部**: 月次でのデータアーカイブ

## パフォーマンス管理

### 容量制限
- **推奨上限**: 20,000件
- **絶対上限**: 100MB（GitHub API制限）

### パフォーマンス最適化
```javascript
// 大量データ対応の最適化
function optimizeForLargeData() {
  // 1. 仮想スクロールの実装
  // 2. 検索結果のページネーション
  // 3. フィルタリングの最適化
  // 4. メモリ使用量の監視
}
```

### 監視項目
- **ファイルサイズ**: 月次チェック
- **登録件数**: 週次チェック
- **同期エラー**: 日次チェック
- **ユーザーアクセス**: 月次レポート

## セキュリティ管理

### アクセス制御
- **timeline.json**: ブランチ保護/レビュー必須等で保護
- **PAT管理**: 露出防止（クライアント入力を前提に保管しない）
- **ログ監視**: 異常なアクセスパターンの検出

### データ保護
- **入力検証**: すべての入力データの検証
- **XSS対策**: 出力時のエスケープ処理
- **CSRF対策**: GitHub APIの認証トークン使用

## トラブルシューティング

### よくある問題

#### 1. 同期エラー
```javascript
// エラーログの確認
console.log('GitHub API Error:', error);
// 対処法：
// - PATの有効性確認
// - ネットワーク接続確認
// - GitHub API制限の確認
```

#### 2. データ破損
```javascript
// データ復旧手順
// 1. GitHubの履歴から復旧（ファイル単位の復元 or Revert）
//   - リポジトリ → timeline.json → History → 正常なコミットを選択 → Revert または内容を反映
// 2. バックアップからの復旧
// 3. 手動でのデータ修正
```

#### 3. パフォーマンス問題
```javascript
// パフォーマンス監視
function monitorPerformance() {
  const startTime = performance.now();
  // 処理実行
  const endTime = performance.now();
  console.log(`Processing time: ${endTime - startTime}ms`);
}
```

### 緊急時対応

#### データ復旧手順
1. **GitHub履歴確認**: 最新の正常なコミットを特定
2. **Revert/Restore**: 対象コミットに戻す（ファイル単位/コミット単位）
3. **バックアップ復旧**: 最新のバックアップから復旧
4. **手動修正**: 必要に応じて手動でデータ修正
5. **検証**: データの整合性を確認
4. **検証**: データの整合性を確認

#### システム停止時の対応
1. **原因特定**: エラーログの確認
2. **緊急修正**: 必要に応じてコード修正
3. **復旧確認**: システムの正常動作確認
4. **ユーザー通知**: 影響範囲の通知

## 更新・メンテナンス

### 定期メンテナンス
- **週次**: エラーログの確認
- **月次**: データの整合性チェック
- **四半期**: セキュリティアップデート
- **年次**: システム全体の見直し

### 機能更新履歴

#### v1.0 (2025年)
- **ジャンルAND条件機能（conjunction）**: 
  - `"conjunction": true`を指定したジャンルはAND条件で絞り込み
  - UIでは`[ジャンル名]`の形式で表示され、緑色系の色で区別
  - 通常ジャンル（OR条件）とconjunctionジャンル（AND条件）の混在に対応
  - genres項目は読み込み専用で、同期時にリモートJSONに書き戻されない仕様

### URLパラメータ機能のメンテナンス
- **設定の確認**: URLパラメータで指定されたリポジトリが存在するか確認
- **アクセス権限**: 指定されたリポジトリへのアクセス権限を確認
- **ファイル存在**: 指定されたファイルパスが存在するか確認
- **エラーハンドリング**: 無効なパラメータが指定された場合の適切なエラー表示

### 機能追加・改善
1. **要件定義**: 新機能の要件を明確化
2. **設計**: システム設計の検討
3. **実装**: コードの実装
4. **テスト**: 動作確認とテスト
5. **デプロイ**: 本番環境への反映
6. **監視**: リリース後の監視

## ライセンス管理

### CC BY-SA 4.0 ライセンス
- **データ**: Creative Commons Attribution-ShareAlike 4.0
- **プログラム**: MIT License
- **帰属表示**: 適切なクレジット表示の確認

### ライセンス遵守の確認
- **データ使用**: 適切な帰属表示の確認
- **派生作品**: 同一ライセンスでの公開確認
- **商用利用**: ライセンス条件の遵守確認

## ドキュメント管理

### 更新頻度
- **ユーザーガイド**: 機能追加時に更新
- **メンテナンスガイド**: システム変更時に更新
- **README**: プロジェクト変更時に更新

### バージョン管理
- **ドキュメント**: Gitでバージョン管理
- **変更履歴**: 更新内容の記録
- **レビュー**: 変更内容のレビュー

## 連絡先・サポート

### 管理者連絡先
- **GitHub**: hortense667
- **Issues**: GitHub Issuesで問題報告
- **Pull Requests**: 機能改善の提案

### サポート体制
- **一般ユーザー**: ユーザーガイドでの自己解決
- **技術的問題**: GitHub Issuesで報告
- **緊急時**: 管理者への直接連絡

---

**ネイティブマップ メンテナンスガイド** - 管理者向け技術情報