<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒãƒƒãƒ— 1.0</title>
<style>
  :root { --bg:#fafafa; --grid:#d0d0d0; --axis:#888; --text:#222; }
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,sans-serif;color:var(--text);background:var(--bg)}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e5e5e5;display:flex;gap:12px;align-items:center;padding:10px 12px;flex-wrap:wrap}
  header .btn{padding:6px 10px;border:1px solid #ccc;border-radius:8px;background:#f7f7f7;cursor:pointer}
  header .btn:active{transform:translateY(1px)}
  header .legend{display:flex;gap:8px;align-items:center;margin-left:auto}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid #ddd;background:#fff;cursor:pointer}
  /* å°ã•ãªä¸¸ãƒœã‚¿ãƒ³ */
  .chipCircle{ width:28px; height:28px; padding:0; display:inline-flex; align-items:center; justify-content:center; border-radius:999px; }
  .chipCircle .dot{ width:14px; height:14px; border-radius:999px; }
  .chip .dot{width:12px;height:12px;border-radius:999px}
  .chip .dot.blue{background:#4da3ff}.chip .dot.red{background:#ff3333}
  .chip.off{opacity:.35}
  .filters{display:flex; gap:8px; align-items:center; }
  .filters select{padding:6px 8px; border:1px solid #ccc; border-radius:8px; background:#fff;}
  .search{display:flex; gap:6px; align-items:center; margin-left:auto}
  .search input{padding:6px 8px; border:1px solid #ccc; border-radius:8px; min-width:220px}
  .viewport{width:100%;height:calc(100% - 58px);overflow:auto;background:#fff}
  .stage{width:2400px;height:2600px;transform-origin:0 0}
  .tooltip{position:absolute;background:#fff;border:1px solid #ccc;padding:8px 10px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.08);pointer-events:none;font-size:12px;z-index:20}
  .hint{font-size:12px;color:#666}
  .handle{cursor:ns-resize}
  .axisLabel{font-weight:700;fill:#9a9a9a;font-size:40px;opacity:.6}
  .eventLabel{font-size:13px;fill:#c00}
  .eventMulti{fill:#c00}
  .gridMinor{stroke:var(--grid);stroke-width:1}
  .gridMajor{stroke:#b0b0b0;stroke-width:1.5}
  .ageAxis,.birthAxis{stroke:var(--axis);stroke-width:2}
  .ageTickText{font-size:18px;fill:#4a4a4a;font-weight:700}
  .eventColBg{fill:#fafafa}
  .eventColBorder{stroke:#e5e5e5;stroke-width:1}
  .handleLane{fill:#f4f9ff}
  .handleLaneBorder{stroke:#d7e8ff;stroke-width:1}
  .editAreaHint{font-size:12px;fill:#888}
  body.dragging{user-select:none;-webkit-user-select:none}
  /* ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ */
  .editor{ position:absolute; background:#fff; border:1px solid #ccc; border-radius:10px; box-shadow:0 12px 28px rgba(0,0,0,.18); padding:10px; width:520px; z-index:30; }
  .editor h4{ margin:0 0 6px; font-size:14px; display:flex; align-items:center; gap:8px; justify-content:space-between; }
  .editor .fmt{ font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; color:#555; background:#f4f4f4; border:1px solid #e0e0e0; border-radius:6px; padding:2px 6px; }
  .editor textarea{ width:100%; min-height:200px; font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; padding:8px; border:1px solid #d0d0d0; border-radius:8px; box-sizing:border-box; resize:vertical; white-space:pre-wrap; overflow-x:hidden; overflow-y:auto; word-break:break-word; }
  .editor .row{ display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:8px; }
  .editor .row .left{ color:#666; font-size:12px; }
  .editor .row button{ padding:6px 10px; border:1px solid #bbb; border-radius:8px; background:#f5f5f5; cursor:pointer; }
  /* æ¤œç´¢åè»¢ */
  .hlText{ fill:#fff !important; }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modalOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:1000; align-items:center; justify-content:center; }
  .modal{ background:#fff; width:min(880px, calc(100% - 32px)); max-height:84vh; overflow:auto; border-radius:12px; box-shadow:0 24px 80px rgba(0,0,0,.25); }
  .modal header{ position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; }
  .modal header h3{ margin:0; font-size:16px; }
  .modal .content{ padding:16px 18px; font-size:14px; line-height:1.8; }
  .modal .content h4{ margin:14px 0 6px; font-size:15px; }
  .modal .content p{ margin:8px 0; }
  .modal .content ul{ margin:6px 0 6px 22px; }
  .modal .content code{ background:#f6f6f6; border:1px solid #e3e3e3; padding:1px 4px; border-radius:4px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .modal footer{ padding:10px 16px 16px; display:flex; justify-content:flex-end; }
  .modal footer .btn{ background:#f6f6f6; border:1px solid #ddd; border-radius:10px; padding:6px 10px; cursor:pointer; }
  .credit{ font-size:12px; color:#777; margin-top:8px; }
</style>
</head>
<body>
  <header>
    <strong style="font-size: 1.5em;">ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒãƒƒãƒ— 1.0</strong>
    <div id="repoInfo" style="font-size: 12px; color: #666; margin-left: 12px; display: none;">
      <span id="repoInfoText"></span>
    </div>
    <div class="filters" id="filters">
      <button id="genreFilterBtn" style="padding: 4px 8px; border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; border-radius: 4px;">
        ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ
      </button>
      <label>é‡è¦åº¦
        <select id="filterImp">
          <option value="">ã™ã¹ã¦</option>
          <option>1</option>
          <option>2</option>
          <option>3</option>
          <option>4</option>
          <option>5</option>
        </select>
      </label>
      <button id="eraBtn" style="padding: 4px 8px; border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; border-radius: 4px;">
        æ™‚ä»£åŒºåˆ†
      </button>
    </div>
    <div class="search">
      <input id="searchBox" type="text" placeholder="ãƒ©ãƒ™ãƒ«ã‚’æ¤œç´¢ï¼ˆé¸æŠä¸­ã‚¸ãƒ£ãƒ³ãƒ«ã®ã¿ï¼‰" />
      <button class="btn" id="searchBtn">æ¤œç´¢</button>
      <button class="btn" id="prevBtn">å‰</button>
      <button class="btn" id="nextBtn">æ¬¡</button>
    </div>
    <div class="legend">
      <button class="btn" id="syncBtn" title="GitHubã¨åŒæœŸ">åŒæœŸ</button>
      <button class="btn" id="settingsBtn" title="è¨­å®š">è¨­å®š</button>
      <button class="btn" id="helpBtn" title="ãƒ˜ãƒ«ãƒ—">ãƒ˜ãƒ«ãƒ—</button>
      <input type="file" id="fileInput" accept=".csv,.tsv,text/csv,text/tab-separated-values,text/plain" style="display:none" />
      <button class="chip chipCircle" id="toggleBlue" aria-pressed="true" title="æ°´è‰²ãƒ©ã‚¤ãƒ³ã®è¡¨ç¤ºï¼éè¡¨ç¤º"><span class="dot blue"></span></button>
      <button class="chip chipCircle" id="toggleRed" aria-pressed="true" title="èµ¤è‰²ãƒ©ã‚¤ãƒ³ã®è¡¨ç¤ºï¼éè¡¨ç¤º"><span class="dot red"></span></button>
    </div>
  </header>
  <div class="viewport" id="viewport">
    <svg class="stage" id="stage" xmlns="http://www.w3.org/2000/svg">
      <rect x="0" y="0" width="480" height="2600" class="eventColBg" id="eventColBg"/>
      <line x1="480" y1="0" x2="480" y2="2600" class="eventColBorder"/>
      <g id="grid"></g>
      <g id="decades"></g>
      <g id="events"></g>
      <g id="probe-blue"></g>
      <g id="probe-red"></g>
      <text x="12" y="2580" class="editAreaHint">ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ã€‚1950sï½2050sã¾ã§ä¸Šä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã€‚</text>
    </svg>
  </div>
  <div id="tooltip" class="tooltip" style="display:none"></div>
  <div id="editor" class="editor" style="display:none"></div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ˜ãƒ«ãƒ—ï¼†ã‚¨ãƒ©ãƒ¼ï¼‰ -->
  <div id="modal" class="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h3 id="modalTitle">ãƒ€ã‚¤ã‚¢ãƒ­ã‚°</h3>
      </header>
      <div class="content" id="modalContent"></div>
      <footer><button class="btn" id="modalClose">é–‰ã˜ã‚‹</button></footer>
    </div>
  </div>

  <!-- æ—¢å®šã®å¹´è¡¨JSONï¼ˆåˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã¿ä½¿ç”¨ï¼‰ã€‚ä»¥é™ã¯ localStorage ã‚’å„ªå…ˆã€‚-->
  <script id="events-json" type="application/json">{
    "1952": [{"label":"ãƒ†ãƒ¬ãƒ“æ”¾é€é–‹å§‹"}],
    "1956": [{"label":"å›½ç”£åˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿"}],
    "1960": [{"label":"å›½é‰„äºˆç´„ã‚·ã‚¹ãƒ†ãƒ "},{"label":"ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚¾ãƒ¼ãƒ³"}],
    "1963": [{"label":"é‰„è…•ã‚¢ãƒˆãƒ "},{"label":"é‰„äºº28å·"}],
    "1966": [{"label":"ã‚¦ãƒ«ãƒˆãƒ©Q"},{"label":"ã‚µãƒ³ãƒ€ãƒ¼ãƒãƒ¼ãƒ‰"}],
    "1969": [{"label":"ä½å‹éŠ€è¡Œã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ã‚¹ãƒšãƒ³ã‚µ"},{"label":"ã‚¢ãƒãƒ­11å·ãƒ»æœˆç€é™¸"}],
    "1971": [{"label":"ä»®é¢ãƒ©ã‚¤ãƒ€ãƒ¼"}],
    "1973": [{"label":"ã€8æ™‚ã ãƒ§ï¼å…¨å“¡é›†åˆã€è¦–è´ç‡50%"}],
    "1977": [{"label":"Apple IIãªã©åˆæœŸãƒã‚¤ã‚³ãƒ³"}],
    "1978": [{"label":"ãƒã‚¤ã‚³ãƒ³å…¥ã‚Šè£½å“æ¬¡ã€…ç™»å ´"}],
    "1979": [{"label":"æ©Ÿå‹•æˆ¦å£«ã‚¬ãƒ³ãƒ€ãƒ "}],
    "1983": [{"label":"ä»»å¤©å ‚ãƒ•ã‚¡ãƒŸã‚³ãƒ³"}],
    "1984": [{"label":"ãƒ‰ãƒ©ã‚´ãƒ³ãƒœãƒ¼ãƒ«"}],
    "1986": [{"label":"PC-9801VM"},{"label":"ãƒ“ãƒ‡ã‚ªãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»AVãƒ“ãƒ‡ã‚ª"}],
    "1995": [{"label":"æ–°ä¸–ç´€ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³"},{"label":"GHOST IN THE SHELL æ”»æ®»æ©Ÿå‹•éšŠ"}],
    "1996": [{"label":"ãƒ‘ã‚½ã‚³ãƒ³é€šä¿¡æµè¡Œ"},{"label":"å¥³å­é«˜ç”Ÿã«ãƒã‚±ãƒ™ãƒ«ãƒ–ãƒ¼ãƒ "},{"label":"ãŸã¾ã”ã£ã¡"},{"label":"ãƒ›ãƒ³ãƒ€P2"}],
    "1999": [{"label":"iãƒ¢ãƒ¼ãƒ‰ãƒ»å†™ãƒ¡ãƒ¼ãƒ«"},{"label":"MATRIX"}],
    "2001": [{"label":"ãƒ¤ãƒ•ãƒ¼ï¼BBé–‹å§‹"}],
    "2005": [{"label":"YouTube"}],
    "2006": [{"label":"ã€ããã‚‹ã€ãŒæµè¡Œèªå¤§è³"}],
    "2007": [{"label":"é›»è„³ã‚³ã‚¤ãƒ«"}],
    "2010": [{"label":"iPhoneãƒ–ãƒ¬ãƒ¼ã‚¯"},{"label":"GAFAã®å½±éŸ¿åŠ›æ‹¡å¤§"}],
    "2016": [{"label":"DJI Phantom 4ï¼ãƒ‰ãƒ­ãƒ¼ãƒ³"}],
    "2018": [{"label":"Ready Player One"}],
    "2020": [{"label":"VRï¼ãƒ¡ã‚¿ãƒãƒ¼ã‚¹æ³¨ç›®"}],
    "2022": [{"label":"ChatGPTï¼ç”ŸæˆAI"}],
    "2023": [{"label":"Web3"}]
  </script>

<script>
(function(){
  const vp=document.getElementById('viewport');
  const stage=document.getElementById('stage');
  const gridG=document.getElementById('grid');
  const decadesG=document.getElementById('decades');
  const eventsG=document.getElementById('events');
  const editor=document.getElementById('editor');
  const genreFilterBtn=document.getElementById('genreFilterBtn');
  const selImp=document.getElementById('filterImp');
  const searchBox=document.getElementById('searchBox');
  const searchBtn=document.getElementById('searchBtn');
  const prevBtn=document.getElementById('prevBtn');
  const nextBtn=document.getElementById('nextBtn');
  const loadCsvBtn=null;
  const syncBtn=document.getElementById('syncBtn');
  const settingsBtn=document.getElementById('settingsBtn');
  console.log('settingsBtn:', settingsBtn);
  const helpBtn=document.getElementById('helpBtn');
  const fileInput=document.getElementById('fileInput');
  const eventColBg=document.getElementById('eventColBg');
  const modal=document.getElementById('modal');
  const modalTitle=document.getElementById('modalTitle');
  const modalContent=document.getElementById('modalContent');
  const modalClose=document.getElementById('modalClose');

  const YEAR_MIN=1945, YEAR_MAX=2059, AGE_MAX=100;
  const PX_PER_YEAR=22, PX_PER_AGE=25;
  const LEFT_COL_W=480, DECADE_GUTTER=72, ORIGIN_X=LEFT_COL_W, ORIGIN_Y=40;
  const HANDLE_LANE_W=24; // ç‹­ã‚ãŸãƒ‰ãƒ©ãƒƒã‚°ãƒ¬ãƒ¼ãƒ³
  const HANDLE_X = ORIGIN_X - HANDLE_LANE_W/2;
  const LABEL_LEFT_X = DECADE_GUTTER + 2;               // ãƒ©ãƒ™ãƒ«è¡¨ç¤ºé–‹å§‹ä½ç½®ï¼ˆå·¦ï¼‰
  const LABEL_RIGHT_X = ORIGIN_X - HANDLE_LANE_W - 8;   // ãƒ©ãƒ™ãƒ«è¡¨ç¤ºçµ‚äº†ï¼ˆå³ï¼‰
  const width=ORIGIN_X+PX_PER_AGE*(AGE_MAX+2)+200;
  const height=ORIGIN_Y+PX_PER_YEAR*((YEAR_MAX-YEAR_MIN+1)+3);
  stage.setAttribute('width',width); stage.setAttribute('height',height);
  // ã‚¯ãƒªãƒƒãƒ—ãƒ‘ã‚¹
  const ns='http://www.w3.org/2000/svg';
  const defs=document.createElementNS(ns,'defs');
  const cpEvents=document.createElementNS(ns,'clipPath'); cpEvents.setAttribute('id','clip-events');
  const cpErect=document.createElementNS(ns,'rect'); cpErect.setAttribute('x', DECADE_GUTTER); cpErect.setAttribute('y', 0); cpErect.setAttribute('width', LEFT_COL_W - DECADE_GUTTER - HANDLE_LANE_W - 4); cpErect.setAttribute('height', height); cpEvents.appendChild(cpErect);
  const cpDec=document.createElementNS(ns,'clipPath'); cpDec.setAttribute('id','clip-decades');
  const cpDrect=document.createElementNS(ns,'rect'); cpDrect.setAttribute('x', 0); cpDrect.setAttribute('y', 0); cpDrect.setAttribute('width', DECADE_GUTTER - 4); cpDrect.setAttribute('height', height); cpDec.appendChild(cpDrect);
  defs.appendChild(cpEvents); defs.appendChild(cpDec); stage.insertBefore(defs, stage.firstChild);
  eventsG.setAttribute('clip-path','url(#clip-events)');
  decadesG.setAttribute('clip-path','url(#clip-decades)');

  // ãƒ‰ãƒ©ãƒƒã‚°å°‚ç”¨ãƒ¬ãƒ¼ãƒ³ï¼ˆå¹…24pxï¼‰ã‚’æ™‚ä»£ã§è‰²åˆ†ã‘
  function createHandleLaneWithEraColors() {
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth() + 1; // 0-11 -> 1-12
    const currentDay = currentDate.getDate();
    
    // ä»¤å’Œã®ç¾åœ¨æ—¥ä»˜ã¾ã§ã®Yåº§æ¨™ã‚’è¨ˆç®—
    const reiwaCurrentY = yFromBirthYear(currentYear) + (currentMonth - 1) * (PX_PER_YEAR / 12) + (currentDay - 1) * (PX_PER_YEAR / 365);
    
    // æ˜­å’Œï¼ˆ1926-1988ï¼‰
    const showaRect = document.createElementNS(ns, 'rect');
    showaRect.setAttribute('x', ORIGIN_X - HANDLE_LANE_W);
    showaRect.setAttribute('y', yFromBirthYear(1926));
    showaRect.setAttribute('width', HANDLE_LANE_W);
    showaRect.setAttribute('height', yFromBirthYear(1989) - yFromBirthYear(1926));
    showaRect.setAttribute('fill', '#f0f8ff'); // æ˜­å’Œï¼šæ·¡ã„é’
    stage.insertBefore(showaRect, gridG);
    
    // å¹³æˆï¼ˆ1989-2018ï¼‰
    const heiseiRect = document.createElementNS(ns, 'rect');
    heiseiRect.setAttribute('x', ORIGIN_X - HANDLE_LANE_W);
    heiseiRect.setAttribute('y', yFromBirthYear(1989));
    heiseiRect.setAttribute('width', HANDLE_LANE_W);
    heiseiRect.setAttribute('height', yFromBirthYear(2019) - yFromBirthYear(1989));
    heiseiRect.setAttribute('fill', '#f0fff0'); // å¹³æˆï¼šæ·¡ã„ç·‘
    stage.insertBefore(heiseiRect, gridG);
    
    // ä»¤å’Œï¼ˆ2019-ç¾åœ¨ï¼‰
    const reiwaRect = document.createElementNS(ns, 'rect');
    reiwaRect.setAttribute('x', ORIGIN_X - HANDLE_LANE_W);
    reiwaRect.setAttribute('y', yFromBirthYear(2019));
    reiwaRect.setAttribute('width', HANDLE_LANE_W);
    reiwaRect.setAttribute('height', reiwaCurrentY - yFromBirthYear(2019));
    reiwaRect.setAttribute('fill', '#fff0f0'); // ä»¤å’Œï¼šæ·¡ã„èµ¤
    stage.insertBefore(reiwaRect, gridG);
    
    // ä»¤å’Œã®ç¾åœ¨æ—¥ä»˜ä»¥é™ã¯ç™½
    if (currentYear < YEAR_MAX) {
      const reiwaFutureRect = document.createElementNS(ns, 'rect');
      reiwaFutureRect.setAttribute('x', ORIGIN_X - HANDLE_LANE_W);
      reiwaFutureRect.setAttribute('y', reiwaCurrentY);
      reiwaFutureRect.setAttribute('width', HANDLE_LANE_W);
      reiwaFutureRect.setAttribute('height', yFromBirthYear(YEAR_MAX + 1) - reiwaCurrentY);
      reiwaFutureRect.setAttribute('fill', '#ffffff'); // æœªæ¥ï¼šç™½
      stage.insertBefore(reiwaFutureRect, gridG);
    }
    
    // å¢ƒç•Œç·š
    const laneBorder = document.createElementNS(ns, 'line');
  laneBorder.setAttribute('x1', ORIGIN_X - HANDLE_LANE_W);
  laneBorder.setAttribute('x2', ORIGIN_X - HANDLE_LANE_W);
  laneBorder.setAttribute('y1', 0);
  laneBorder.setAttribute('y2', height);
    laneBorder.setAttribute('class', 'handleLaneBorder');
  stage.insertBefore(laneBorder, gridG);
  }
  
  createHandleLaneWithEraColors();

  function yFromBirthYear(by){return ORIGIN_Y+(by-YEAR_MIN)*PX_PER_YEAR;}
  function xFromAge(age){return ORIGIN_X+age*PX_PER_AGE;}
  function lineEl(x1,y1,x2,y2,cls){let l=document.createElementNS('http://www.w3.org/2000/svg','line');l.setAttribute('x1',x1);l.setAttribute('y1',y1);l.setAttribute('x2',x2);l.setAttribute('y2',y2);if(cls) l.setAttribute('class',cls);return l;}
  function textEl(txt,x,y,cls){let t=document.createElementNS('http://www.w3.org/2000/svg','text');t.textContent=txt;t.setAttribute('x',x);t.setAttribute('y',y);if(cls) t.setAttribute('class',cls);return t;}
  function circleEl(cx,cy,r,cls){let c=document.createElementNS('http://www.w3.org/2000/svg','circle');c.setAttribute('cx',cx);c.setAttribute('cy',cy);c.setAttribute('r',r);if(cls)c.setAttribute('class',cls);return c;}

  // ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…±é€šï¼‰ =====
  function openModal(title, html){
    const prevFocus = document.activeElement;
    modalTitle.textContent = title;
    modalContent.innerHTML = html;
    modal.setAttribute('aria-hidden','false');
    modal.style.display = 'flex';
    modal.dataset.prevFocusId = prevFocus && prevFocus.id ? prevFocus.id : '';
    modalClose.focus();
  }
  function openModalText(title, text){
    const prevFocus = document.activeElement;
    modalTitle.textContent = title;
    modalContent.textContent = text;
    modal.setAttribute('aria-hidden','false');
    modal.style.display = 'flex';
    modal.dataset.prevFocusId = prevFocus && prevFocus.id ? prevFocus.id : '';
    modalClose.focus();
  }
  function closeModal(){
    const id = modal.dataset.prevFocusId;
    if(id){ const el = document.getElementById(id); if(el) el.focus(); }
    modal.setAttribute('aria-hidden','true');
    modal.style.display='none';
  }
  modalClose.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.style.display==='flex') closeModal(); });
  function showError(title, errors){
    const text = Array.isArray(errors) ? errors.join('\n') : String(errors||'');
    openModalText(title, text);
  }
  function showInfo(title, html){ openModal(title, html); }

  // ===== æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆã®çŠ¶æ…‹ =====
  let matches=[]; let matchIndex=-1; let hlRect=null; let hlTarget=null; let clearOnNextMove=false;
  function clearHighlight(soft){ if(hlRect && hlRect.parentNode) hlRect.parentNode.removeChild(hlRect); if(hlTarget) hlTarget.classList.remove('hlText'); hlRect=null; hlTarget=null; if(!soft){ clearOnNextMove=false; } }
  function highlight(el){ clearHighlight(true); const bbox=el.getBBox(); hlRect=document.createElementNS(ns,'rect'); const padX=6, padY=3; hlRect.setAttribute('x', bbox.x - padX); hlRect.setAttribute('y', bbox.y - padY); hlRect.setAttribute('width', bbox.width + padX*2); hlRect.setAttribute('height', bbox.height + padY*2); hlRect.setAttribute('rx', 4); hlRect.setAttribute('fill', '#000'); eventsG.insertBefore(hlRect, el); el.classList.add('hlText'); hlTarget=el; const r=el.getBoundingClientRect(); const rv=vp.getBoundingClientRect(); if(r.top < rv.top || r.bottom > rv.bottom){ vp.scrollTop += (r.top - rv.top) - 80; } clearOnNextMove=true; }

  // ===== JSONãƒ­ãƒ¼ãƒ‰/ã‚»ãƒ¼ãƒ– =====
  const LS_KEYS=['timelineEventsV2','timelineEventsV1'];
  // ===== ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã€‚GitHub JSONã® genres ã«ã‚ˆã‚Šä¸Šæ›¸ãå¯èƒ½ï¼‰ =====
  let GENRES=['ANI','MAN','GAM','TVP','MOV','NET','HAR','PHE','SOF','TOY','FAS','BOO','MAG','NOV','MUS','IDL','RDO','EVT','FMT','SPW','RDE','FOO','UNC'];
  let GENRE_LABELS={
    'ANI':'ã‚¢ãƒ‹ãƒ¡','MAN':'ãƒãƒ³ã‚¬','GAM':'ã‚²ãƒ¼ãƒ ','TVP':'ãƒ†ãƒ¬ãƒ“ç•ªçµ„',
    'MOV':'æ˜ ç”»','NET':'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ','HAR':'ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢','PHE':'ç¾è±¡ãƒ»æµè¡Œ',
    'SOF':'ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢','TOY':'ãŠã‚‚ã¡ã‚ƒ','FAS':'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³','BOO':'æ›¸ç±',
    'MAG':'é›‘èªŒ','NOV':'å°èª¬','MUS':'éŸ³æ¥½','IDL':'ã‚¢ã‚¤ãƒ‰ãƒ«','RDO':'ãƒ©ã‚¸ã‚ª',
    'EVT':'ã‚¤ãƒ™ãƒ³ãƒˆ','FMT':'ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ','SPW':'ã‚¹ãƒãƒ¼ãƒ„','RDE':'ãƒ†ãƒ¼ãƒãƒ‘ãƒ¼ã‚¯',
    'FOO':'é£Ÿ','UNC':'ãã®ä»–'
  };
  let GENRE_SET=new Set(GENRES);
  function setGenresFromRemote(genresDef){
    try{
      if(Array.isArray(genresDef) && genresDef.length){
        // æœŸå¾…ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: [{code:'ANI', label:'ã‚¢ãƒ‹ãƒ¡'}, ...]
        const codes=[]; const labels={};
        for(const g of genresDef){
          const code=String(g.code||'').toUpperCase();
          if(!code) continue;
          codes.push(code);
          labels[code]=g.label||code;
        }
        if(codes.length){ GENRES=codes; GENRE_LABELS=labels; GENRE_SET=new Set(GENRES); }
      } else if(genresDef && genresDef.list && Array.isArray(genresDef.list)){
        // äº’æ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: {list:['ANI',...], labels:{ANI:'ã‚¢ãƒ‹ãƒ¡',...}}
        const codes=genresDef.list.map(c=>String(c).toUpperCase());
        const labels={...genresDef.labels};
        if(codes.length){ GENRES=codes; GENRE_LABELS=labels||GENRE_LABELS; GENRE_SET=new Set(GENRES); }
      }
    }catch(e){ console.warn('ã‚¸ãƒ£ãƒ³ãƒ«å®šç¾©ã®é©ç”¨ã«å¤±æ•—:', e); }
  }
  function getGenreKey(genre){
    if(Array.isArray(genre)) return genre.map(g=>String(g).toUpperCase()).sort().join('ãƒ»');
    return String(genre||'').toUpperCase();
  }
  function itemHasSelectedGenre(item){
    // é¸æŠãªã—ã¯ trueï¼ˆå¾Œæ®µã§ç©ºé›†åˆæ‰±ã„ã®ç®‡æ‰€ã¯åˆ¥é€”åˆ¶å¾¡ï¼‰
    if(selectedGenres.size===0) return true;
    const g=item.genre;
    if(Array.isArray(g)) return g.some(code=>selectedGenres.has(String(code).toUpperCase()));
    const code=String(g||'UNC').toUpperCase();
    return selectedGenres.has(code);
  }
  function normalizeItem(it){ if(typeof it==='string') return {label: it}; const o={ label: it.label||'' }; if(it.startYear!==undefined && it.startYear!==null && String(it.startYear)!==''){ const n = parseInt(it.startYear,10); if(n>=YEAR_MIN && n<=YEAR_MAX) o.startYear=n; else o.startYear=''; } if(it.endYear!==undefined && it.endYear!==null && String(it.endYear)!==''){ if(String(it.endYear).toLowerCase() === 'ongoing') { o.endYear = 'ongoing'; } else { const n = parseInt(it.endYear,10); if(n>=YEAR_MIN && n<=YEAR_MAX) o.endYear=n; else o.endYear=''; } } if(it.genre) { if(Array.isArray(it.genre)) { o.genre = it.genre.map(g => String(g).toUpperCase()); } else { const genres = String(it.genre).split('ãƒ»').map(g => g.trim().toUpperCase()); o.genre = genres.length > 0 ? genres : [String(it.genre).toUpperCase()]; } } if(it.imp!==undefined && it.imp!==null && String(it.imp)!==''){ const n = parseInt(it.imp,10); if(n>=1 && n<=5) o.imp=n; else o.imp=''; } if(it.url) o.url = it.url; if(it.note) o.note = it.note; if(it.deleted !== undefined) o.deleted = it.deleted; return o; }
  function normalizeAll(obj){ const out={}; for(const y of Object.keys(obj)){ const arr = Array.isArray(obj[y])? obj[y] : []; out[y] = arr.map(normalizeItem).filter(it=>it.label); } return out; }
  function loadEvents(){ 
    for(const k of LS_KEYS){ 
      try{ 
        const s=localStorage.getItem(k); 
        if(s){ 
          const data = JSON.parse(s);
          if (data.events) {
            // æ–°ã—ã„å½¢å¼ï¼ˆevents + eraSettingsï¼‰
            eraSettings = data.eraSettings || [];
            if (data.genres) { setGenresFromRemote(data.genres); }
            console.log('loadEvents: eraSettingsèª­ã¿è¾¼ã¿:', eraSettings);
            return normalizeAll(data.events);
          } else {
            // å¤ã„å½¢å¼ï¼ˆeventsã®ã¿ï¼‰
            console.log('loadEvents: å¤ã„å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿');
            return normalizeAll(data);
          }
        } 
      }catch(e){} 
    } 
    try{ 
      const txt=document.getElementById('events-json').textContent.trim(); 
      const embedded=JSON.parse(txt);
      // åŸ‹ã‚è¾¼ã¿JSONã«ã‚‚ genres ãŒã‚ã‚Œã°ä½¿ç”¨
      if (embedded.genres) { setGenresFromRemote(embedded.genres); }
      return normalizeAll(embedded.events ? embedded.events : embedded); 
    } catch(e){ 
      console.error('embedded JSON parse failed', e); 
      return {}; 
    } 
  }
  // ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’ç®¡ç†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  let editFlags = {};
  
  
  // ãƒ‡ãƒ¼ã‚¿é®®åº¦æ™‚åˆ»ï¼ˆGitHubä¸Šã®jsonã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰
  let dataFreshnessTimestamp = null;
  
  // ãƒ©ãƒ™ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆç·¨é›†å‰ã®ãƒ‡ãƒ¼ã‚¿ï¼‰
  let labelBackups = {};
  
  // ç‰©ç†å‰Šé™¤ç”¨ã®å‰Šé™¤è¨˜éŒ²ï¼ˆCSVå‡ºåŠ›ã®ãŸã‚ã«ä¿æŒï¼‰
  let deletionRecords = [];
  
  // é †ç•ªå¤‰æ›´ãƒ•ãƒ©ã‚°
  let orderChanged = false;
  
  // ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’ä¿å­˜
  function saveEditFlags() {
    localStorage.setItem('nativemap_edit_flags', JSON.stringify(editFlags));
  }
  
  // ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’èª­ã¿è¾¼ã¿
  function loadEditFlags() {
    const saved = localStorage.getItem('nativemap_edit_flags');
    if (saved) {
      editFlags = JSON.parse(saved);
    }
  }
  
  
  // ãƒ‡ãƒ¼ã‚¿é®®åº¦æ™‚åˆ»ã‚’ä¿å­˜
  function saveDataFreshnessTimestamp() {
    localStorage.setItem('nativemap_data_freshness', JSON.stringify(dataFreshnessTimestamp));
  }
  
  // ãƒ‡ãƒ¼ã‚¿é®®åº¦æ™‚åˆ»ã‚’èª­ã¿è¾¼ã¿
  function loadDataFreshnessTimestamp() {
    const saved = localStorage.getItem('nativemap_data_freshness');
    if (saved) {
      dataFreshnessTimestamp = JSON.parse(saved);
    }
  }
  
  // ãƒ©ãƒ™ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜
  function saveLabelBackups() {
    localStorage.setItem('nativemap_label_backups', JSON.stringify(labelBackups));
  }
  
  // ãƒ©ãƒ™ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿
  function loadLabelBackups() {
    const saved = localStorage.getItem('nativemap_label_backups');
    if (saved) {
      labelBackups = JSON.parse(saved);
    }
  }
  
  // é …ç›®ã®ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
  function setEditFlag(year, label, genre) {
    const key = `${year}|${label}|${genre || ''}`;
    editFlags[key] = true;
    saveEditFlags();
    console.log('ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š:', key);
  }
  
  // é …ç›®ã®ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
  function hasEditFlag(year, label, genre) {
    const key = `${year}|${label}|${genre || ''}`;
    return editFlags[key] === true;
  }
  
  // ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
  function clearEditFlags() {
    editFlags = {};
    saveEditFlags();
    console.log('ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
  }
  
  
  // ãƒ©ãƒ™ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¨­å®š
  function setLabelBackup(year, label, genre, backupData) {
    const key = `${year}|${label}|${genre || ''}`;
    labelBackups[key] = backupData;
    saveLabelBackups();
    console.log('ãƒ©ãƒ™ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¨­å®š:', key, backupData);
  }
  
  // ãƒ©ãƒ™ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—
  function getLabelBackup(year, label, genre) {
    const key = `${year}|${label}|${genre || ''}`;
    return labelBackups[key];
  }
  
  // ãƒ©ãƒ™ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢
  function clearLabelBackups() {
    labelBackups = {};
    saveLabelBackups();
    console.log('ãƒ©ãƒ™ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
  }

  // å‰Šé™¤è¨˜éŒ²ã®ä¿å­˜/èª­è¾¼/è¿½åŠ /ã‚¯ãƒªã‚¢
  function saveDeletionRecords(){
    localStorage.setItem('nativemap_deletions', JSON.stringify(deletionRecords));
  }
  function loadDeletionRecords(){
    try{
      const s = localStorage.getItem('nativemap_deletions');
      deletionRecords = s ? JSON.parse(s) : [];
    }catch(e){ deletionRecords = []; }
  }
  function addDeletionRecord(year, item){
    if(!item) return;
    const genreKey = Array.isArray(item.genre) ? item.genre.slice().sort().join('ãƒ»') : (item.genre || '');
    const rec = {
      year: Number(item.startYear || year || ''),
      startYear: item.startYear || year || '',
      endYear: item.endYear || '',
      label: item.label || '',
      genre: genreKey,
      deleted: true,
      imp: item.imp || '',
      url: item.url || '',
      note: item.note || ''
    };
    deletionRecords.push(rec);
    saveDeletionRecords();
  }
  function clearDeletionRecords(){
    deletionRecords = [];
    saveDeletionRecords();
  }

  // tombstoneï¼ˆå‰Šé™¤è¨˜éŒ²ï¼‰ãƒã‚§ãƒƒã‚¯
  function _genreKey(genre){
    if(Array.isArray(genre)) return genre.slice().map(g=>String(g).toUpperCase()).sort().join('ãƒ»');
    return String(genre||'').toUpperCase();
  }
  function isLocallyDeleted(year, label, genre){
    const key = `${String(label||'')}|${_genreKey(genre)}`;
    for(const rec of (deletionRecords||[])){
      const rKey = `${String(rec.label||'')}|${_genreKey(rec.genre)}`;
      if(Number(rec.year)===Number(year) && rKey===key) return true;
    }
    return false;
  }
  
  // ãƒ‡ãƒ¼ã‚¿é®®åº¦æ™‚åˆ»ã‚’è¨­å®š
  function setDataFreshnessTimestamp(timestamp) {
    dataFreshnessTimestamp = timestamp;
    saveDataFreshnessTimestamp();
    console.log('ãƒ‡ãƒ¼ã‚¿é®®åº¦æ™‚åˆ»ã‚’è¨­å®š:', timestamp);
  }
  
  // ãƒ‡ãƒ¼ã‚¿é®®åº¦æ™‚åˆ»ã‚’å–å¾—
  function getDataFreshnessTimestamp() {
    return dataFreshnessTimestamp;
  }
  
  // é †ç•ªå¤‰æ›´ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
  function setOrderChanged(flag) {
    orderChanged = flag;
    console.log('é †ç•ªå¤‰æ›´ãƒ•ãƒ©ã‚°ã‚’è¨­å®š:', flag);
  }
  
  // é †ç•ªå¤‰æ›´ãƒ•ãƒ©ã‚°ã‚’å–å¾—
  function getOrderChanged() {
    return orderChanged;
  }
  
  // è¦æ³¨æ„ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
  function isCautionMode(remoteTimestamp) {
    const localTimestamp = getDataFreshnessTimestamp();
    if (!localTimestamp || !remoteTimestamp) {
      return false;
    }
    
    const localDate = new Date(localTimestamp);
    const remoteDate = new Date(remoteTimestamp);
    
    return remoteDate > localDate;
  }
  
  // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã®åŒæœŸå‡¦ç†
  function performNormalModeSync(localData, remoteData) {
    console.log('é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã®åŒæœŸã‚’å®Ÿè¡Œ');
    
    // å¸¸ã«ãƒªãƒ¢ãƒ¼ãƒˆã®é †åºã‚’æ¡ç”¨
    console.log('ãƒªãƒ¢ãƒ¼ãƒˆã®é †åºã‚’æ¡ç”¨');
    
    // ç·¨é›†ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹é …ç›®ã®ã¿ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ä¿æŒã€ãã‚Œä»¥å¤–ã¯ãƒªãƒ¢ãƒ¼ãƒˆã‚’æ¡ç”¨
    const merged = {};
    
    for (const [year, localItems] of Object.entries(localData)) {
      const remoteItems = remoteData[year] || [];
      const mergedItems = [];
      const localItemMap = new Map();
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒãƒƒãƒ—åŒ–
      localItems.forEach(item => {
        const key = `${item.label}|${item.genre || ''}`;
        localItemMap.set(key, item);
      });
      
      // ãƒªãƒ¢ãƒ¼ãƒˆã®é †åºã«å¾“ã£ã¦å‡¦ç†
      remoteItems.forEach(remoteItem => {
        const key = `${remoteItem.label}|${remoteItem.genre || ''}`;
        const localItem = localItemMap.get(key);
        const hasLocalEdit = localItem ? hasEditFlag(year, localItem.label, localItem.genre) : false;
        const hasLocalDelete = localItem ? localItem.deleted === true : false;
        const deletedByTombstone = isLocallyDeleted(year, remoteItem.label, remoteItem.genre);
        
        if (deletedByTombstone) {
          return; // tombstoneãŒã‚ã‚‹ã®ã§æ¡ç”¨ã—ãªã„
        } else if (hasLocalEdit || hasLocalDelete) {
          // å‰Šé™¤ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹å ´åˆã¯çµæœã«å«ã‚ãªã„ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆé …ç›®ã‚’å‰Šé™¤æ‰±ã„ï¼‰
          if (hasLocalDelete) {
            return; // skip
          }
          // ç·¨é›†ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚’æ¡ç”¨
          mergedItems.push(localItem);
        } else {
          // ç·¨é›†ãƒ•ãƒ©ã‚°ã‚‚å‰Šé™¤ãƒ•ãƒ©ã‚°ã‚‚ç«‹ã£ã¦ã„ãªã„å ´åˆã¯ãƒªãƒ¢ãƒ¼ãƒˆã‚’æ¡ç”¨
          mergedItems.push(remoteItem);
        }
      });
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã«å­˜åœ¨ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ï¼ˆtombstoneã¯é™¤å¤–ï¼‰
      for (const [key, localItem] of localItemMap) {
        const existsInRemote = remoteItems.some(remoteItem => {
          const remoteKey = `${remoteItem.label}|${remoteItem.genre || ''}`;
          return remoteKey === key;
        });
        
        if (!existsInRemote) {
          if (localItem && (localItem.deleted === true || isLocallyDeleted(year, localItem.label, localItem.genre))) continue;
          mergedItems.push(localItem);
        }
      }
      
      // ãƒªãƒ¢ãƒ¼ãƒˆã®ã¿ã«å­˜åœ¨ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
      remoteItems.forEach(remoteItem => {
        const key = `${remoteItem.label}|${remoteItem.genre || ''}`;
        const existsInLocal = localItemMap.has(key);
        
        if (!existsInLocal) {
          mergedItems.push(remoteItem);
        }
      });
      
      // å¿µã®ãŸã‚å‰Šé™¤ãƒ•ãƒ©ã‚°ã®ã‚‚ã®ã‚’é™¤å»
      merged[year] = mergedItems.filter(it => it && it.deleted !== true);
    }
    
    return { merged, conflicts: [] };
  }
  
  // è¦æ³¨æ„ãƒ¢ãƒ¼ãƒ‰ã§ã®åŒæœŸå‡¦ç†
  function performCautionModeSync(localData, remoteData) {
    console.log('è¦æ³¨æ„ãƒ¢ãƒ¼ãƒ‰ã§ã®åŒæœŸã‚’å®Ÿè¡Œ');
    
    const conflicts = [];
    const merged = {};
    
    for (const [year, localItems] of Object.entries(localData)) {
      const remoteItems = remoteData[year] || [];
      const mergedItems = [];
      const localItemMap = new Map();
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒãƒƒãƒ—åŒ–
      localItems.forEach(item => {
        const key = `${item.label}|${item.genre || ''}`;
        localItemMap.set(key, item);
      });
      
      // ãƒªãƒ¢ãƒ¼ãƒˆã®é †åºã«å¾“ã£ã¦å‡¦ç†
      remoteItems.forEach(remoteItem => {
        const key = `${remoteItem.label}|${remoteItem.genre || ''}`;
        const localItem = localItemMap.get(key);
        const hasLocalEdit = localItem ? hasEditFlag(year, localItem.label, localItem.genre) : false;
        const hasLocalDelete = localItem ? localItem.deleted === true : false;
        const deletedByTombstone = isLocallyDeleted(year, remoteItem.label, remoteItem.genre);
        
        if (deletedByTombstone) {
          return; // tombstoneã«ã‚ˆã‚Šå‰Šé™¤
        } else if (hasLocalEdit || hasLocalDelete) {
          if (hasLocalDelete) {
            // å‰Šé™¤ã¯çµæœã«å«ã‚ãªã„
            return;
          } else if (hasLocalEdit) {
            // ç·¨é›†ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹å ´åˆã¯ç«¶åˆãƒã‚§ãƒƒã‚¯
            const backup = getLabelBackup(year, localItem.label, localItem.genre);
            if (backup && JSON.stringify(backup) === JSON.stringify(remoteItem)) {
              // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒªãƒ¢ãƒ¼ãƒˆãŒåŒã˜å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ç·¨é›†ã‚’æ¡ç”¨ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆã®é †åºã§é…ç½®ï¼‰
              mergedItems.push(localItem);
            } else {
              // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒªãƒ¢ãƒ¼ãƒˆãŒç•°ãªã‚‹å ´åˆã¯ç«¶åˆã‚¨ãƒ©ãƒ¼
              conflicts.push({
                year: year,
                label: localItem.label,
                genre: localItem.genre || '',
                localItem: localItem,
                remoteItem: remoteItem,
                conflictFields: [{ field: 'content', localValue: localItem, remoteValue: remoteItem }]
              });
              // ç«¶åˆã®å ´åˆã¯ãƒªãƒ¢ãƒ¼ãƒˆã®å†…å®¹ã‚’æ¡ç”¨
              mergedItems.push(remoteItem);
            }
          }
        } else {
          // ç·¨é›†ãƒ•ãƒ©ã‚°ã‚‚å‰Šé™¤ãƒ•ãƒ©ã‚°ã‚‚ç«‹ã£ã¦ã„ãªã„å ´åˆã¯ãƒªãƒ¢ãƒ¼ãƒˆã‚’æ¡ç”¨
          mergedItems.push(remoteItem);
        }
      });
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã«å­˜åœ¨ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
      for (const [key, localItem] of localItemMap) {
        const existsInRemote = remoteItems.some(remoteItem => {
          const remoteKey = `${remoteItem.label}|${remoteItem.genre || ''}`;
          return remoteKey === key;
        });
        
        if (!existsInRemote) {
          if (localItem && (localItem.deleted === true || isLocallyDeleted(year, localItem.label, localItem.genre))) continue;
          mergedItems.push(localItem);
        }
      }
      // tombstoneé™¤å¤–
      merged[year] = mergedItems.filter(it => it && it.deleted !== true);
    }
    
    return { merged, conflicts };
  }

  function saveEvents(){ 
    try{ 
      const data = {
        events: events,
        eraSettings: eraSettings,
        genres: GENRES.map(code=>({code, label: (GENRE_LABELS && GENRE_LABELS[code]) ? GENRE_LABELS[code] : code}))
      };
      
      // å‰Šé™¤ãƒ•ãƒ©ã‚°ä»˜ãã®é …ç›®ã‚’ãƒã‚§ãƒƒã‚¯
      let deletedItems = [];
      for (const year of Object.keys(events)) {
        const items = events[year] || [];
        for (const item of items) {
          if (item.deleted === true) {
            deletedItems.push({ year, label: item.label, deleted: item.deleted });
          }
        }
      }
      
      console.log('saveEvents: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜', {
        hasEvents: !!data.events,
        hasEraSettings: !!data.eraSettings,
        eraSettingsLength: data.eraSettings.length,
        deletedItemsCount: deletedItems.length,
        deletedItems: deletedItems
      });
      localStorage.setItem('timelineEventsV2', JSON.stringify(data)); 
    }catch(e){
      console.error('saveEvents ã‚¨ãƒ©ãƒ¼:', e);
    } 
  }

  // ===== æ™‚ä»£åŒºåˆ† ====
  let eraSettings = []; // æ™‚ä»£åŒºåˆ†ã®è¨­å®šãƒ‡ãƒ¼ã‚¿

  // ===== GitHubåŒæœŸæ©Ÿèƒ½ =====
  let githubConfig = {
    accessToken: '',
    owner: 'hortense667',
    repo: 'nativemap',
    filePath: 'timeline.json'
  };

  // åˆæœŸåŒ–æ™‚ã«ãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  let events = {};
  
  // ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’èª­ã¿è¾¼ã¿
  loadEditFlags();
  
  
  // ãƒ‡ãƒ¼ã‚¿é®®åº¦æ™‚åˆ»ã‚’èª­ã¿è¾¼ã¿
  loadDataFreshnessTimestamp();
  
  // ãƒ©ãƒ™ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿
  loadLabelBackups();
  
  // æ™‚ä»£åŒºåˆ†ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆloadEventsã§æ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ãªã„ï¼‰
  if (!eraSettings || eraSettings.length === 0) {
    eraSettings = loadEraSettings();
  }
  
  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’å–å¾—ã™ã‚‹é–¢æ•°
  function getUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
      owner: urlParams.get('owner'),
      repo: urlParams.get('repo'),
      filePath: urlParams.get('filePath') || urlParams.get('path')
    };
  }

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§GitHubè¨­å®šã‚’æ›´æ–°
  function updateGitHubConfigFromUrl() {
    const urlParams = getUrlParams();
    let configUpdated = false;

    if (urlParams.owner) {
      githubConfig.owner = urlParams.owner;
      configUpdated = true;
    }
    if (urlParams.repo) {
      githubConfig.repo = urlParams.repo;
      configUpdated = true;
    }
    if (urlParams.filePath) {
      githubConfig.filePath = urlParams.filePath;
      configUpdated = true;
    }

    if (configUpdated) {
      saveGitHubConfig();
      console.log('URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰GitHubè¨­å®šã‚’æ›´æ–°:', githubConfig);
      // URLã®æ•´åˆæ€§ã‚‚ä¿ã¤ï¼ˆowner/repo/filePath ã®ç¾åœ¨å€¤ã‚’åæ˜ ï¼‰
      try{
        const params = new URLSearchParams(window.location.search);
        if(githubConfig.owner) params.set('owner', githubConfig.owner); else params.delete('owner');
        if(githubConfig.repo) params.set('repo', githubConfig.repo); else params.delete('repo');
        if(githubConfig.filePath) params.set('filePath', githubConfig.filePath); else params.delete('filePath');
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.replaceState(null, '', newUrl);
      }catch(e){ console.warn('URLæ›´æ–°ã«å¤±æ•—:', e); }
    }
  }

  // ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤º
  function updateRepoInfoDisplay() {
    const repoInfoDiv = document.getElementById('repoInfo');
    const repoInfoText = document.getElementById('repoInfoText');
    
    if (repoInfoDiv && repoInfoText) {
      const urlParams = getUrlParams();
      
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è¡¨ç¤º
      if (urlParams.owner || urlParams.repo || urlParams.filePath) {
        const parts = [];
#        if (urlParams.owner) parts.push(`æ‰€æœ‰è€…: ${urlParams.owner}`);
#        if (urlParams.repo) parts.push(`ãƒªãƒã‚¸ãƒˆãƒª: ${urlParams.repo}`);
        if (urlParams.filePath) parts.push(`ãƒ•ã‚¡ã‚¤ãƒ«: ${urlParams.filePath}`);
        
        repoInfoText.textContent = `[${parts.join(', ')}]`;
        repoInfoDiv.style.display = 'block';
      } else {
        repoInfoDiv.style.display = 'none';
      }
    }
  }

  // GitHubè¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆinitializeWithRemoteDataã®å‰ã«å®Ÿè¡Œï¼‰
  loadGitHubConfig();
  
  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§GitHubè¨­å®šã‚’æ›´æ–°
  updateGitHubConfigFromUrl();
  
  // ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã®è¡¨ç¤ºã‚’æ›´æ–°
  updateRepoInfoDisplay();
  
  // åˆæœŸåŒ–æ™‚ã«ãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  async function initializeWithRemoteData() {
    console.log('åˆæœŸåŒ–: ãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿é–‹å§‹');
    
    try {
      // GitHubã‹ã‚‰èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
      const remoteData = await loadFromGitHubWithoutToken();
      if (remoteData !== null && remoteData !== undefined) {
        events = remoteData;
        saveEvents();
        renderEvents();
        
        // ã‚¸ãƒ£ãƒ³ãƒ«ãŒæ›´æ–°ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ãƒ•ã‚£ãƒ«ã‚¿é¸æŠã‚’å…¨é¸æŠã«ãƒªã‚»ãƒƒãƒˆ
        if (window.selectedGenres) { selectedGenres = new Set(GENRES); }
        if (typeof updateGenreFilterButtonText === 'function') { updateGenreFilterButtonText(); }
        
        console.log('åˆæœŸåŒ–: GitHubã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ');
        return;
      } else {
        throw new Error('GitHubã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }
    } catch (e) {
      console.error('åˆæœŸåŒ–: GitHubã‹ã‚‰ã®èª­ã¿è¾¼ã¿å¤±æ•—:', e.message);
      showError('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', `GitHubã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`);
      return;
    }
  }
  
  // åˆæœŸåŒ–å®Ÿè¡Œ
  initializeWithRemoteData();
  
  // è‡ªå‹•ä¿å­˜ã®åŸºæº–ã‚’åˆæœŸåŒ–
  let lastSavedEventsData = JSON.stringify(events);

  // ===== ãƒ•ã‚£ãƒ«ã‚¿ =====
  let filterGenre = '';
  let filterImp   = '';
  let selectedGenres = new Set(); // é¸æŠã•ã‚ŒãŸã‚¸ãƒ£ãƒ³ãƒ«ã®ã‚»ãƒƒãƒˆ
  
  // æ™‚ä»£åŒºåˆ†ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
  function loadEraSettings() {
    const saved = localStorage.getItem('eraSettings');
    return saved ? JSON.parse(saved) : [];
  }
  
  // æ™‚ä»£åŒºåˆ†ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
  function saveEraSettings() {
    const newEraSettings = [];
    const nameInputs = document.querySelectorAll('[id^="eraName"]');
    
    nameInputs.forEach(nameInput => {
      const name = nameInput.value.trim();
      if (name) {
        const index = nameInput.id.replace('eraName', '');

        const enabled = document.getElementById(`eraEnabled${index}`)?.checked ?? true;
        const fillEnabled = document.getElementById(`eraFill${index}`)?.checked ?? true;
        const startYearStr = document.getElementById(`eraStart${index}`)?.value.trim();
        const endYearStr = document.getElementById(`eraEnd${index}`)?.value.trim();
        const endOngoing = document.getElementById(`eraEndOngoing${index}`)?.checked ?? false;
        const color = document.getElementById(`eraColor${index}`)?.value || '#4169E1';
        const opacity = document.getElementById(`eraOpacity${index}`)?.value || '0.3';
        
        const startYear = startYearStr ? parseInt(startYearStr, 10) : '';
        let endYear = endYearStr ? parseInt(endYearStr, 10) : '';
        if (endOngoing) {
          endYear = 'ongoing';
        }

        newEraSettings.push({
          name,
          startYear,
          endYear,
          color,
          opacity,
          enabled,
          fillEnabled
        });
      }
    });

    eraSettings = newEraSettings;
    
    try {
      const data = {
        events: events,
        eraSettings: eraSettings
      };
      localStorage.setItem('timelineEventsV2', JSON.stringify(data));
    } catch (e) {
      console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
    }
    
    closeModal();
    renderEraBackgrounds();
  }
  
  // åˆæœŸåŒ–ï¼ˆloadEventså†…ã§eraSettingsãŒè¨­å®šã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯åˆæœŸåŒ–ã—ãªã„ï¼‰
  
  // æ™‚ä»£åŒºåˆ†è¨­å®šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è¡¨ç¤º
  function showEraSettingsModal() {
    closeModal();
    const colorOptions = [
      { value: '#4169E1', label: 'é’' }, { value: '#32CD32', label: 'ç·‘' },
      { value: '#DC143C', label: 'èµ¤' }, { value: '#FF8C00', label: 'ã‚ªãƒ¬ãƒ³ã‚¸' },
      { value: '#8A2BE2', label: 'ç´«' }, { value: '#00CED1', label: 'æ°´è‰²' },
      { value: '#FFD700', label: 'é»„' }, { value: '#696969', label: 'ã‚°ãƒ¬ãƒ¼' }
    ];
    const opacityOptions = [
      { value: '0.1', label: '10%' }, { value: '0.2', label: '20%' },
      { value: '0.3', label: '30%' }, { value: '0.4', label: '40%' },
      { value: '0.5', label: '50%' }, { value: '0.6', label: '60%' },
      { value: '0.7', label: '70%' }, { value: '0.8', label: '80%' }
    ];

    const eraItems = eraSettings.map((era, index) => {
      const colorOptionsHtml = colorOptions.map(opt => `<option value="${opt.value}" ${era.color === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('');
      const opacityOptionsHtml = opacityOptions.map(opt => `<option value="${opt.value}" ${era.opacity === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('');
      
      return `
        <div style="border: 1px solid #ddd; border-radius: 6px; margin: 8px 0; padding: 12px; background: #fdfdfd;">
          <div style="display: flex; gap: 16px;">
            <!-- Left Column -->
            <div style="flex: 1;">
              <!-- 1st row: Name, Start, End -->
              <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                <div style="flex: 2;">
                  <label style="display: block; margin-bottom: 6px; font-weight: bold; font-size: 13px;">æ™‚ä»£åŒºåˆ†å:</label>
                  <input type="text" id="eraName${index}" value="${era.name}" style="width: 100%; padding: 6px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 6px; font-weight: bold; font-size: 13px;">é–‹å§‹å¹´:</label>
                  <input type="number" id="eraStart${index}" value="${era.startYear}" style="width: 100%; padding: 6px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 6px; font-weight: bold; font-size: 13px;">çµ‚äº†å¹´:</label>
                  <input type="number" id="eraEnd${index}" value="${era.endYear === 'ongoing' ? '' : era.endYear}" style="width: 100%; padding: 6px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;" ${era.endYear === 'ongoing' ? 'disabled' : ''}>
                  <div style="margin-top: 4px;">
                    <input type="checkbox" id="eraEndOngoing${index}" ${era.endYear === 'ongoing' ? 'checked' : ''} onchange="document.getElementById('eraEnd${index}').disabled = this.checked;">
                    <label for="eraEndOngoing${index}" style="font-size: 12px;">ongoing</label>
                  </div>
                </div>
              </div>
              <!-- 2nd row: Color, Opacity -->
              <div style="display: flex; gap: 12px;">
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 6px; font-weight: bold; font-size: 13px;">å¡—è‰²:</label>
                  <select id="eraColor${index}" style="width: 100%; padding: 6px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;">${colorOptionsHtml}</select>
                </div>
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 6px; font-weight: bold; font-size: 13px;">é€æ˜åº¦:</label>
                  <select id="eraOpacity${index}" style="width: 100%; padding: 6px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;">${opacityOptionsHtml}</select>
                </div>
              </div>
            </div>
            <!-- Right Column -->
            <div style="width: 100px; display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; border-left: 1px solid #eee; padding-left: 16px;">
              <div>
                <input type="checkbox" id="eraEnabled${index}" ${era.enabled ? 'checked' : ''} onchange="document.getElementById('eraFill${index}').disabled = !this.checked;" style="transform: scale(1.2);">
                <label for="eraEnabled${index}" style="font-size: 13px; margin-left: 4px;">è¡¨ç¤º</label>
              </div>
              <div style="margin-top: 8px;">
                <input type="checkbox" id="eraFill${index}" ${era.fillEnabled ?? true ? 'checked' : ''} ${!era.enabled ? 'disabled' : ''} style="transform: scale(1.2);">
                <label for="eraFill${index}" style="font-size: 13px; margin-left: 4px;">å¡—ã‚Š</label>
              </div>
              <div style="margin-top: auto;">
                <button onclick="deleteEraItem(${index})" style="padding: 6px 12px; font-size: 12px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;" title="ã“ã®æ™‚ä»£åŒºåˆ†ã‚’å‰Šé™¤">ğŸ—‘ï¸ å‰Šé™¤</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    const modalContent = `
      <div style="max-height: 400px; overflow-y: auto;">
        ${eraItems}
        ${eraSettings.length < 8 ? `
          <div style="border: 2px dashed #ccc; margin: 8px 0; padding: 12px; border-radius: 6px; text-align: center; cursor: pointer;" onclick="addEraItem()">
            + æ–°ã—ã„æ™‚ä»£åŒºåˆ†ã‚’è¿½åŠ 
          </div>
        ` : ''}
      </div>
      <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: center;">
        <button onclick="saveEraSettings()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜</button>
      </div>
    `;
    openModal('æ™‚ä»£åŒºåˆ†è¨­å®š', modalContent);
  }
  
  // æ–°ã—ã„æ™‚ä»£åŒºåˆ†é …ç›®ã‚’è¿½åŠ 
  function addEraItem() {
    const newItem = {
      name: '',
      startYear: '',
      endYear: '',
      color: '#4169E1',
      opacity: '0.3',
      enabled: true,
      fillEnabled: true,
    };
    eraSettings.unshift(newItem);
    showEraSettingsModal();
  }
  
  // æ™‚ä»£åŒºåˆ†é …ç›®ã‚’å‰Šé™¤
  function deleteEraItem(index) {
    if (confirm('ã“ã®æ™‚ä»£åŒºåˆ†ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      eraSettings.splice(index, 1);
      saveEvents();
      renderEraBackgrounds();
      showEraSettingsModal();
    }
  }
  
  // æ™‚ä»£åŒºåˆ†è¨­å®šã‚’ä¿å­˜
  function saveEraSettings() {
    const newEraSettings = [];
    const nameInputs = document.querySelectorAll('[id^="eraName"]');
    
    nameInputs.forEach(nameInput => {
      const name = nameInput.value.trim();
      if (name) {
        const index = nameInput.id.replace('eraName', '');
        const enabled = document.getElementById(`eraEnabled${index}`)?.checked ?? true;
        const fillEnabled = document.getElementById(`eraFill${index}`)?.checked ?? true;
        const startYearStr = document.getElementById(`eraStart${index}`)?.value.trim();
        const endYearStr = document.getElementById(`eraEnd${index}`)?.value.trim();
        const endOngoing = document.getElementById(`eraEndOngoing${index}`)?.checked ?? false;
        const color = document.getElementById(`eraColor${index}`)?.value || '#4169E1';
        const opacity = document.getElementById(`eraOpacity${index}`)?.value || '0.3';
        
        const startYear = startYearStr ? parseInt(startYearStr, 10) : '';
        let endYear = endYearStr ? parseInt(endYearStr, 10) : '';
        if (endOngoing) endYear = 'ongoing';

        newEraSettings.push({ name, startYear, endYear, color, opacity, enabled, fillEnabled });
      }
    });

    eraSettings = newEraSettings;
    
    try {
      const data = {
        events: events,
        eraSettings: eraSettings
      };
      localStorage.setItem('timelineEventsV2', JSON.stringify(data));
    } catch (e) {
      console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
    }
    
    closeModal();
    renderEraBackgrounds();
  }
  
  // æ™‚ä»£åŒºåˆ†ã®èƒŒæ™¯è‰²ã‚’æç”»
  function renderEraBackgrounds() {
    try {
      if (!stage || !gridG) return;
      
      document.querySelectorAll('.era-background, .era-text, .era-text-bg').forEach(el => el.remove());
      
      const enabledEras = (eraSettings || []).filter(era => era && era.enabled);
      
      enabledEras.forEach(era => {
        const startYear = era.startYear;
        const endYear = (era.endYear === 'ongoing') ? new Date().getFullYear() : era.endYear;
        if (!startYear || !endYear) return;

        const startY = yFromBirthYear(startYear);
        const endY = yFromBirthYear(endYear + 1);
        const height = endY - startY;
        
        if (height > 0) {
          if (era.fillEnabled ?? true) {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('class', 'era-background');
            rect.setAttribute('x', ORIGIN_X);
            rect.setAttribute('y', startY);
            rect.setAttribute('width', width - ORIGIN_X);
            rect.setAttribute('height', height);
            rect.setAttribute('fill', era.color);
            rect.setAttribute('opacity', era.opacity);
            gridG.insertBefore(rect, gridG.firstChild);
          }

          const eraText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          eraText.setAttribute('class', 'era-text');
          eraText.textContent = `${era.name} (${era.startYear}-${era.endYear})`;
          eraText.setAttribute('x', ORIGIN_X + 10);
          eraText.setAttribute('y', startY + 20);
          eraText.setAttribute('style', 'font-size: 14px; fill: #333; cursor: pointer; user-select: none;');
          
          const textBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          textBg.setAttribute('class', 'era-text-bg');
          
          gridG.appendChild(eraText);
          const bbox = eraText.getBBox();
          
          textBg.setAttribute('x', bbox.x - 4);
          textBg.setAttribute('y', bbox.y - 2);
          textBg.setAttribute('width', bbox.width + 8);
          textBg.setAttribute('height', bbox.height + 4);
          textBg.setAttribute('fill', 'rgba(255,255,255,0.01)');
          textBg.setAttribute('style', 'cursor: pointer;');
          
          const toggleFill = () => {
            const originalIndex = eraSettings.findIndex(e => e.name === era.name && e.startYear === era.startYear && e.endYear === era.endYear);
            if (originalIndex > -1) {
              eraSettings[originalIndex].fillEnabled = !(eraSettings[originalIndex].fillEnabled ?? true);
              saveEvents(); 
              renderEraBackgrounds();
            }
          };
          
          eraText.addEventListener('click', toggleFill);
          textBg.addEventListener('click', toggleFill);
          
          gridG.insertBefore(textBg, eraText);
        }
      });
    } catch (error) {
      console.error('æ™‚ä»£åŒºåˆ†ã®æç”»ã‚¨ãƒ©ãƒ¼:', error);
    }
  }
  
  // åˆæœŸåŒ–æ™‚ã«æ™‚ä»£åŒºåˆ†èƒŒæ™¯ã‚’æç”»ï¼ˆå¾Œã§å®Ÿè¡Œï¼‰
  setTimeout(renderEraBackgrounds, 0);
  
  function passesFilter(it){ 
    // å‰Šé™¤ãƒ•ãƒ©ã‚°ãŒã‚ªãƒ³ã®é …ç›®ã¯é™¤å¤–
    if (it.deleted === true) {
      return false;
    }
    
    // ã‚¸ãƒ£ãƒ³ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆè¤‡æ•°é¸æŠå¯¾å¿œï¼‰
    if (selectedGenres.size === 0) {
      // æœªé¸æŠãªã‚‰ä½•ã‚‚è¡¨ç¤ºã—ãªã„
      return false;
    }
    if (!itemHasSelectedGenre(it)) return false;
    // é‡è¦åº¦ãƒ•ã‚£ãƒ«ã‚¿
    if(filterImp){ 
      const thr = parseInt(filterImp,10); 
      const imp = parseInt(it.imp,10); 
      if(isNaN(imp) || imp<thr) return false; 
    } 
    return true; 
  }

  // ===== ã‚°ãƒªãƒƒãƒ‰ =====
  function yFromBirthYear(by){return ORIGIN_Y+(by-YEAR_MIN)*PX_PER_YEAR;}
  function xFromAge(age){return ORIGIN_X+age*PX_PER_AGE;}
  function drawGrid(){
    for(let a=0;a<=AGE_MAX;a+=10){ const x=xFromAge(a); gridG.appendChild(lineEl(x,ORIGIN_Y-10,x,height-20,'gridMajor')); }
    for(let y=YEAR_MIN;y<=YEAR_MAX;y++){ const ypx=yFromBirthYear(y); gridG.appendChild(lineEl(ORIGIN_X,ypx,width-20,ypx,(y%10===0?'gridMajor':'gridMinor'))); if(y%10===0){ const decade=String(y).slice(2,3)+"0s"; const tt=textEl(decade, 36, ypx+18, 'axisLabel'); tt.setAttribute('text-anchor','middle'); decadesG.appendChild(tt); } }
    for(let b=YEAR_MIN; b<=YEAR_MAX; b+=5){ const x0=ORIGIN_X, y0=yFromBirthYear(b); const x1=xFromAge(Math.min(AGE_MAX,YEAR_MAX-b)); const y1=yFromBirthYear(Math.min(YEAR_MAX,b+AGE_MAX)); gridG.appendChild(lineEl(x0,y0,x1,y1,'gridMinor')); }
  }
  
  // å›ºå®šä½ç½®ã®å¹´é½¢è»¸ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆ
  function createFixedAgeLabels() {
    const fixedAgeContainer = document.createElement('div');
    fixedAgeContainer.id = 'fixed-age-labels';
    fixedAgeContainer.style.cssText = `
      position: fixed;
      top: 58px;
      left: 0;
      right: 0;
      height: 20px;
      pointer-events: none;
      z-index: 100;
    `;
    
    for(let a=0;a<=AGE_MAX;a+=10){
      const x = xFromAge(a);
      const label = document.createElement('div');
      label.textContent = a;
      label.style.cssText = `
        position: absolute;
        left: ${x}px;
        top: 0;
        font-size: 18px;
        font-weight: 700;
        color: #4a4a4a;
        transform: translateX(-50%);
        pointer-events: none;
      `;
      fixedAgeContainer.appendChild(label);
    }
    
    document.body.appendChild(fixedAgeContainer);
  }
  
  // å¹´é½¢ç›®ç››ã‚Šæ•°å­—ã®èƒŒæ™¯ã«ç™½ã„å¸¯ã‚’ä½œæˆ
  function createAgeBand() {
    const bandContainer = document.createElement('div');
    bandContainer.id = 'age-band';
    bandContainer.style.cssText = `
      position: fixed;
      top: 54px;
      left: 0;
      right: 0;
      height: 24px;
      pointer-events: none;
      z-index: 3;
    `;
    
    // å¹´é½¢ç›®ç››ã‚Šã‚¨ãƒªã‚¢å…¨ä½“ï¼ˆ0ã‹ã‚‰æœ€å¤§å¹´é½¢ã¾ã§ï¼‰ã«ç™½ã„å¸¯ã‚’ä½œæˆ
    const ageBand = document.createElement('div');
    ageBand.style.cssText = `
      position: absolute;
      left: ${ORIGIN_X}px;
      top: 0;
      width: ${xFromAge(AGE_MAX) - ORIGIN_X}px;
      height: 20px;
      background: white;
      pointer-events: none;
    `;
    bandContainer.appendChild(ageBand);
    
    document.body.appendChild(bandContainer);
  }
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’å–å¾—ã—ã¦å¹´é½¢è¡¨ç¤ºã®ä½ç½®ã‚’èª¿æ•´ã™ã‚‹é–¢æ•°
  function updateAgeDisplayPosition() {
    const header = document.querySelector('header');
    const ageLabels = document.getElementById('fixed-age-labels');
    const ageBand = document.getElementById('age-band');
    const ageTextBlue = document.getElementById('age-text-blue');
    const ageTextRed = document.getElementById('age-text-red');
    
    if (header && ageLabels && ageBand) {
      const headerHeight = header.offsetHeight;
      const newTop = headerHeight + 4; // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸‹ã«4pxã®ä½™ç™½
      
      // å¹´é½¢ãƒ©ãƒ™ãƒ«ã®ä½ç½®ã‚’æ›´æ–°
      ageLabels.style.top = `${newTop}px`;
      
      // å¹´é½¢ãƒãƒ³ãƒ‰ã®ä½ç½®ã‚’æ›´æ–°
      ageBand.style.top = `${newTop - 4}px`;
      
      // ãƒ—ãƒ­ãƒ¼ãƒ–ã®å¹´é½¢è¡¨ç¤ºã®ä½ç½®ã‚’æ›´æ–°
      if (ageTextBlue) {
        ageTextBlue.style.top = `${newTop + 20}px`;
      }
      if (ageTextRed) {
        ageTextRed.style.top = `${newTop + 20}px`;
      }
    }
  }
  
  try {
  drawGrid();
    createFixedAgeLabels();
    createAgeBand();
    updateAgeDisplayPosition(); // å¹´é½¢è¡¨ç¤ºã®ä½ç½®ã‚’èª¿æ•´
    updateGenreFilterButtonText();
  } catch (error) {
    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
  }

  const tooltip=document.getElementById('tooltip');
  function positionTooltip(e){const r=vp.getBoundingClientRect();tooltip.style.left=(e.clientX-r.left+14)+'px';tooltip.style.top=(e.clientY-r.top+14)+'px';}

  // ===== è©³ç´°ä¸€è¦§è¡¨ç¤º =====
  function showDetailList(year, anchor) {
    clearHighlight();
    const items = (events[year] || []).filter(passesFilter);

    editor.innerHTML = `
      <h4 style="display: flex; align-items: center; justify-content: space-between; margin: 0 0 12px 0; font-size: 16px;">
        <span style="display: flex; align-items: center; gap: 8px;">
          <span style="cursor: pointer; font-size: 18px;" onclick="openYearWikipedia(${year})" title="${year}å¹´ã®Wikipediaãƒšãƒ¼ã‚¸ã‚’é–‹ã">ğŸŒ</span>
          <span>${year}å¹´</span>
        </span>
        <span style="font-size: 11px; color: #666; font-weight: normal;">ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸€è¦§ã®é †åºã‚’å¤‰æ›´ã§ãã¾ã™</span>
      </h4>
      <div style="max-height: 400px; overflow-y: auto; width: 500px;" id="detailListContainer">
        ${items.length > 0 ? items.map((item, index) => {
          // å…ƒã®é…åˆ—ã§ã®å®Ÿéš›ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
          const allItems = events[year] || [];
          const actualIndex = allItems.findIndex(originalItem => 
            originalItem.label === item.label && originalItem.genre === item.genre
          );
          return `
          <div class="detail-item" data-year="${year}" data-index="${actualIndex}" style="border: 1px solid #ddd; margin: 8px 0; padding: 12px; border-radius: 6px; background: #f9f9f9; cursor: move; user-select: none;" draggable="true">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <div style="font-weight: bold; margin-bottom: 4px;">${item.label}</div>
                <div style="font-size: 12px; color: #666;">
                  ${item.genre ? `ã‚¸ãƒ£ãƒ³ãƒ«: ${Array.isArray(item.genre) ? item.genre.join('ãƒ»') : item.genre}` : ''}
                  ${item.imp ? ` | é‡è¦åº¦: ${item.imp}` : ''}
                  ${item.note ? ` | æ³¨é‡ˆ: ${item.note}` : ''}
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="addEraFromItem(${year}, ${actualIndex})" style="padding: 4px 8px; font-size: 12px;" title="ã“ã®é …ç›®ã‹ã‚‰æ™‚ä»£åŒºåˆ†ã‚’ç™»éŒ²">ğŸ“…</button>
                <button onclick="openUrl('${item.url || ''}')" style="padding: 4px 8px; font-size: 12px;" ${!item.url ? 'disabled' : ''}>ğŸŒ</button>
                <button onclick="editItem(${year}, ${actualIndex})" style="padding: 4px 8px; font-size: 12px;">âœï¸</button>
                <button onclick="deleteItem(${year}, ${actualIndex})" style="padding: 4px 8px; font-size: 12px; color: #d32f2f;">ğŸ—‘ï¸</button>
              </div>
            </div>
          </div>
        `;
        }).join('') : '<div style="text-align: center; color: #666; padding: 20px;">é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
      </div>
      <div class="row">
        <div class="left"></div>
        <div class="right">
          <button id="addBtn">è¿½åŠ </button>
          <button id="closeBtn">é–‰ã˜ã‚‹</button>
        </div>
      </div>`;
    
    const r = anchor ? anchor.getBoundingClientRect() : {right: 100, top: 100};
    const rv = vp.getBoundingClientRect();
    let left = r.right - rv.left + 8;
    let top = r.top - rv.top;
    const maxLeft = rv.width - 520;
    if(left > maxLeft) left = Math.max(12, r.left - rv.left - 520);
    
    editor.style.left = left + 'px';
    editor.style.top = top + 'px';
    editor.style.display = 'block';

    function close() { 
      saveEvents();
      renderEvents();
      autoSave();
      editor.style.display = 'none'; 
    }
    editor.querySelector('#addBtn').onclick = () => { addNewItem(year); };
    editor.querySelector('#closeBtn').onclick = close;
    
    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    setupDragAndDrop(year);
  }

  // ===== ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ =====
  function setupDragAndDrop(year) {
    const container = document.getElementById('detailListContainer');
    if (!container) return;
    
    let draggedElement = null;
    let draggedIndex = null;
    
    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
    container.addEventListener('dragstart', (e) => {
      if (e.target.classList.contains('detail-item')) {
        draggedElement = e.target;
        draggedIndex = parseInt(e.target.dataset.index);
        e.target.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.target.outerHTML);
      }
    });
    
    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
    container.addEventListener('dragend', (e) => {
      if (e.target.classList.contains('detail-item')) {
        e.target.style.opacity = '';
        draggedElement = null;
        draggedIndex = null;
      }
    });
    
    // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
    container.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      const afterElement = getDragAfterElement(container, e.clientY);
      if (afterElement == null) {
        container.appendChild(draggedElement);
      } else {
        container.insertBefore(draggedElement, afterElement);
      }
    });
    
    // ãƒ‰ãƒ­ãƒƒãƒ—
    container.addEventListener('drop', (e) => {
      e.preventDefault();
      
      if (draggedElement && draggedIndex !== null) {
        const newIndex = Array.from(container.children).indexOf(draggedElement);
        
        if (newIndex !== draggedIndex) {
          // é …ç›®ã®é †åºã‚’å¤‰æ›´
          const items = events[year] || [];
          const item = items.splice(draggedIndex, 1)[0];
          items.splice(newIndex, 0, item);
          
          // é †ç•ªå¤‰æ›´ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
          setOrderChanged(true);
          
          // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ç”»é¢ã‚’æ›´æ–°
          saveEvents();
          renderEvents();
          showDetailList(year, null);
        }
      }
    });
  }
  
  // ãƒ‰ãƒ©ãƒƒã‚°å¾Œã®è¦ç´ ä½ç½®ã‚’å–å¾—
  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.detail-item:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // ===== è©³ç´°ä¸€è¦§ã®æ“ä½œé–¢æ•° =====
  function moveItem(year, index, direction) {
    const items = events[year] || [];
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= items.length) return;
    
    // é …ç›®ã‚’ç§»å‹•
    const item = items.splice(index, 1)[0];
    items.splice(newIndex, 0, item);
    
    // é †ç•ªå¤‰æ›´ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    setOrderChanged(true);
    
    saveEvents();
    renderEvents();
    showDetailList(year, null);
  }

  function openUrl(url) {
    if (url && url.startsWith('http')) {
      window.open(url, '_blank');
    }
  }
  
  function openYearWikipedia(year) {
    // Wikipediaã®å¹´ãƒšãƒ¼ã‚¸ã®URLå½¢å¼ï¼ˆã€Œå¹´ã€ãªã—ï¼‰
    const wikipediaUrl = `https://ja.wikipedia.org/wiki/${year}å¹´`;
    console.log('Wikipedia URL:', wikipediaUrl); // ãƒ‡ãƒãƒƒã‚°ç”¨
    window.open(wikipediaUrl, '_blank');
  }

  function editItem(year, index) {
    const items = events[year] || [];
    const item = items[index];
    if (!item) return;
    
    // ç·¨é›†å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦ä¿å­˜
    setLabelBackup(year, item.label, item.genre, { ...item });
    
    showEditModal(year, index, item);
  }

  function deleteItem(year, index) {
    const items = events[year] || [];
    const item = items[index];
    if (!item) return;
    
    if (confirm(`ã€Œ${item.label}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã«å‰Šé™¤å‰ã®å†…å®¹ã‚’è¨˜éŒ²
      addDeletionRecord(year, item);
      // ç‰©ç†å‰Šé™¤
      items.splice(index, 1);
      if (items.length === 0) delete events[year];
      console.log('é …ç›®ã‚’ç‰©ç†å‰Šé™¤:', { year, index, label: item.label });
      saveEvents();
      renderEvents();
      showDetailList(year, null);
    }
  }

  function addNewItem(year) {
    showEditModal(year, -1, { label: '', startYear: year, endYear: '' });
  }

  // å€‹åˆ¥ç·¨é›†ç”¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
  function showEditModal(year, index, item) {
    clearHighlight();
    
    editor.innerHTML = `
      <h4><span>é …ç›®ã®ç·¨é›†</span></h4>
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">é–‹å§‹å¹´:</label>
        <input type="number" id="editStartYear" value="${item.startYear || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="ä¾‹: 1952" min="${YEAR_MIN}" max="${YEAR_MAX}">
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">çµ‚äº†å¹´:</label>
        <div style="display: flex; gap: 8px; align-items: center;">
          <input type="number" id="editEndYear" value="${item.endYear === 'ongoing' ? '' : (item.endYear || '')}" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="ä¾‹: 1968" min="${YEAR_MIN}" max="${YEAR_MAX}">
          <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
            <input type="checkbox" id="editEndYearOngoing" ${item.endYear === 'ongoing' ? 'checked' : ''} style="margin: 0;">
            ç¶™ç¶šä¸­ (ongoing)
          </label>
        </div>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">ãƒ©ãƒ™ãƒ«:</label>
        <input type="text" id="editLabel" value="${item.label || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">ã‚¸ãƒ£ãƒ³ãƒ«:</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; border: 1px solid #ddd; border-radius: 4px; padding: 8px;">
          ${GENRES.map(code => `
          <label style=\"display: flex; align-items: center; gap: 4px; font-size: 13px;\">
            <input type=\"checkbox\" value=\"${code}\" ${Array.isArray(item.genre) ? (item.genre.includes(code) ? 'checked' : '') : (item.genre === code ? 'checked' : '')}>
            ${GENRE_LABELS[code] || code}
          </label>`).join('')}
        </div>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">é‡è¦åº¦:</label>
        <select id="editImp" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="5" ${item.imp === 5 ? 'selected' : ''}>5 - æ™‚ä»£ã‚’ä»£è¡¨ã™ã‚‹é‡è¦ã‚¤ãƒ™ãƒ³ãƒˆ</option>
          <option value="4" ${item.imp === 4 ? 'selected' : ''}>4 - å¤§ããªå½±éŸ¿ã‚’ä¸ãˆãŸã‚¤ãƒ™ãƒ³ãƒˆ</option>
          <option value="3" ${item.imp === 3 ? 'selected' : ''}>3 - ä¸€èˆ¬çš„ã«çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ</option>
          <option value="2" ${item.imp === 2 ? 'selected' : ''}>2 - ç‰¹å®šåˆ†é‡ã§é‡è¦ãªã‚¤ãƒ™ãƒ³ãƒˆ</option>
          <option value="1" ${item.imp === 1 ? 'selected' : ''}>1 - å‚è€ƒç¨‹åº¦ã®ã‚¤ãƒ™ãƒ³ãƒˆ</option>
        </select>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">URL:</label>
        <input type="url" id="editUrl" value="${item.url || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="https://example.com">
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">æ³¨é‡ˆ:</label>
        <textarea id="editNote" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 80px;" placeholder="è£œè¶³èª¬æ˜ã‚„ãƒ¡ãƒ¢">${item.note || ''}</textarea>
      </div>
      
      <div class="row">
        <div class="left"></div>
        <div class="right">
          <button id="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="save">ä¿å­˜</button>
        </div>
      </div>`;
    
    const rv = vp.getBoundingClientRect();
    editor.style.left = (rv.width / 2 - 250) + 'px';
    editor.style.top = (rv.height / 2 - 200) + 'px';
    editor.style.display = 'block';
    editor.style.zIndex = '1000';

    function close() { editor.style.display = 'none'; }
    editor.querySelector('#cancel').onclick = close;
    editor.querySelector('#save').onclick = () => { saveEditItem(year, index); };
    // å…¥åŠ›ä¸­ã®é•·ã•åˆ¶é™ï¼ˆURL + æ³¨é‡ˆ åˆè¨ˆæœ€å¤§512æ–‡å­—ï¼‰
    const urlEl = document.getElementById('editUrl');
    const noteEl = document.getElementById('editNote');
    const limit = 512;
    function enforceLimit(e){
      const urlVal = urlEl.value || '';
      const noteVal = noteEl.value || '';
      const total = urlVal.length + noteVal.length;
      if(total > limit){
        // è¶…éåˆ†ã‚’ã‚«ãƒƒãƒˆ
        if(e && e.target === noteEl){
          noteEl.value = noteVal.slice(0, Math.max(0, limit - urlVal.length));
        } else if(e && e.target === urlEl){
          urlEl.value = urlVal.slice(0, Math.max(0, limit - noteVal.length));
        }
        showError('å…¥åŠ›åˆ¶é™', `URLã¨æ³¨é‡ˆã®åˆè¨ˆã¯æœ€å¤§ ${limit} æ–‡å­—ã¾ã§ã§ã™ã€‚`);
      }
    }
    urlEl.addEventListener('input', enforceLimit);
    noteEl.addEventListener('input', enforceLimit);
  }

  function saveEditItem(year, index) {
    const startYear = document.getElementById('editStartYear').value.trim();
    const endYearInput = document.getElementById('editEndYear').value.trim();
    const endYearOngoing = document.getElementById('editEndYearOngoing').checked;
    const endYear = endYearOngoing ? 'ongoing' : endYearInput;
    const label = document.getElementById('editLabel').value.trim();
    const genreCheckboxes = document.querySelectorAll('input[type="checkbox"][value]');
    const genres = Array.from(genreCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
    const imp = document.getElementById('editImp').value.trim();
    const url = document.getElementById('editUrl').value.trim();
    const note = document.getElementById('editNote').value.trim();
    const totalLen = (url || '').length + (note || '').length;
    if(totalLen > 512){
      showError('ç·¨é›†ã‚¨ãƒ©ãƒ¼', `URLã¨æ³¨é‡ˆã®åˆè¨ˆã¯æœ€å¤§ 512 æ–‡å­—ã¾ã§ã§ã™ã€‚ç¾åœ¨: ${totalLen} æ–‡å­—`);
      return;
    }
    
    // å¹´ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼ˆ1945ï½2059ï¼‰
    const RANGE_MIN = 1945;
    const RANGE_MAX = 2059;
    const isYearInRange = (v) => v === '' || (String(v).toLowerCase()==='ongoing') || (/^\d{4}$/.test(v) && parseInt(v,10)>=RANGE_MIN && parseInt(v,10)<=RANGE_MAX);
    if (!isYearInRange(startYear)) {
      showError('ç·¨é›†ã‚¨ãƒ©ãƒ¼', `é–‹å§‹å¹´ã¯${RANGE_MIN}ï½${RANGE_MAX}ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
      const se = document.getElementById('editStartYear');
      if (se) se.value = '';
      return;
    }
    if (!isYearInRange(endYear)) {
      showError('ç·¨é›†ã‚¨ãƒ©ãƒ¼', `çµ‚äº†å¹´ã¯${RANGE_MIN}ï½${RANGE_MAX}ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆã¾ãŸã¯ã€Œongoingã€ï¼‰ã€‚`);
      const ee = document.getElementById('editEndYear');
      if (ee) ee.value = '';
      return;
    }

    if (!label) {
      showError('ç·¨é›†ã‚¨ãƒ©ãƒ¼', 'ãƒ©ãƒ™ãƒ«ã¯å¿…é ˆã§ã™ã€‚');
      return;
    }
    
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ©ãƒ™ãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«çµ„ã¿åˆã‚ã›ï¼‰
    const genreKey = genres.length > 0 ? genres.sort().join('ãƒ»') : '';
    const key = `${label}|${genreKey}`;
    const existingItems = buildLabelGenreSet();
    
    // ç·¨é›†ã®å ´åˆï¼ˆindex !== -1ï¼‰ã¯ã€è‡ªåˆ†è‡ªèº«ã¨ã®é‡è¤‡ã¯é™¤å¤–
    if (index !== -1) {
      const currentItem = events[year][index];
      const currentGenreKey = Array.isArray(currentItem.genre) ? currentItem.genre.sort().join('ãƒ»') : (currentItem.genre || '');
      const currentKey = `${currentItem.label}|${currentGenreKey}`;
      if (key === currentKey) {
        // åŒã˜ãƒ©ãƒ™ãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«çµ„ã¿åˆã‚ã›ãªã®ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—
      } else if (existingItems.has(key)) {
        showError('é‡è¤‡ã‚¨ãƒ©ãƒ¼', `åŒã˜ãƒ©ãƒ™ãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«çµ„ã¿åˆã‚ã›ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ï¼ˆ${label}${genreKey ? ` [${genreKey}]` : ''}ï¼‰`);
        return;
      }
    } else {
      // æ–°è¦è¿½åŠ ã®å ´åˆ
      if (existingItems.has(key)) {
        showError('é‡è¤‡ã‚¨ãƒ©ãƒ¼', `åŒã˜ãƒ©ãƒ™ãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«çµ„ã¿åˆã‚ã›ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ï¼ˆ${label}${genreKey ? ` [${genreKey}]` : ''}ï¼‰`);
        return;
      }
    }
    
    const newItem = { label };
    if (startYear) newItem.startYear = parseInt(startYear, 10);
    if (endYear) {
      if (endYear === 'ongoing') {
        newItem.endYear = 'ongoing';
      } else {
        newItem.endYear = parseInt(endYear, 10);
      }
    }
    if (genres.length > 0) newItem.genre = genres;
    if (imp) newItem.imp = parseInt(imp, 10);
    if (url) newItem.url = url;
    if (note) newItem.note = note;
    
    if (index === -1) {
      // æ–°ã—ã„é …ç›®ã‚’è¿½åŠ 
      const targetYear = startYear ? parseInt(startYear, 10) : year;
      if (!events[targetYear]) {
        events[targetYear] = [];
      }
      events[targetYear].push(newItem);
      // æ–°è¦è¿½åŠ ã®å ´åˆã¯ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
      setEditFlag(targetYear, newItem.label, genreKey);
    } else {
      // æ—¢å­˜ã®é …ç›®ã‚’æ›´æ–°
      const currentItem = events[year][index];
      const originalStartYear = currentItem.startYear || year;
      const newStartYear = startYear ? parseInt(startYear, 10) : year;
      const originalLabel = currentItem.label || '';
      const originalGenreKey = Array.isArray(currentItem.genre) ? currentItem.genre.slice().sort().join('ãƒ»') : (currentItem.genre || '');
      const changedLabel = originalLabel !== label;
      const changedGenre = originalGenreKey !== genreKey;
      
      // é–‹å§‹å¹´ãƒ»ãƒ©ãƒ™ãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ã®ã„ãšã‚Œã‹ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯ã€å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ç‰©ç†å‰Šé™¤ã—ã€æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 
      if (originalStartYear !== newStartYear || changedLabel || changedGenre) {
        // æ—§é …ç›®ã‚’å‰Šé™¤è¨˜éŒ²ã«è¿½åŠ ã—ã¦ç‰©ç†å‰Šé™¤
        addDeletionRecord(year, currentItem);
        // æŒ‡å®šã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é …ç›®ã‚’å‰Šé™¤
        if (Array.isArray(events[year])) {
          events[year].splice(index, 1);
          // åŒä¸€ãƒ©ãƒ™ãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ã®æ®‹å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Œã°å…¨ã¦é™¤å»ï¼ˆé‡è¤‡å¯¾ç­–ï¼‰
          const sameMatcher = (it) => {
            const gA = Array.isArray(it.genre) ? it.genre.slice().sort().join('ãƒ»') : (it.genre || '');
            return (it.label||'') === originalLabel && gA === originalGenreKey;
          };
          events[year] = events[year].filter(it => !sameMatcher(it));
          if (events[year].length === 0) delete events[year];
        }
        console.log('è­˜åˆ¥å­å¤‰æ›´ã«ä¼´ã„æ—§é …ç›®ã‚’ç‰©ç†å‰Šé™¤:', { year, index, originalLabel, originalGenreKey, originalStartYear });

        // æ–°ã—ã„å¹´ã«é …ç›®ã‚’è¿½åŠ 
        const targetYearForNew = newStartYear;
        if (!events[targetYearForNew]) {
          events[targetYearForNew] = [];
        }
        events[targetYearForNew].push(newItem);
        
        // ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆæ–°ã—ã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ï¼‰
        setEditFlag(targetYearForNew, newItem.label, genreKey);
      } else {
        // è­˜åˆ¥å­ã«å¤‰æ›´ãŒãªã‘ã‚Œã°é€šå¸¸ã®ä¸Šæ›¸ãæ›´æ–°
        events[year][index] = newItem;
        setEditFlag(year, newItem.label, genreKey);
      }
    }
    
    saveEvents();
    renderEvents();
    autoSave();
    
    // ç·¨é›†ç”»é¢ã‚’è‡ªå‹•ã§é–‰ã˜ã‚‹
    editor.style.display = 'none';
  }

  // å€‹åˆ¥ã®é …ç›®ã‹ã‚‰æ™‚ä»£åŒºåˆ†ã‚’ç™»éŒ²ã™ã‚‹æ©Ÿèƒ½
  function addEraFromItem(year, index) {
    const items = events[year] || [];
    const item = items[index];
    if (!item) {
      showError('ã‚¨ãƒ©ãƒ¼', 'é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }
    
    const startYear = item.startYear || year;
    // é …ç›®ã®çµ‚äº†å¹´ãŒã€Œongoingã€ã®å ´åˆã¯æ™‚ä»£åŒºåˆ†ã‚‚ã€Œongoingã€ã«è¨­å®š
    const endYear = item.endYear === 'ongoing' ? 'ongoing' : (item.endYear || year);
    const eraName = item.label + (item.genre ? ` [${Array.isArray(item.genre) ? item.genre.join('ãƒ»') : item.genre}]` : '');
    
    console.log('addEraFromItem: é …ç›®æƒ…å ±', {
      itemLabel: item.label,
      itemStartYear: item.startYear,
      itemEndYear: item.endYear,
      eraStartYear: startYear,
      eraEndYear: endYear
    });
    
    // æ—¢å­˜ã®æ™‚ä»£åŒºåˆ†ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const existingEraIndex = eraSettings.findIndex(era => 
      era.name === eraName && 
      era.startYear === startYear && 
      era.endYear === endYear
    );
    
    if (existingEraIndex !== -1) {
      // æ—¢å­˜ã®æ™‚ä»£åŒºåˆ†ã‚’å‰Šé™¤
      eraSettings.splice(existingEraIndex, 1);
      saveEvents();
      renderEraBackgrounds();
      return;
    }
    
    // åˆ©ç”¨å¯èƒ½ãªè‰²ã®ãƒªã‚¹ãƒˆ
    const availableColors = [
      '#4169E1', '#32CD32', '#DC143C', '#FF8C00', 
      '#8A2BE2', '#00CED1', '#FFD700', '#696969',
      '#FF69B4', '#00FF7F', '#FF4500', '#9370DB',
      '#20B2AA', '#FFA500', '#FF1493', '#32CD32'
    ];
    
    // æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹è‰²ã‚’å–å¾—
    const usedColors = eraSettings.map(era => era.color);
    
    // æœªä½¿ç”¨ã®è‰²ã‚’é¸æŠ
    let selectedColor = availableColors.find(color => !usedColors.includes(color));
    if (!selectedColor) {
      // å…¨ã¦ã®è‰²ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æœ€åˆã®è‰²ã‚’ä½¿ç”¨
      selectedColor = availableColors[0];
    }
    
    const newEra = {
      name: eraName,
      startYear: startYear,
      endYear: endYear,
      color: selectedColor,
      opacity: '0.3',
      enabled: true
    };
    
    console.log('addEraFromItem: ä½œæˆã™ã‚‹æ™‚ä»£åŒºåˆ†', newEra);
    
    // æ–°ã—ã„æ™‚ä»£åŒºåˆ†ã‚’å…ˆé ­ã«è¿½åŠ ï¼ˆå¸¸ã«æ–°ã—ã„ã‚‚ã®ã‹ã‚‰ä¸¦ã¶ã‚ˆã†ã«ï¼‰
    eraSettings.unshift(newEra);
    
    // ä¿å­˜
    saveEvents();
    renderEraBackgrounds();
    
    showInfo('æ™‚ä»£åŒºåˆ†ç™»éŒ²å®Œäº†', `ã€Œ${item.label}ã€ã®æ™‚ä»£åŒºåˆ†ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
  window.moveItem = moveItem;
  window.openUrl = openUrl;
  window.openYearWikipedia = openYearWikipedia;
  window.editItem = editItem;
  window.deleteItem = deleteItem;
  window.addNewItem = addNewItem;
  window.saveEditItem = saveEditItem;
  window.addEraFromItem = addEraFromItem;
  window.deleteEraItem = deleteEraItem;

  // ===== ç·¨é›†UIï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ =====
  function serializeLine(it){ const startYear=(it.startYear||'').trim(); const endYear=(it.endYear||'').trim(); const label=(it.label||'').trim(); const g = Array.isArray(it.genre) ? it.genre.join('ãƒ»') : (it.genre||'').trim(); const imp=(it.imp===undefined||it.imp===null||String(it.imp)==='')? '' : String(it.imp); const url=(it.url||'').trim(); const note=(it.note||'').trim(); if(!startYear && !endYear && !g && !imp && !url && !note) return label; return [startYear,endYear,label,g,imp,url,note].join(';'); }
  function parseLine(line){ const raw=line.trim(); if(!raw) return null; const parts=raw.split(';'); const startYear=(parts[0]||'').trim(); const endYear=(parts[1]||'').trim(); const label=(parts[2]||'').trim(); if(!label) return null; const genreStr=(parts[3]||'').trim(); let imp=(parts[4]||'').trim(); imp = imp? String(Math.min(5, Math.max(1, parseInt(imp,10)))): ''; const url=(parts[5]||'').trim(); const note=(parts[6]||'').trim(); const o={label}; if(startYear) o.startYear=startYear; if(endYear) { if(endYear.toLowerCase() === 'ongoing') { o.endYear = 'ongoing'; } else { o.endYear = endYear; } } if(genreStr) { const genres = genreStr.split('ãƒ»').map(g => g.trim().toUpperCase()); o.genre = genres.length > 0 ? genres : [genreStr.toUpperCase()]; } if(imp) o.imp=imp; if(url) o.url=url; if(note) o.note=note; return o; }
  function validateItem(year, it){ const errs=[]; if(it.genre) { const genres = Array.isArray(it.genre) ? it.genre : [it.genre]; for(const genre of genres) { const code=String(genre).toUpperCase(); if(!code){ errs.push(`ä¸æ­£ãªã‚¸ãƒ£ãƒ³ãƒ«: ${genre}`); } } } if(it.imp!==undefined && it.imp!=='' && !(parseInt(it.imp,10)>=1 && parseInt(it.imp,10)<=5)) errs.push(`ä¸æ­£ãªé‡è¦åº¦: ${it.imp}`); if(!(Number.isInteger(year) && year>=YEAR_MIN && year<=YEAR_MAX)) errs.push(`å¹´ã®ç¯„å›²å¤–: ${year}`); return errs; }
  function linesFromItems(items){ return items.map(serializeLine).join('\n'); }

  function showEditor(year, anchor){
    clearHighlight(); 
    const all = events[year]||[]; 
    const items = all.filter(passesFilter); 
    const note = (filterGenre||filterImp) ? 'ï¼ˆç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ã«ä¸€è‡´ã™ã‚‹é …ç›®ã®ã¿ç·¨é›†å¯¾è±¡ï¼‰' : '';
    
    editor.innerHTML = `
      <h4><span>${year}å¹´ã®é …ç›®ä¸€æ‹¬ç·¨é›† ${note}</span><span class="fmt">é–‹å§‹å¹´;çµ‚äº†å¹´;ãƒ©ãƒ™ãƒ«;ã‚¸ãƒ£ãƒ³ãƒ«;é‡è¦åº¦;URL;æ³¨é‡ˆ</span></h4>
      <textarea id="edText" placeholder="1è¡Œã«ã¤ã1ä»¶\nå½¢å¼ï¼šé–‹å§‹å¹´;çµ‚äº†å¹´;ãƒ©ãƒ™ãƒ«;ã‚¸ãƒ£ãƒ³ãƒ«;é‡è¦åº¦;URL;æ³¨é‡ˆ\nä¾‹ï¼‰\n1952;1968;é‰„è…•ã‚¢ãƒˆãƒ ;MAN;5;https://ja.wikipedia.org/wiki/é‰„è…•ã‚¢ãƒˆãƒ ;å›½æ°‘çš„SFãƒ’ãƒ¼ãƒ­ãƒ¼\n1983;ongoing;ãƒ‰ãƒ©ã‚´ãƒ³ãƒœãƒ¼ãƒ«;MAN;5;https://ja.wikipedia.org/wiki/ãƒ‰ãƒ©ã‚´ãƒ³ãƒœãƒ¼ãƒ«;ç¶™ç¶šä¸­ã®ãƒãƒ³ã‚¬\n;ä»»å¤©å ‚ãƒ•ã‚¡ãƒŸã‚³ãƒ³;GAM;5;https://ja.wikipedia.org/wiki/ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿;å®¶åº­ç”¨ã‚²ãƒ¼ãƒ æ©Ÿã®é©å‘½\nãƒ©ãƒ™ãƒ«;;;https://example.com;è£œè¶³ãƒ¡ãƒ¢\nãƒ©ãƒ™ãƒ«"></textarea>
      <div class="row">
        <div class="left">ä¿å­˜ã§JSONã«åæ˜ ï¼Ctrl+Enterã§ã‚‚ä¿å­˜ãƒ»Escã§é–‰ã˜ã‚‹</div>
        <div class="right">
          <button id="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="save">ä¿å­˜</button>
        </div>
      </div>`;
    
    const ta=editor.querySelector('#edText'); 
    ta.value = linesFromItems(items);
    
    const r=anchor ? anchor.getBoundingClientRect() : {right: 100, top: 100}; 
    const rv=vp.getBoundingClientRect(); 
    let left = r.right - rv.left + 8; 
    let top = r.top - rv.top; 
    const maxLeft = rv.width - 540; 
    if(left > maxLeft) left = Math.max(12, r.left - rv.left - 540);
    
    editor.style.left = left + 'px'; 
    editor.style.top = top + 'px'; 
    editor.style.display='block';

    function close(){ editor.style.display='none'; }
    editor.querySelector('#cancel').onclick = close;
    editor.querySelector('#save').onclick = ()=>{ 
      const lines = ta.value.split(/\n/).map(s=>s.trim()); 
      const subset = lines.map(parseLine).filter(Boolean); 
      const errs=[]; 
      for(const it of subset){ errs.push(...validateItem(year, it)); } 
      if(errs.length){ showError('ç·¨é›†ã‚¨ãƒ©ãƒ¼', errs); return; } 
      const allItems = events[year]||[]; 
      const others = allItems.filter(it=> !passesFilter(it)); 
      const merged = [...others, ...subset]; 
      if(merged.length===0) delete events[year]; 
      else events[year]=merged; 
      saveEvents(); 
      renderEvents(); 
      autoSave(); 
      close(); 
    };
    
    ta.addEventListener('keydown', e=>{ 
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ editor.querySelector('#save').click(); } 
      if(e.key==='Escape'){ e.preventDefault(); editor.querySelector('#cancel').click(); } 
    });
  }

  // ===== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ãƒ»å˜ç´”ã‚¯ãƒªãƒƒãƒ—ï¼‰ =====
  function renderEvents(){
    eventsG.innerHTML=''; clearHighlight(true);
    // ã™ã¹ã¦ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¯ãƒ©ã‚¹ã‚’ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢
    document.querySelectorAll('.hlText').forEach(el => el.classList.remove('hlText'));
    const years = Object.keys(events).map(Number).sort((a,b)=>a-b);
    for(const y of years){
      const ypx=yFromBirthYear(y);
      const labels=(events[y]||[]).filter(passesFilter).map(it=>it.label).filter(Boolean);
      if(labels.length===0){ continue; }
      const yearPart = String(y).slice(2);
      const labelsPart = labels.join('ï¼');
      const fullText = `${yearPart} ${labelsPart}`;
      
      // è¡¨ç¤ºç¯„å›²ã‚’è¨ˆç®—ï¼ˆå·¦ç«¯ã‹ã‚‰å³ç«¯ã¾ã§ï¼‰
      const maxWidth = LABEL_RIGHT_X - LABEL_LEFT_X;
      const charWidth = 10; // æ–‡å­—å¹…ã‚’ã‚ˆã‚Šå¤§ããè¦‹ç©ã‚‚ã‚Šï¼ˆå®‰å…¨å´ã«ï¼‰
      const maxChars = Math.floor(maxWidth / charWidth);
      
      // å¹´éƒ¨åˆ†ã¯å¿…ãšè¡¨ç¤ºã—ã€ãƒ©ãƒ™ãƒ«éƒ¨åˆ†ã®ã¿åˆ‡ã‚Šå–ã‚Šï¼ˆã™ã¹ã¦å³è©°ã‚ï¼‰
      let text;
      const textX = LABEL_RIGHT_X; // å¸¸ã«å³ç«¯
      const textAnchor = 'end'; // å¸¸ã«å³è©°ã‚
      
      // ã‚ˆã‚Šå³å¯†ãªåˆ¤å®šï¼šå¹´éƒ¨åˆ† + ã‚¹ãƒšãƒ¼ã‚¹ + ãƒãƒƒãƒ•ã‚¡ã‚’è€ƒæ…®
      const yearSpaceLength = yearPart.length + 1; // å¹´ + ã‚¹ãƒšãƒ¼ã‚¹
      const buffer = 8; // ä½™è£•ã‚’æŒãŸã›ã‚‹æ–‡å­—æ•°
      const minRequiredChars = yearSpaceLength + buffer;
      
      // åˆ¤å®šæ¡ä»¶ï¼šå¹´éƒ¨åˆ†ãŒç¢ºå®Ÿã«è¦‹ãˆã‚‹ã‹ã©ã†ã‹
      if (fullText.length > maxChars || minRequiredChars > maxChars || labelsPart.length > 15) {
        // åˆ‡ã‚Šå–ã‚‰ã‚ŒãŸå ´åˆã‚‚å³è©°ã‚ã§è¡¨ç¤º
        const remainingChars = Math.max(0, maxChars - yearSpaceLength - buffer);
        const truncatedLabels = labelsPart.substring(0, remainingChars);
        text = `${yearPart} ${truncatedLabels}`;
      } else {
        text = fullText;
      }
      
      const tx=textEl(text, textX, ypx, 'eventLabel');
      tx.setAttribute('text-anchor', textAnchor);
      tx.setAttribute('dominant-baseline','middle');
      tx.setAttribute('data-year', y);
      if(labels.length>1) tx.classList.add('eventMulti');
      tx.style.cursor='pointer';
      eventsG.appendChild(tx);
      // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ã‚¯ãƒªãƒƒã‚¯
      tx.addEventListener('mouseenter',e=>{ 
        clearHighlight(); 
        tooltip.style.display='block'; 
        const items = (events[y]||[]).filter(passesFilter);
        const tooltipContent = items.map(item => {
          let content = `<li><strong>${item.label}</strong>`;
          if (item.genre) content += ` <span style="color:#666;">[${Array.isArray(item.genre) ? item.genre.join('ãƒ»') : item.genre}]</span>`;
          if (item.imp) content += ` <span style="color:#666;">â˜…${item.imp}</span>`;
          content += '</li>';
          return content;
        }).join('');
        tooltip.innerHTML=`<strong>${y}å¹´</strong><ul style="margin:4px 0 0 16px;">${tooltipContent}</ul>`; 
        positionTooltip(e); 
      });
      tx.addEventListener('mousemove',positionTooltip);
      tx.addEventListener('mouseleave',()=>{tooltip.style.display='none'});
      tx.addEventListener('click',(e)=>{ tooltip.style.display='none'; showDetailList(y, e.target); });
    }
  }
  
  try {
    // èµ·å‹•æ™‚ã¯å…¨ã‚¸ãƒ£ãƒ³ãƒ«ã‚’è‡ªå‹•é¸æŠ
    selectedGenres = new Set(GENRES);
    updateGenreFilterButtonText && updateGenreFilterButtonText();
    renderEvents();
    
    // åˆæœŸåŒ–æ™‚ã«æ™‚ä»£åŒºåˆ†èƒŒæ™¯ã‚’æç”»
    renderEraBackgrounds();
  } catch (error) {
    console.error('ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
  }

  // ===== æ¤œç´¢ =====
  function doSearch(){ 
    clearHighlight(true); 
    const q=searchBox.value.trim(); 
    if(!q){ 
      matches=[]; 
      matchIndex=-1; 
      // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ãŒç©ºã®å ´åˆã¯ã™ã¹ã¦ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢
      document.querySelectorAll('.hlText').forEach(el => el.classList.remove('hlText'));
      return; 
    } 
    
    console.log('æ¤œç´¢ã‚¯ã‚¨ãƒª:', q);
    console.log('events:', events);
    
    // æ¤œç´¢å¯¾è±¡ã¯ã€Œé¸æŠä¸­ã‚¸ãƒ£ãƒ³ãƒ«ã®ãƒ©ãƒ™ãƒ«ã®ã¿ã€
    const searchResults = [];
    for (const year of Object.keys(events)) {
      const items = events[year] || [];
      for (const item of items) {
        // ã‚¸ãƒ£ãƒ³ãƒ«ãƒ•ã‚£ãƒ«ã‚¿
        if (selectedGenres.size === 0) continue;
        if (!itemHasSelectedGenre(item)) continue;
        const labelMatch = item.label && item.label.toLowerCase().includes(q.toLowerCase());
        if (labelMatch) {
          searchResults.push({ year: parseInt(year), item });
          console.log('ãƒãƒƒãƒã—ãŸé …ç›®:', { year, item, labelMatch });
        }
      }
    }
    
    console.log('æ¤œç´¢çµæœ:', searchResults);
    
    // æ¤œç´¢çµæœã«åŸºã¥ã„ã¦ãƒãƒƒãƒã™ã‚‹ãƒ©ãƒ™ãƒ«è¦ç´ ã‚’å–å¾—
    const els=[...eventsG.querySelectorAll('text.eventLabel')]; 
    console.log('è¡¨ç¤ºä¸­ã®ãƒ©ãƒ™ãƒ«è¦ç´ :', els.length);
    
    matches=els.filter(el=> {
      const year = parseInt(el.getAttribute('data-year'));
      // ãƒ†ã‚­ã‚¹ãƒˆãŒçœç•¥ï¼ˆãƒˆãƒ©ãƒ³ã‚±ãƒ¼ãƒˆï¼‰ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ã€
      // ç”»é¢è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã¸ã®å«æœ‰åˆ¤å®šã¯è¡Œã‚ãšã€å¹´å˜ä½ã§ä¸€è‡´ã‚’åˆ¤å®šã™ã‚‹
      const isMatch = searchResults.some(result => result.year === year);
      if (isMatch) {
        console.log('ãƒãƒƒãƒï¼ˆå¹´å˜ä½ï¼‰:', { year, element: el });
      }
      return isMatch;
    });
    
    console.log('æœ€çµ‚çš„ãªãƒãƒƒãƒæ•°:', matches.length);
    
    matchIndex = matches.length? 0 : -1; 
    if(matchIndex!==-1){ highlight(matches[matchIndex]); } 
  }
  function nextMatch(dir){ if(!matches.length) return; matchIndex=(matchIndex+ (dir>0?1:-1) + matches.length)%matches.length; highlight(matches[matchIndex]); }
  searchBtn.addEventListener('click', doSearch);
  searchBox.addEventListener('keydown', e=>{ if(e.key==='Enter'){ doSearch(); }});
  nextBtn.addEventListener('click', ()=> nextMatch(1));
  prevBtn.addEventListener('click', ()=> nextMatch(-1));
  vp.addEventListener('mousemove', ()=>{ if(clearOnNextMove) { clearHighlight(); } });
  vp.addEventListener('click', ()=>{ if(clearOnNextMove) { clearHighlight(); } });

  // ===== æ—¢å­˜ãƒ©ãƒ™ãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«çµ„ã¿åˆã‚ã›é›†åˆ =====
  function buildLabelGenreSet(){ 
    const s=new Set(); 
    for(const y of Object.keys(events)){ 
      for(const it of (events[y]||[])){ 
        if(!it || typeof it.label!=='string') continue;
        // å‰Šé™¤ãƒ•ãƒ©ã‚°ã®é …ç›®ã¯é‡è¤‡åˆ¤å®šã‹ã‚‰é™¤å¤–
        if (it.deleted === true) continue;
        const genreKey = Array.isArray(it.genre) ? it.genre.slice().sort().join('ãƒ»') : (it.genre || '');
        const key = `${it.label.trim()}|${genreKey}`;
        s.add(key);
      } 
    } 
    return s; 
  }

  // ===== GitHubåŒæœŸæ©Ÿèƒ½ =====
  let githubUser = null;


  // è¨­å®šã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
  function saveGitHubConfig() {
    try {
      localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
    } catch (e) {
      console.error('è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', e);
    }
  }

  function loadGitHubConfig() {
    try {
      const saved = localStorage.getItem('githubConfig');
      if (saved) {
        githubConfig = { ...githubConfig, ...JSON.parse(saved) };
      }
    } catch (e) {
      console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
    }
  }

  // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆå¤‰æ›´ãƒ»è¿½åŠ ãƒ»å‰Šé™¤ã®ã¿ï¼‰
  function exportToCSV() {
    const csvData = [];
    // æ—§é …ç›®ã‚„å‰Šé™¤é …ç›®ã‚’æ˜ç¤ºã™ã‚‹ãŸã‚ deleted åˆ—ã‚’ä»˜ä¸
    csvData.push('é–‹å§‹å¹´;çµ‚äº†å¹´;ãƒ©ãƒ™ãƒ«;ã‚¸ãƒ£ãƒ³ãƒ«;é‡è¦åº¦;URL;æ³¨é‡ˆ;deleted');
    
    let exportCount = 0;
    
    for (const [year, items] of Object.entries(events)) {
      for (const item of items) {
        const startYear = item.startYear || '';
        const endYear = item.endYear || '';
        const label = item.label || '';
        const genre = Array.isArray(item.genre) ? item.genre.join('ãƒ»') : (item.genre || '');
        const imp = item.imp || '';
        const url = item.url || '';
        const note = item.note || '';
        
        // 1) é€šå¸¸ç·¨é›† or è¿½åŠ : ç·¨é›†ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹ã‚‚ã®
        const genreKeyForFlag = Array.isArray(item.genre) ? item.genre.slice().sort().join('ãƒ»') : (item.genre || '');
        const hasEdit = hasEditFlag(year, item.label, genreKeyForFlag);
        if (hasEdit) {
          // ç¾è¡Œï¼ˆæ–°/ç·¨é›†ï¼‰ãƒ‡ãƒ¼ã‚¿ã¯ deleted ç©ºæ¬„
          csvData.push(`${startYear};${endYear};${label};${genre};${imp};${url};${note};`);
          exportCount++;
        }
      }
    }
    // 2) å‰Šé™¤ãƒ»æ—§è­˜åˆ¥å­ã®å‡ºåŠ›ï¼ˆdeleted=trueã¯ä»˜ã‘ãšã€æ—§å†…å®¹ã‚’è¡Œã¨ã—ã¦å‡ºåŠ›ï¼‰
    for (const rec of (deletionRecords || [])) {
      const startYear = rec.startYear || '';
      const endYear = rec.endYear || '';
      const label = rec.label || '';
      const genre = rec.genre || '';
      const imp = rec.imp || '';
      const url = rec.url || '';
      const note = rec.note || '';
      // æ—§/å‰Šé™¤ãƒ‡ãƒ¼ã‚¿ã¯ deleted=true ã‚’ä»˜ã‘ã‚‹
      csvData.push(`${startYear};${endYear};${label};${genre};${imp};${url};${note};true`);
      exportCount++;
    }
    
    if (exportCount === 0) {
      showInfo('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆçµæœ', 'å¤‰æ›´ãƒ»è¿½åŠ ãƒ»å‰Šé™¤ã•ã‚ŒãŸé …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }
    
    const csvContent = csvData.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `nativemap_changes_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showInfo('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†', `${exportCount}ä»¶ã®å¤‰æ›´ãƒ»è¿½åŠ ãƒ»å‰Šé™¤ã‚’CSVã§å‡ºåŠ›ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚`);
  }

  // GitHubã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  async function loadFromGitHub() {
    if (!githubConfig.accessToken) {
      // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›
      const hasData = Object.keys(events).length > 0;
      if (hasData) {
        const result = confirm('GitHubã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nå¤‰æ›´ã•ã‚ŒãŸé …ç›®ã®ã¿ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã€ç®¡ç†è€…ã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\nã€ŒOKã€: CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€: ä½•ã‚‚ã—ãªã„');
        if (result) {
          exportToCSV();
        }
      } else {
        showError('è¨­å®šã‚¨ãƒ©ãƒ¼', 'GitHubã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚GitHubã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
      }
      return null;
    }

    try {
      const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filePath}`, {
        headers: {
          'Authorization': `Bearer ${githubConfig.accessToken}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });

      if (!response.ok) {
        if (response.status === 404) {
          // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
          return {};
        }
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const responseData = await response.json();
      // GitHub APIã®Base64ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ããƒ‡ã‚³ãƒ¼ãƒ‰
      const binaryString = atob(responseData.content);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      const content = new TextDecoder('utf-8').decode(bytes);
      const data = JSON.parse(content);
      
      if (data.events) {
        // æ–°ã—ã„å½¢å¼ï¼ˆevents + eraSettings + genresï¼‰
        eraSettings = data.eraSettings || [];
        if (data.genres) { setGenresFromRemote(data.genres); }
        return data.events;
      } else {
        // å¤ã„å½¢å¼ï¼ˆeventsã®ã¿ï¼‰
        return data;
      }
    } catch (error) {
      showError('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', `GitHubã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
      return null;
    }
  }

  // GitHubã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ãªã—ï¼‰
  async function loadFromGitHubWithoutToken() {
    try {
      // ãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã§GitHubã®rawãƒ•ã‚¡ã‚¤ãƒ«ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
      const rawUrl = `https://raw.githubusercontent.com/${githubConfig.owner}/${githubConfig.repo}/main/${githubConfig.filePath}`;
      console.log('GitHub raw URL:', rawUrl);
      
      const response = await fetch(rawUrl);
      
      if (!response.ok) {
        throw new Error(`GitHub raw file error: ${response.status} ${response.statusText}`);
      }

      const content = await response.text();
      const jsonData = JSON.parse(content);
      
      // ã‚¸ãƒ£ãƒ³ãƒ«ãŒæ›´æ–°ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ãƒ•ã‚£ãƒ«ã‚¿é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      if (jsonData.genres) { 
        setGenresFromRemote(jsonData.genres); 
        console.log('ã‚¸ãƒ£ãƒ³ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°:', GENRES, GENRE_LABELS);
      }
      
      // æ™‚ä»£åŒºåˆ†ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      if (jsonData.eraSettings) {
        eraSettings = jsonData.eraSettings;
        console.log('æ™‚ä»£åŒºåˆ†ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿:', eraSettings.length, 'å€‹');
        // æ™‚ä»£åŒºåˆ†èƒŒæ™¯ã‚’å†æç”»
        if (typeof drawEraBackgrounds === 'function') {
          drawEraBackgrounds();
        }
      }
      
      return jsonData.events ? jsonData.events : jsonData;
    } catch (error) {
      console.error('GitHub raw fileã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      throw error; // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼ã—ã¦ä¸Šä½ã®catchã§å‡¦ç†
    }
  }

  // GitHubã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆç«¶åˆæ¤œå‡ºãƒ»è§£æ±ºæ©Ÿèƒ½ä»˜ãï¼‰
  async function saveToGitHub(data, expectedSha = null, retryCount = 0) {
    if (!githubConfig.accessToken) {
      // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›
      const hasData = Object.keys(events).length > 0;
      if (hasData) {
        const result = confirm('GitHubã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nå¤‰æ›´ã•ã‚ŒãŸé …ç›®ã®ã¿ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã€ç®¡ç†è€…ã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\nã€ŒOKã€: CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€: ä½•ã‚‚ã—ãªã„');
        if (result) {
          exportToCSV();
        }
      } else {
        showError('è¨­å®šã‚¨ãƒ©ãƒ¼', 'GitHubã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
      return false;
    }

    const maxRetries = 3;
    
    try {
      console.log(`saveToGitHubé–‹å§‹ (è©¦è¡Œå›æ•°: ${retryCount + 1}/${maxRetries + 1})`);
      console.log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:', JSON.stringify(data).length, 'bytes');
      console.log('æœŸå¾…ã™ã‚‹SHA:', expectedSha);
      
      // ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—ã—ã¦SHAã‚’ç¢ºèª
      let currentSha = null;
      try {
        console.log('ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®SHAã‚’å–å¾—ä¸­...');
        const getResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filePath}`, {
          headers: {
            'Authorization': `Bearer ${githubConfig.accessToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (getResponse.ok) {
          const fileData = await getResponse.json();
          currentSha = fileData.sha;
          console.log('ç¾åœ¨ã®SHAå–å¾—æˆåŠŸ:', currentSha);
          
          // æœŸå¾…ã™ã‚‹SHAã¨ç¾åœ¨ã®SHAãŒç•°ãªã‚‹å ´åˆã€ç«¶åˆãŒç™ºç”Ÿ
          if (expectedSha && currentSha !== expectedSha) {
            console.log('ç«¶åˆæ¤œå‡º: æœŸå¾…ã™ã‚‹SHAã¨ç¾åœ¨ã®SHAãŒç•°ãªã‚Šã¾ã™');
            console.log('æœŸå¾…ã™ã‚‹SHA:', expectedSha);
            console.log('ç¾åœ¨ã®SHA:', currentSha);
            
            if (retryCount < maxRetries) {
              console.log('ç«¶åˆè§£æ±ºã®ãŸã‚å†è©¦è¡Œã—ã¾ã™...');
              // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¦ãƒãƒ¼ã‚¸å‡¦ç†ã‚’å†å®Ÿè¡Œ
              return await handleConflictAndRetry(data, currentSha, retryCount);
            } else {
              throw new Error('æœ€å¤§å†è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§åŒæœŸã—ã¦ãã ã•ã„ã€‚');
            }
          }
        } else {
          console.log('SHAå–å¾—å¤±æ•—:', getResponse.status, getResponse.statusText);
        }
      } catch (e) {
        console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ã‹ã€SHAã®å–å¾—ã«å¤±æ•—:', e);
      }

      // UTF-8æ–‡å­—åˆ—ã‚’æ­£ã—ãBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
      console.log('ãƒ‡ãƒ¼ã‚¿ã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¸­...');
      const jsonString = JSON.stringify(data, null, 2);
      
      // ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãƒ•ãƒ©ã‚°ä»˜ãé …ç›®ã‚’ãƒã‚§ãƒƒã‚¯
      let savedDeletedItems = [];
      for (const year of Object.keys(data.events || {})) {
        const items = data.events[year] || [];
        for (const item of items) {
          if (item.deleted === true) {
            savedDeletedItems.push({ year, label: item.label, deleted: item.deleted });
          }
        }
      }
      console.log('ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãƒ•ãƒ©ã‚°ä»˜ãé …ç›®:', savedDeletedItems);
      
      const bytes = new TextEncoder().encode(jsonString);
      
      // å¤§ããªé…åˆ—ã®å ´åˆã¯åˆ†å‰²ã—ã¦å‡¦ç†
      let binaryString = '';
      const chunkSize = 8192; // 8KBãšã¤å‡¦ç†
      for (let i = 0; i < bytes.length; i += chunkSize) {
        const chunk = bytes.slice(i, i + chunkSize);
        binaryString += String.fromCharCode(...chunk);
      }
      
      const content = btoa(binaryString);
      console.log('Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å®Œäº†, ã‚µã‚¤ã‚º:', content.length, 'bytes');
      
      const body = {
        message: `Update timeline data - ${new Date().toISOString()}`,
        content: content
      };

      // ç¾åœ¨ã®SHAã‚’è¿½åŠ ï¼ˆç«¶åˆæ¤œå‡ºã®ãŸã‚ï¼‰
      if (currentSha) {
        body.sha = currentSha;
        console.log('ç¾åœ¨ã®SHAã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«è¿½åŠ ');
      }

      console.log('GitHub APIã«PUTãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
      const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filePath}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${githubConfig.accessToken}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });

      console.log('GitHub APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status, response.statusText);

      if (!response.ok) {
        const errorData = await response.json();
        console.error('GitHub APIã‚¨ãƒ©ãƒ¼è©³ç´°:', errorData);
        
        // 409ã‚¨ãƒ©ãƒ¼ï¼ˆç«¶åˆï¼‰ã®å ´åˆã®ç‰¹åˆ¥å‡¦ç†
        if (response.status === 409) {
          console.log('409ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦æ›´æ–°ã•ã‚Œã¾ã—ãŸ');
          if (retryCount < maxRetries) {
            console.log('ç«¶åˆè§£æ±ºã®ãŸã‚å†è©¦è¡Œã—ã¾ã™...');
            return await handleConflictAndRetry(data, null, retryCount);
          } else {
            throw new Error('ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ™‚ã«ç·¨é›†ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦åŒæœŸã—ã¦ãã ã•ã„ã€‚');
          }
        }
        
        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorData.message || ''}`);
      }

      console.log('saveToGitHubå®Œäº†');
      return true;
    } catch (error) {
      console.error('saveToGitHubã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
      if (retryCount < maxRetries && error.message.includes('ç«¶åˆ')) {
        console.log('ç«¶åˆã‚¨ãƒ©ãƒ¼ã®ãŸã‚å†è©¦è¡Œã—ã¾ã™...');
        return await handleConflictAndRetry(data, null, retryCount);
      }
      showError('ä¿å­˜ã‚¨ãƒ©ãƒ¼', `GitHubã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
      return false;
    }
  }
  
  // ç«¶åˆç™ºç”Ÿæ™‚ã®å†è©¦è¡Œå‡¦ç†
  async function handleConflictAndRetry(originalData, newSha, retryCount) {
    console.log('ç«¶åˆè§£æ±ºå‡¦ç†é–‹å§‹');
    
    try {
      // æœ€æ–°ã®ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
      console.log('æœ€æ–°ã®ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ä¸­...');
      const latestRemoteData = await loadFromGitHub();
      if (latestRemoteData === null) {
        throw new Error('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      // ã‚ˆã‚Šè©³ç´°ãªãƒãƒ¼ã‚¸å‡¦ç†ã‚’å®Ÿè¡Œ
      const { merged: mergedAfterResolve, conflicts } = await performDetailedMerge(events, latestRemoteData);
      
      // å†è©¦è¡Œï¼ˆãƒãƒ¼ã‚¸æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ä¿å­˜ï¼‰
      const ok = await saveToGitHub(mergedAfterResolve, newSha, retryCount + 1);
      if (!ok) return false;
      
      // ä¿å­˜æˆåŠŸæ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã«ã‚‚åæ˜ ã—ã¦ã€ç«¶åˆé€šçŸ¥ã‚’è¡¨ç¤º
      events = mergedAfterResolve;
      saveEvents();
      renderEvents();
      if (conflicts && conflicts.length) {
        showConflictNotification(conflicts);
      }
      return true;
    } catch (error) {
      console.error('ç«¶åˆè§£æ±ºå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      
      // ç«¶åˆã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è©³ç´°ãªç«¶åˆæƒ…å ±ã‚’è¡¨ç¤º
      if (error instanceof ConflictError) {
        showConflictNotification(error.conflicts);
        return false;
      }
      
      showError('ç«¶åˆè§£æ±ºã‚¨ãƒ©ãƒ¼', `ç«¶åˆã®è§£æ±ºã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
      return false;
    }
  }
  
  // ç«¶åˆé€šçŸ¥ã‚’è¡¨ç¤ºï¼ˆè‡ªå‹•è§£æ±ºå¾Œï¼‰
  function showConflictNotification(conflicts) {
    console.log('ç«¶åˆé€šçŸ¥:', conflicts);
    
    let conflictHtml = '<h4>ç·¨é›†ç«¶åˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ</h4>';
    conflictHtml += '<p>ä»¥ä¸‹ã®é …ç›®ã«ã¤ã„ã¦ã€ç·¨é›†ãŒç«¶åˆã—ãŸãŸã‚æ–°ãŸã«åŒæœŸã—ã¦ã‹ã‚‰ã‚„ã‚ŠãªãŠã—ã¦ãã ã•ã„ã€‚</p>';
    
    let hasNoteConflicts = false;
    let hasOtherConflicts = false;
    
    conflicts.forEach((conflict, index) => {
      const noteConflict = conflict.conflictFields.find(cf => cf.field === 'note');
      const impConflict = conflict.conflictFields.find(cf => cf.field === 'imp');
      const urlConflict = conflict.conflictFields.find(cf => cf.field === 'url');
      const hasNoteConflict = noteConflict && noteConflict.localValue !== noteConflict.remoteValue;
      const hasImpConflict = impConflict && impConflict.localValue !== impConflict.remoteValue;
      const hasUrlConflict = urlConflict && urlConflict.localValue !== urlConflict.remoteValue;
      
      if (hasNoteConflict) hasNoteConflicts = true;
      if (hasImpConflict || hasUrlConflict) hasOtherConflicts = true;
      
      conflictHtml += `
        <div style="border: 1px solid #f44336; margin: 12px 0; padding: 12px; border-radius: 6px; background: #ffebee;">
          <h5 style="margin: 0 0 8px 0; color: #d32f2f;">${conflict.year}å¹´: ${conflict.label}${conflict.genre ? ` [${conflict.genre}]` : ''}</h5>
          <div style="margin: 8px 0; padding: 8px; background: #ffcdd2; border-radius: 4px;">
            <strong style="color: #d32f2f;">ç·¨é›†ãŒç«¶åˆã—ãŸãŸã‚æ–°ãŸã«åŒæœŸã—ã¦ã‹ã‚‰ã‚„ã‚ŠãªãŠã—ã¦ãã ã•ã„</strong>
          </div>
        </div>
      `;
    });
    
    // æ³¨æ„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    conflictHtml += `
      <div style="margin-top: 16px; padding: 12px; background: #fff3e0; border: 1px solid #ff9800; border-radius: 6px;">
        <h6 style="margin: 0 0 8px 0; color: #f57c00;">æ³¨æ„</h6>
        <p style="margin: 0; font-size: 14px; color: #f57c00;">
          ç«¶åˆã—ãŸé …ç›®ã¯ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¨é›†å†…å®¹ã«è¨­å®šã•ã‚Œã¾ã—ãŸã€‚<br>
          å†åº¦åŒæœŸã—ã¦ã‹ã‚‰ç·¨é›†ã‚’ã‚„ã‚ŠãªãŠã—ã¦ãã ã•ã„ã€‚
        </p>
      </div>
    `;
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆè‡ªå‹•ã§é–‰ã˜ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
    openModal('ç«¶åˆã‚¨ãƒ©ãƒ¼', conflictHtml);
  }
  
  // ã‚¢ã‚¤ãƒ†ãƒ ã®è©³ç´°ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  function formatItemDetails(item) {
    let details = [];
    if (item.label) details.push(`<strong>ãƒ©ãƒ™ãƒ«:</strong> ${item.label}`);
    if (item.genre) details.push(`<strong>ã‚¸ãƒ£ãƒ³ãƒ«:</strong> ${item.genre}`);
    if (item.imp) details.push(`<strong>é‡è¦åº¦:</strong> ${item.imp}`);
    if (item.url) details.push(`<strong>URL:</strong> ${item.url}`);
    if (item.note) details.push(`<strong>æ³¨é‡ˆ:</strong> ${item.note}`);
    
    return details.length > 0 ? details.join('<br>') : '<em>ãƒ‡ãƒ¼ã‚¿ãªã—</em>';
  }
  
  // è©³ç´°ãªãƒãƒ¼ã‚¸å‡¦ç†ï¼ˆçœŸã®ç«¶åˆã®ã¿æ¤œå‡ºï¼‰
  async function performDetailedMerge(localData, remoteData) {
    console.log('è©³ç´°ãƒãƒ¼ã‚¸å‡¦ç†é–‹å§‹');
    console.log('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿:', localData);
    console.log('ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿:', remoteData);
    
    const merged = { ...remoteData };
    const conflicts = []; // çœŸã®ç«¶åˆã®ã¿ã‚’è¨˜éŒ²
    
    // å„å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°ã«ãƒãƒ¼ã‚¸
    const getGenreKey = (g)=> Array.isArray(g) ? g.slice().sort().join('ãƒ»') : (g || '');
    const getYearVal = (it, fallbackYear) => (it && typeof it.startYear === 'number') ? it.startYear : fallbackYear;
    const makeKey = (it, fallbackYear) => `${it.label}|${getGenreKey(it.genre)}|${getYearVal(it, fallbackYear)}`;

    for (const [year, localItems] of Object.entries(localData)) {
      if (!merged[year]) {
        merged[year] = [];
      }
      
      const remoteItems = merged[year] || [];
      const localItemMap = new Map();
      const remoteItemMap = new Map();
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒãƒƒãƒ—åŒ–ï¼ˆå¹´ã‚‚ã‚­ãƒ¼ã«å«ã‚ã€ã‚¸ãƒ£ãƒ³ãƒ«ã¯æ­£è¦åŒ–ï¼‰
      localItems.forEach(item => {
        const key = makeKey(item, parseInt(year,10));
        localItemMap.set(key, item);
      });
      
      // ãƒªãƒ¢ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒãƒƒãƒ—åŒ–
      remoteItems.forEach(item => {
        const key = makeKey(item, parseInt(year,10));
        remoteItemMap.set(key, item);
      });
      
      const mergedItems = [];
      const processedKeys = new Set();
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‡¦ç†
      for (const [key, localItem] of localItemMap) {
        const remoteItem = remoteItemMap.get(key);
        
        if (remoteItem) {
          // ä¸¡æ–¹ã«å­˜åœ¨ã™ã‚‹å ´åˆï¼šç·¨é›†ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
          const hasLocalEdit = hasEditFlag(getYearVal(localItem, parseInt(year,10)), localItem.label, getGenreKey(localItem.genre));
          
          if (hasLocalEdit) {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã§ç·¨é›†ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ç«¶åˆã‚’ãƒã‚§ãƒƒã‚¯
            const conflictInfo = checkRealConflict(localItem, remoteItem);
            if (conflictInfo.hasConflict) {
              conflicts.push({
                year: year,
                label: localItem.label,
                genre: localItem.genre || '',
                localItem: localItem,
                remoteItem: remoteItem,
                conflictFields: conflictInfo.conflictFields
              });
              
              // çœŸã®ç«¶åˆãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•è§£æ±ºã‚’å®Ÿè¡Œ
              const resolvedItem = resolveConflict(localItem, remoteItem, conflictInfo);
              mergedItems.push(resolvedItem);
            } else {
              // ç«¶åˆãŒãªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®é …ç›®ã‚’ä¿æŒ
              mergedItems.push(localItem);
            }
          } else {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã§ç·¨é›†ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒªãƒ¢ãƒ¼ãƒˆã®é …ç›®ã‚’æ¡ç”¨
            console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã§ç·¨é›†ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒªãƒ¢ãƒ¼ãƒˆã®é …ç›®ã‚’æ¡ç”¨:', localItem.label);
            mergedItems.push(remoteItem);
          }
        } else {
          // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã«å­˜åœ¨ã™ã‚‹å ´åˆï¼ˆæ–°è¦ or æ—§ãƒ¬ã‚³ãƒ¼ãƒ‰ã®deletedï¼‰
          mergedItems.push(localItem);
        }
        processedKeys.add(key);
      }
      
      // ãƒªãƒ¢ãƒ¼ãƒˆã®ã¿ã«å­˜åœ¨ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
      for (const [key, remoteItem] of remoteItemMap) {
        if (!processedKeys.has(key)) {
          mergedItems.push(remoteItem);
        }
      }
      
      merged[year] = mergedItems;
    }
    
    console.log('è©³ç´°ãƒãƒ¼ã‚¸å‡¦ç†å®Œäº†:', merged);
    return { merged, conflicts };
  }
  
  // çœŸã®ç«¶åˆã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹å¤‰æ›´ã®ã¿ï¼‰
  function checkRealConflict(localItem, remoteItem) {
    const fields = ['label', 'genre', 'imp', 'url', 'note', 'startYear', 'endYear'];
    const conflictFields = [];
    
    for (const field of fields) {
      const localValue = localItem[field] || '';
      const remoteValue = remoteItem[field] || '';
      
      // æ³¨é‡ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç‰¹åˆ¥å‡¦ç†
      if (field === 'note') {
        if (isRealNoteConflict(localValue, remoteValue)) {
          console.log(`çœŸã®ç«¶åˆæ¤œå‡º: ${field} ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç•°ãªã‚Šã¾ã™`);
          console.log(`ãƒ­ãƒ¼ã‚«ãƒ«: "${localValue}"`);
          console.log(`ãƒªãƒ¢ãƒ¼ãƒˆ: "${remoteValue}"`);
          conflictFields.push({
            field: field,
            localValue: localValue,
            remoteValue: remoteValue
          });
        }
      } else {
        // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¾“æ¥é€šã‚Š
        // ãŸã ã—ã€ç©ºæ–‡å­—åˆ—ã¨undefinedã®é•ã„ã¯ç«¶åˆã¨ã—ãªã„
        let localNormalized = localValue === '' ? undefined : localValue;
        let remoteNormalized = remoteValue === '' ? undefined : remoteValue;
        if (field === 'genre') {
          localNormalized = Array.isArray(localValue) ? localValue.slice().sort().join('ãƒ»') : (localValue || undefined);
          remoteNormalized = Array.isArray(remoteValue) ? remoteValue.slice().sort().join('ãƒ»') : (remoteValue || undefined);
        }
        
        if (localNormalized !== remoteNormalized) {
          console.log(`çœŸã®ç«¶åˆæ¤œå‡º: ${field} ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç•°ãªã‚Šã¾ã™`);
          console.log(`ãƒ­ãƒ¼ã‚«ãƒ«: "${localValue}"`);
          console.log(`ãƒªãƒ¢ãƒ¼ãƒˆ: "${remoteValue}"`);
          conflictFields.push({
            field: field,
            localValue: localValue,
            remoteValue: remoteValue
          });
        }
      }
    }
    
    return {
      hasConflict: conflictFields.length > 0,
      conflictFields: conflictFields
    };
  }
  
  // çœŸã®æ³¨é‡ˆç«¶åˆã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆè¿½è¨˜ã«ã‚ˆã‚‹å¤‰æ›´ã¯ç«¶åˆã¨ã—ãªã„ï¼‰
  function isRealNoteConflict(localNote, remoteNote) {
    if (!localNote && !remoteNote) return false;
    if (!localNote && remoteNote) return false; // ãƒ­ãƒ¼ã‚«ãƒ«ã«æ³¨é‡ˆãŒãªãã€ãƒªãƒ¢ãƒ¼ãƒˆã«ã‚ã‚‹å ´åˆã¯ç«¶åˆã§ã¯ãªã„
    if (localNote && !remoteNote) return false; // ãƒ­ãƒ¼ã‚«ãƒ«ã«æ³¨é‡ˆãŒã‚ã‚Šã€ãƒªãƒ¢ãƒ¼ãƒˆã«ãªã„å ´åˆã¯ç«¶åˆã§ã¯ãªã„
    if (localNote === remoteNote) return false;
    
    // ãƒªãƒ¢ãƒ¼ãƒˆã®æ³¨é‡ˆã‚’è§£æ
    const remoteLines = remoteNote.split('\n');
    const hasAppendMarker = remoteLines.some(line => line.trim().startsWith('[è¿½è¨˜]'));
    
    if (hasAppendMarker) {
      // è¿½è¨˜ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚‹å ´åˆã€å…ƒã®å†…å®¹ã¨è¿½è¨˜å†…å®¹ã‚’åˆ†é›¢
      const originalContent = remoteLines[0].trim();
      const appendLines = remoteLines.slice(1).map(line => {
        return line.trim().replace(/^\[è¿½è¨˜\]\s*/, '');
      }).filter(line => line.length > 0);
      
      const localTrimmed = localNote.trim();
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã®å†…å®¹ãŒå…ƒã®å†…å®¹ã¨åŒã˜å ´åˆã¯ç«¶åˆã¨ã—ãªã„
      if (originalContent === localTrimmed) {
        return false;
      }
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã®å†…å®¹ãŒè¿½è¨˜å†…å®¹ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ç«¶åˆã¨ã—ãªã„
      const isInAppendLines = appendLines.some(appendLine => {
        return appendLine === localTrimmed;
      });
      
      if (isInAppendLines) {
        return false;
      }
    } else {
      // è¿½è¨˜ãƒãƒ¼ã‚«ãƒ¼ãŒãªã„å ´åˆã€å˜ç´”ãªé‡è¤‡ãƒã‚§ãƒƒã‚¯
      const localTrimmed = localNote.trim();
      const remoteTrimmed = remoteNote.trim();
      
      if (localTrimmed === remoteTrimmed) {
        return false;
      }
    }
    
    return true;
  }
  
  // æ³¨é‡ˆã®ç«¶åˆã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆè¿½è¨˜æ¸ˆã¿ã®å ´åˆã¯ç«¶åˆã¨ã—ãªã„ï¼‰
  function isNoteConflict(localNote, remoteNote) {
    if (!localNote && !remoteNote) return false;
    if (!localNote || !remoteNote) return true;
    if (localNote === remoteNote) return false;
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã®æ³¨é‡ˆãŒãƒªãƒ¢ãƒ¼ãƒˆã®æ³¨é‡ˆã«æ—¢ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const localTrimmed = localNote.trim();
    const remoteLines = remoteNote.split('\n');
    
    // ãƒªãƒ¢ãƒ¼ãƒˆã®å„è¡Œã‹ã‚‰[è¿½è¨˜]ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ã—ã¦æ¯”è¼ƒ
    const remoteContentLines = remoteLines.map(line => {
      return line.trim().replace(/^\[è¿½è¨˜\]\s*/, '');
    });
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã®å†…å®¹ãŒãƒªãƒ¢ãƒ¼ãƒˆã«æ—¢ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ç«¶åˆã¨ã—ãªã„
    const isAlreadyIncluded = remoteContentLines.some(remoteContent => {
      return remoteContent === localTrimmed;
    });
    
    if (isAlreadyIncluded) {
      console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã®æ³¨é‡ˆã¯æ—¢ã«ãƒªãƒ¢ãƒ¼ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ç«¶åˆã¨ã—ãªã„:', localNote);
      return false;
    }
    
    return true;
  }
  
  // ç«¶åˆã‚’è‡ªå‹•è§£æ±º
  function resolveConflict(localItem, remoteItem, conflictInfo) {
    console.log('ç«¶åˆè‡ªå‹•è§£æ±ºé–‹å§‹:', localItem.label);
    
    // åŸºæœ¬æ§‹é€ ã¯ãƒªãƒ¢ãƒ¼ãƒˆã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹
    const resolved = { ...remoteItem };
    
    // é‡è¦åº¦ã¨URLã¯å¤‰æ›´ã•ã‚Œãªã„ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆã®å€¤ã‚’ä¿æŒï¼‰
    // æ³¨é‡ˆã¯è¿½è¨˜ã•ã‚Œã‚‹ï¼ˆãŸã ã—é‡è¤‡ã‚’é¿ã‘ã‚‹ï¼‰
    const noteConflict = conflictInfo.conflictFields.find(cf => cf.field === 'note');
    if (noteConflict) {
      const localNote = noteConflict.localValue;
      const remoteNote = noteConflict.remoteValue;
      
      if (localNote && remoteNote && localNote !== remoteNote) {
        // ä¸¡æ–¹ã«æ³¨é‡ˆãŒã‚ã‚‹å ´åˆï¼šé‡è¤‡ãƒã‚§ãƒƒã‚¯ã—ã¦è¿½è¨˜
        resolved.note = appendNoteSafely(remoteNote, localNote);
        console.log('æ³¨é‡ˆã‚’å®‰å…¨ã«è¿½è¨˜:', resolved.note);
      } else if (localNote && !remoteNote) {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã«æ³¨é‡ˆãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
        resolved.note = localNote;
        console.log('æ³¨é‡ˆã‚’è¿½åŠ :', resolved.note);
      }
      // ãƒªãƒ¢ãƒ¼ãƒˆã®ã¿ã«æ³¨é‡ˆãŒã‚ã‚‹å ´åˆã¯ãã®ã¾ã¾ä¿æŒ
    }
    
    console.log('ç«¶åˆè§£æ±ºå®Œäº†:', resolved);
    return resolved;
  }
  
  // æ³¨é‡ˆã‚’å®‰å…¨ã«è¿½è¨˜ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ï¼‰
  function appendNoteSafely(existingNote, newNote) {
    if (!existingNote) return newNote;
    if (!newNote) return existingNote;
    
    // æ—¢å­˜ã®æ³¨é‡ˆã‚’è§£æ
    const existingLines = existingNote.split('\n');
    const hasAppendMarker = existingLines.some(line => line.trim().startsWith('[è¿½è¨˜]'));
    
    // æ–°ã—ã„æ³¨é‡ˆãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const newNoteTrimmed = newNote.trim();
    
    if (hasAppendMarker) {
      // è¿½è¨˜ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚‹å ´åˆã€å…ƒã®å†…å®¹ã¨è¿½è¨˜å†…å®¹ã‚’åˆ†é›¢ã—ã¦ãƒã‚§ãƒƒã‚¯
      const originalContent = existingLines[0].trim();
      const appendLines = existingLines.slice(1).map(line => {
        return line.trim().replace(/^\[è¿½è¨˜\]\s*/, '');
      }).filter(line => line.length > 0);
      
      // å…ƒã®å†…å®¹ã¨åŒã˜ã‹ãƒã‚§ãƒƒã‚¯
      if (originalContent === newNoteTrimmed) {
        console.log('æ–°ã—ã„æ³¨é‡ˆãŒå…ƒã®å†…å®¹ã¨åŒã˜ãŸã‚è¿½è¨˜ã‚’ã‚¹ã‚­ãƒƒãƒ—:', newNote);
        return existingNote;
      }
      
      // è¿½è¨˜å†…å®¹ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const alreadyInAppend = appendLines.some(appendLine => {
        return appendLine === newNoteTrimmed;
      });
      
      if (alreadyInAppend) {
        console.log('æ–°ã—ã„æ³¨é‡ˆãŒè¿½è¨˜å†…å®¹ã«æ—¢ã«å­˜åœ¨ã™ã‚‹ãŸã‚è¿½è¨˜ã‚’ã‚¹ã‚­ãƒƒãƒ—:', newNote);
        return existingNote;
      }
    } else {
      // è¿½è¨˜ãƒãƒ¼ã‚«ãƒ¼ãŒãªã„å ´åˆã€å˜ç´”ãªé‡è¤‡ãƒã‚§ãƒƒã‚¯
      const existingTrimmed = existingNote.trim();
      if (existingTrimmed === newNoteTrimmed) {
        console.log('æ–°ã—ã„æ³¨é‡ˆãŒæ—¢å­˜ã®å†…å®¹ã¨åŒã˜ãŸã‚è¿½è¨˜ã‚’ã‚¹ã‚­ãƒƒãƒ—:', newNote);
        return existingNote;
      }
    }
    
    // æ–°ã—ã„æ³¨é‡ˆã‚’è¿½è¨˜
    return `${existingNote}\n[è¿½è¨˜] ${newNote}`;
  }
  
  // ç«¶åˆã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
  class ConflictError extends Error {
    constructor(message, conflicts) {
      super(message);
      this.name = 'ConflictError';
      this.conflicts = conflicts;
    }
  }

  // åŒæœŸå‡¦ç†ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãªã—ï¼‰
  async function syncWithConfirmation() {
    await syncWithGitHub();
  }

  // åŒæœŸå‡¦ç†ï¼ˆç«¶åˆæ¤œå‡ºãƒ»è§£æ±ºæ©Ÿèƒ½ä»˜ãï¼‰
  async function syncWithGitHub() {
    try {
      console.log('åŒæœŸå‡¦ç†é–‹å§‹');
      console.log('åŒæœŸé–‹å§‹æ™‚ã®eraSettings:', eraSettings);
      console.log('åŒæœŸé–‹å§‹æ™‚ã®eraSettingsã®é•·ã•:', eraSettings ? eraSettings.length : 0);
      console.log('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:', JSON.stringify(events).length, 'bytes');
      
      // 1. GitHubã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆSHAãƒãƒƒã‚·ãƒ¥ã‚‚åŒæ™‚ã«å–å¾—ï¼‰
      console.log('GitHubã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      const { remoteData, remoteSha, remoteEraSettings, timestamp } = await loadFromGitHubWithSha();
      if (remoteData === null) {
        console.log('ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—');
        return;
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãƒ•ãƒ©ã‚°ä»˜ãé …ç›®ã‚’ãƒã‚§ãƒƒã‚¯
      let localDeletedItems = [];
      for (const year of Object.keys(events)) {
        const items = events[year] || [];
        for (const item of items) {
          if (item.deleted === true) {
            localDeletedItems.push({ year, label: item.label, deleted: item.deleted });
          }
        }
      }
      
      console.log('åŒæœŸé–‹å§‹ - ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿:', remoteData);
      console.log('åŒæœŸé–‹å§‹ - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿:', events);
      console.log('åŒæœŸé–‹å§‹ - ãƒ­ãƒ¼ã‚«ãƒ«å‰Šé™¤ãƒ•ãƒ©ã‚°ä»˜ãé …ç›®:', localDeletedItems);
      console.log('åŒæœŸé–‹å§‹ - ãƒªãƒ¢ãƒ¼ãƒˆeraSettings:', remoteEraSettings);
      console.log('åŒæœŸé–‹å§‹ - ãƒ­ãƒ¼ã‚«ãƒ«eraSettings:', eraSettings);
      console.log('åŒæœŸé–‹å§‹ - ãƒªãƒ¢ãƒ¼ãƒˆSHA:', remoteSha);
      console.log('åŒæœŸé–‹å§‹ - ãƒªãƒ¢ãƒ¼ãƒˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—:', timestamp);

      // 2. è¦æ³¨æ„ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
      const cautionMode = isCautionMode(timestamp);
      console.log('åŒæœŸãƒ¢ãƒ¼ãƒ‰:', cautionMode ? 'è¦æ³¨æ„ãƒ¢ãƒ¼ãƒ‰' : 'é€šå¸¸ãƒ¢ãƒ¼ãƒ‰');

      // 3. é †åºå¤‰æ›´ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
      const localData = events;
      let mergeResult;
      
      if (getOrderChanged()) {
        // é †åºå¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®é †åºã‚’å¼·åˆ¶åæ˜ ã—ã¦ãƒ•ãƒ©ã‚°ã‚’ã‚ªãƒ•
        console.log('é †åºå¤‰æ›´ãŒæ¤œå‡ºã•ã‚ŒãŸãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®é †åºã‚’å¼·åˆ¶åæ˜ ');
        setOrderChanged(false); // ãƒ•ãƒ©ã‚°ã‚’ã‚ªãƒ•
        mergeResult = { merged: localData, conflicts: [] };
      } else if (cautionMode) {
        // è¦æ³¨æ„ãƒ¢ãƒ¼ãƒ‰ã§ã®åŒæœŸå‡¦ç†
        mergeResult = performCautionModeSync(localData, remoteData);
      } else {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã®åŒæœŸå‡¦ç†
        mergeResult = performNormalModeSync(localData, remoteData);
      }
      
      const merged = mergeResult.merged;
      const conflicts = mergeResult.conflicts;

      // ãƒãƒ¼ã‚¸å¾Œãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãƒ•ãƒ©ã‚°ä»˜ãé …ç›®ã‚’ãƒã‚§ãƒƒã‚¯
      let mergedDeletedItems = [];
      for (const year of Object.keys(merged)) {
        const items = merged[year] || [];
        for (const item of items) {
          if (item.deleted === true) {
            mergedDeletedItems.push({ year, label: item.label, deleted: item.deleted });
          }
        }
      }
      
      console.log('åŒæœŸå®Œäº† - ãƒãƒ¼ã‚¸å¾Œãƒ‡ãƒ¼ã‚¿:', merged);
      console.log('åŒæœŸå®Œäº† - ãƒãƒ¼ã‚¸å¾Œå‰Šé™¤ãƒ•ãƒ©ã‚°ä»˜ãé …ç›®:', mergedDeletedItems);
      console.log('åŒæœŸå®Œäº† - ç«¶åˆæƒ…å ±:', conflicts);
      console.log('ãƒãƒ¼ã‚¸å¾Œãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:', JSON.stringify(merged).length, 'bytes');

      // 3. eraSettingsã®ãƒãƒ¼ã‚¸å‡¦ç†ï¼ˆè¦ä»¶æº–æ‹ ï¼‰
      console.log('eraSettingsåŒæœŸå‰:', { 
        local: eraSettings, 
        localLength: eraSettings ? eraSettings.length : 0,
        windowEraSettings: window.eraSettings,
        windowLength: window.eraSettings ? window.eraSettings.length : 0,
        remote: remoteEraSettings, 
        remoteLength: remoteEraSettings.length 
      });
      
      // ä»•æ§˜:
      // ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚ã‚‹æ™‚ä»£åŒºåˆ†åãŒãƒªãƒ¢ãƒ¼ãƒˆã«ã‚ã‚Œã°ã€ãƒªãƒ¢ãƒ¼ãƒˆã®ãã®æ™‚ä»£åŒºåˆ†ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ä¸Šæ›¸ã
      // ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚ã‚‹ãŒãƒªãƒ¢ãƒ¼ãƒˆã«ãªã„æ™‚ä»£åŒºåˆ†ã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿æŒã€ãƒªãƒ¢ãƒ¼ãƒˆã«ä¿å­˜ã—ãªã„ï¼‰
      // ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ã«ãªã„æ™‚ä»£åŒºåˆ†ã§ãƒªãƒ¢ãƒ¼ãƒˆã«ã‚ã‚‹ã‚‚ã®ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã¸å–ã‚Šè¾¼ã¿
      const localBase = (window.eraSettings && window.eraSettings.length > 0) ? window.eraSettings : (eraSettings || []);
      const remoteBase = remoteEraSettings || [];
      const nameToRemote = new Map(remoteBase.map(e => [String(e.name||''), e]));
      const nameToLocal  = new Map(localBase.map(e => [String(e.name||''), e]));
      const mergedEraSettings = [];
      const toSaveEraSettings = []; // ãƒªãƒ¢ãƒ¼ãƒˆã«ä¿å­˜ã™ã‚‹æ™‚ä»£åŒºåˆ†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã«ãªã„ãƒªãƒ¢ãƒ¼ãƒˆåˆ†ã®ã¿ï¼‰
      const seen = new Set();
      // ãƒ­ãƒ¼ã‚«ãƒ«åŸºæº–ã«åæ˜ ï¼ˆä¸Šæ›¸ã or ãã®ã¾ã¾ï¼‰
      for (const loc of localBase){
        const key = String(loc.name||'');
        if (!key){ continue; }
        if (nameToRemote.has(key)){
          // åŒåãŒã‚ã‚Œã°ã€ãƒªãƒ¢ãƒ¼ãƒˆã®é …ç›®ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®å€¤ã§ä¸Šæ›¸ãï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å„ªå…ˆï¼‰
          const remoteEra = nameToRemote.get(key);
          const mergedEra = { ...remoteEra, ...loc };
          mergedEraSettings.push(mergedEra);
          toSaveEraSettings.push(mergedEra); // ãƒªãƒ¢ãƒ¼ãƒˆã«ä¿å­˜
        } else {
          // ãƒªãƒ¢ãƒ¼ãƒˆã«ç„¡ã„æ™‚ä»£åŒºåˆ†ã¯ãã®ã¾ã¾ä¿æŒ
          mergedEraSettings.push(loc);
          // ãƒªãƒ¢ãƒ¼ãƒˆã«ä¿å­˜ã—ãªã„ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ä¿æŒï¼‰
        }
        seen.add(key);
      }
      // ãƒ­ãƒ¼ã‚«ãƒ«ã«ãªã„ãŒãƒªãƒ¢ãƒ¼ãƒˆã«ã‚ã‚‹åˆ†ã‚’è¿½åŠ 
      for (const rem of remoteBase){
        const key = String(rem.name||'');
        if (!key || seen.has(key)) continue;
        mergedEraSettings.push(rem);
        toSaveEraSettings.push(rem); // ãƒªãƒ¢ãƒ¼ãƒˆã«ä¿å­˜
      }
      console.log('eraSettingsåŒæœŸå¾Œ:', { 
        merged: mergedEraSettings, 
        mergedLength: mergedEraSettings.length 
      });

      // 4. ãƒãƒ¼ã‚¸ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆæœŸå¾…ã™ã‚‹SHAã‚’æŒ‡å®šï¼‰
      console.log('GitHubã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...');
      const dataToSave = {
        events: merged,
        eraSettings: toSaveEraSettings, // ãƒªãƒ¢ãƒ¼ãƒˆã«ä¿å­˜ã™ã‚‹ã®ã¯åŒåä¸Šæ›¸ãåˆ†ã¨æ–°è¦å–ã‚Šè¾¼ã¿åˆ†ã®ã¿
        genres: GENRES.map(code=>({code, label: (GENRE_LABELS && GENRE_LABELS[code]) ? GENRE_LABELS[code] : code}))
      };
      console.log('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ :', {
        hasEvents: !!dataToSave.events,
        eventsKeys: Object.keys(dataToSave.events || {}),
        hasEraSettings: !!dataToSave.eraSettings,
        eraSettingsLength: dataToSave.eraSettings.length,
        eraSettingsContent: dataToSave.eraSettings
      });
      const success = await saveToGitHub(dataToSave, remoteSha);
      if (success) {
        events = merged;
        
        // eraSettingsã‚’ç¢ºå®Ÿã«ãƒ­ãƒ¼ã‚«ãƒ«ã«åæ˜ 
        eraSettings = mergedEraSettings;
        window.eraSettings = mergedEraSettings;
        
        console.log('åŒæœŸå®Œäº†å¾Œã®eraSettings:', eraSettings);
        console.log('åŒæœŸå®Œäº†å¾Œã®window.eraSettings:', window.eraSettings);
        
        saveEvents();
        console.log('saveEventså¾Œã®eraSettingsç¢ºèª:', eraSettings);
        renderEvents();
        renderEraBackgrounds();
        
        // ã‚¸ãƒ£ãƒ³ãƒ«ãŒæ›´æ–°ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ãƒ•ã‚£ãƒ«ã‚¿é¸æŠã‚’å…¨é¸æŠã«ãƒªã‚»ãƒƒãƒˆ
        if (window.selectedGenres) { selectedGenres = new Set(GENRES); }
        if (typeof updateGenreFilterButtonText === 'function') { updateGenreFilterButtonText(); }
        
        // åŒæœŸå®Œäº†æ™‚åˆ»ã‚’è¨˜éŒ²
        localStorage.setItem('lastSync', new Date().toISOString());
        lastSavedEventsData = JSON.stringify(events); // è‡ªå‹•ä¿å­˜ã®åŸºæº–ã‚’æ›´æ–°
        updateSyncStatus();
        
        // ãƒ‡ãƒ¼ã‚¿é®®åº¦æ™‚åˆ»ã‚’æ›´æ–°
        setDataFreshnessTimestamp(timestamp);
        
        // ç·¨é›†ãƒ•ãƒ©ã‚°ãƒ»å‰Šé™¤è¨˜éŒ²ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢
        clearEditFlags();
        clearDeletionRecords();
        clearLabelBackups();
        
        // ç«¶åˆãŒã‚ã£ãŸå ´åˆã¯ç«¶åˆé€šçŸ¥ã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°é€šå¸¸ã®å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (conflicts.length > 0) {
          showConflictNotification(conflicts);
        } else {
          showInfo('åŒæœŸå®Œäº†', 'GitHubã¨ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
        }
        console.log('åŒæœŸå‡¦ç†å®Œäº†');
      } else {
        console.log('GitHubã¸ã®ä¿å­˜ã«å¤±æ•—');
      }
    } catch (error) {
      console.error('åŒæœŸã‚¨ãƒ©ãƒ¼ã®è©³ç´°:', error);
      
      // ç«¶åˆã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è©³ç´°ãªç«¶åˆæƒ…å ±ã‚’è¡¨ç¤º
      if (error instanceof ConflictError) {
        showConflictNotification(error.conflicts);
        return;
      }
      
      showError('åŒæœŸã‚¨ãƒ©ãƒ¼', `åŒæœŸå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
    }
  }
  
  // GitHubã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã¨SHAãƒãƒƒã‚·ãƒ¥ã‚’åŒæ™‚ã«å–å¾—
  async function loadFromGitHubWithSha() {
    if (!githubConfig.accessToken) {
      // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›
      const hasData = Object.keys(events).length > 0;
      if (hasData) {
        const result = confirm('GitHubã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nå¤‰æ›´ã•ã‚ŒãŸé …ç›®ã®ã¿ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã€ç®¡ç†è€…ã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\nã€ŒOKã€: CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€: ä½•ã‚‚ã—ãªã„');
        if (result) {
          exportToCSV();
        }
      } else {
        showError('è¨­å®šã‚¨ãƒ©ãƒ¼', 'GitHubã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚GitHubã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
      }
      return { remoteData: null, remoteSha: null, remoteEraSettings: [], timestamp: null };
    }

    try {
      const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filePath}`, {
        headers: {
          'Authorization': `Bearer ${githubConfig.accessToken}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });

      if (!response.ok) {
        if (response.status === 404) {
          // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
          return { remoteData: {}, remoteSha: null, remoteEraSettings: [] };
        }
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const responseData = await response.json();
      const sha = responseData.sha;
      
      // GitHub APIã®Base64ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ããƒ‡ã‚³ãƒ¼ãƒ‰
      const binaryString = atob(responseData.content);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      const content = new TextDecoder('utf-8').decode(bytes);
      const data = JSON.parse(content);
      
      // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—
      const timestamp = responseData.last_modified || new Date().toISOString();
      
      // ã‚¸ãƒ£ãƒ³ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      if (data.genres) {
        setGenresFromRemote(data.genres);
        console.log('GitHubã‹ã‚‰ã‚¸ãƒ£ãƒ³ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°:', GENRES, GENRE_LABELS);
      }
      
      if (data.events) {
        // æ–°ã—ã„å½¢å¼ï¼ˆevents + eraSettingsï¼‰
        return { 
          remoteData: data.events, 
          remoteSha: sha, 
          remoteEraSettings: data.eraSettings || [],
          timestamp: timestamp
        };
      } else {
        // å¤ã„å½¢å¼ï¼ˆeventsã®ã¿ï¼‰
        return { 
          remoteData: data, 
          remoteSha: sha, 
          remoteEraSettings: [],
          timestamp: timestamp
        };
      }
    } catch (error) {
      showError('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', `GitHubã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
      return { remoteData: null, remoteSha: null, remoteEraSettings: [], timestamp: null };
    }
  }

  // è¨­å®šç”»é¢
  function showSettings() {
    console.log('showSettings called');
    const settingsHtml = `
      <h4>GitHubåŒæœŸè¨­å®š</h4>
      <p>ç®¡ç†è€…ã‹ã‚‰æä¾›ã•ã‚ŒãŸè¨­å®šæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px;">
          <strong>Personal Access Token:</strong><br>
          <small style="color: #666;">ç®¡ç†è€…ã‹ã‚‰æä¾›ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›</small><br>
          <input type="password" id="accessToken" value="${githubConfig.accessToken}" 
                 style="width: 100%; padding: 6px; margin-top: 4px;" 
                 placeholder="ç®¡ç†è€…ã‹ã‚‰æä¾›ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›" />
        </label>
        <label style="display: block; margin-bottom: 8px;">
          <strong>ãƒªãƒã‚¸ãƒˆãƒªæ‰€æœ‰è€…:</strong><br>
          <small style="color: #666;">é€šå¸¸ã¯ã€Œhortense667ã€</small><br>
          <input type="text" id="owner" value="${githubConfig.owner || 'hortense667'}" 
                 style="width: 100%; padding: 6px; margin-top: 4px;" 
                 placeholder="hortense667" />
        </label>
        <label style="display: block; margin-bottom: 8px;">
          <strong>ãƒªãƒã‚¸ãƒˆãƒªå:</strong><br>
          <small style="color: #666;">é€šå¸¸ã¯ã€Œnativemapã€</small><br>
          <input type="text" id="repo" value="${githubConfig.repo || 'nativemap'}" 
                 style="width: 100%; padding: 6px; margin-top: 4px;" 
                 placeholder="nativemap" />
        </label>
        <label style="display: block; margin-bottom: 8px;">
          <strong>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:</strong><br>
          <small style="color: #666;">é€šå¸¸ã¯ã€Œtimeline.jsonã€</small><br>
          <input type="text" id="filePath" value="${githubConfig.filePath || 'timeline.json'}" 
                 style="width: 100%; padding: 6px; margin-top: 4px;" 
                 placeholder="timeline.json" />
        </label>
        <div style="margin: 12px 0; padding: 8px; background: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 6px; font-size: 12px;">
          <strong>URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã®æŒ‡å®š:</strong><br>
          <code>?owner=ãƒ¦ãƒ¼ã‚¶ãƒ¼å&repo=ãƒªãƒã‚¸ãƒˆãƒªå&filePath=ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹</code><br>
          <small style="color: #666;">ä¾‹: ?owner=hortense667&repo=nativemap&filePath=timeline.json</small>
        </div>
      </div>
      <div style="margin: 16px 0; padding: 12px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px;">
        <h5>è¨­å®šæƒ…å ±ã«ã¤ã„ã¦:</h5>
        <p style="margin: 8px 0; font-size: 14px;">
          <strong>ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> ç®¡ç†è€…ï¼ˆhortense667ï¼‰ã‹ã‚‰æä¾›ã•ã‚ŒãŸè¨­å®šæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
          <strong>ç®¡ç†è€…:</strong> æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹å ´åˆã¯ã€<a href="https://github.com/settings/tokens" target="_blank">GitHub Personal Access Tokens</a>ã§ã€Œrepoã€ã‚¹ã‚³ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
        </p>
      </div>
      <div style="margin: 16px 0; padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
        <h5>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h5>
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
          <button class="btn" id="settingsLoadCsvBtn" title="CSV/TSVã‚’èª­ã¿è¾¼ã‚“ã§è¿½åŠ " onclick="settingsLoadCsv()">ãƒ­ãƒ¼ãƒ‰</button>
          <p style="margin: 0; font-size: 12px; color: #856404;">
            ãƒ­ãƒ¼ãƒ‰ã¯ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ç™»éŒ²ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚è©³ã—ã„ä½¿ã„æ–¹ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰ã‚’ã”è¦§ãã ã•ã„ã€‚æ–‡å­—ã‚³ãƒ¼ãƒ‰ã¯å¿…ãšã€ŒUTF-8ã€ã«ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€é€šå¸¸ã€timeline.jsonã¨ãªã£ã¦ã„ã‚‹ã€Œãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã€ã‚’timeline-test.jsonã«å¤‰æ›´ã—ã¦æ­£ã—ããƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¦ã‹ã‚‰timeline.jsonã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
          </p>
        </div>
        <p style="margin: 8px 0; font-size: 12px; color: #856404;">
          æ³¨æ„: ã“ã®æ“ä½œã¯ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€GitHubã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
        </p>
        <button class="btn" onclick="clearAllDataAndReload()" style="background: #dc3545; color: white; border-color: #dc3545;">
          è¡¨ç¤ºä¸­ã®å…¨ãƒ©ãƒ™ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¦GitHubã‹ã‚‰èª­ã¿è¾¼ã¿
        </button>
      </div>
      <div style="text-align: right; margin-top: 16px;">
        <button class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" onclick="saveSettings()" style="margin-left: 8px;">ä¿å­˜</button>
      </div>
    `;
    openModal('è¨­å®š', settingsHtml);
  }

  async function saveSettings() {
    const tokenInput = document.getElementById('accessToken');
    const ownerInput = document.getElementById('owner');
    const repoInput = document.getElementById('repo');
    const pathInput = document.getElementById('filePath');
    
    if (tokenInput && ownerInput && repoInput && pathInput) {
      const prevFilePath = githubConfig.filePath || 'timeline.json';
      githubConfig.accessToken = tokenInput.value.trim();
      githubConfig.owner = ownerInput.value.trim();
      githubConfig.repo = repoInput.value.trim();
      githubConfig.filePath = (pathInput.value.trim() || 'timeline.json');
      saveGitHubConfig();
      // URLã®filePathç­‰ã‚‚åŒæœŸ
      try{
        const params = new URLSearchParams(window.location.search);
        if(githubConfig.owner) params.set('owner', githubConfig.owner); else params.delete('owner');
        if(githubConfig.repo) params.set('repo', githubConfig.repo); else params.delete('repo');
        if(githubConfig.filePath) params.set('filePath', githubConfig.filePath); else params.delete('filePath');
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.replaceState(null, '', newUrl);
      }catch(e){ console.warn('URLæ›´æ–°ã«å¤±æ•—:', e); }
      const filePathChanged = prevFilePath !== githubConfig.filePath;
      closeModal();
      showInfo('è¨­å®šä¿å­˜', 'è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
    if (filePathChanged) {
      // URLã®filePathç­‰ã‚‚åŒæœŸ
      try{
        const params = new URLSearchParams(window.location.search);
        if(githubConfig.owner) params.set('owner', githubConfig.owner); else params.delete('owner');
        if(githubConfig.repo) params.set('repo', githubConfig.repo); else params.delete('repo');
        if(githubConfig.filePath) params.set('filePath', githubConfig.filePath); else params.delete('filePath');
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.replaceState(null, '', newUrl);
      }catch(e){ console.warn('URLæ›´æ–°ã«å¤±æ•—:', e); }
        try { await clearAllDataAndReload(); } catch (e) { console.error(e); }
      }
    }
  }

  // è¨­å®šç”»é¢å†…ã®ãƒ­ãƒ¼ãƒ‰å‡¦ç†
  async function settingsLoadCsv() {
    const pathInput = document.getElementById('filePath');
    const newPath = (pathInput && pathInput.value ? pathInput.value.trim() : '') || 'timeline.json';
    const prevFilePath = githubConfig.filePath || 'timeline.json';
    const filePathChanged = newPath !== prevFilePath;
    if (filePathChanged) {
      githubConfig.filePath = newPath;
      saveGitHubConfig();
      try { await clearAllDataAndReload(); } catch (e) { console.error(e); }
    }
    // æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ‰å‡¦ç†ï¼ˆCSV/TSVé¸æŠï¼‰
    const fileInputEl = document.getElementById('fileInput');
    if (fileInputEl) fileInputEl.click();
  }
  
  // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦GitHubã‹ã‚‰èª­ã¿è¾¼ã¿
  async function clearAllDataAndReload() {
    if (!confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦GitHubã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
      return;
    }
    
    try {
      // 1. ç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã¨ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã‚¯ãƒªã‚¢
      events = {};
      eraSettings = [];
      deletionRecords = [];
      labelBackups = {};
      editFlags = {};
      // localStorageã‹ã‚‰é–¢é€£ã‚­ãƒ¼ã‚’å‰Šé™¤
      try {
        localStorage.removeItem('timelineEventsV2');
        localStorage.removeItem('timelineEventsV1');
        localStorage.removeItem('autoSave');
        localStorage.removeItem('lastEdit');
        localStorage.removeItem('nativemap_deletions');
        localStorage.removeItem('nativemap_label_backups');
        localStorage.removeItem('nativemap_edit_flags');
        localStorage.removeItem('nativemap_data_freshness');
      } catch(e) { console.warn('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿å‰Šé™¤æ™‚ã®è­¦å‘Š:', e); }
      // UIã‚’å³åº§ã«ç©ºçŠ¶æ…‹ã¸
      renderEvents();
      if (typeof drawEraBackgrounds === 'function') { drawEraBackgrounds(); }
      // ãƒ•ã‚£ãƒ«ã‚¿ã¯å…¨é¸æŠã«åˆæœŸåŒ–
      if (window.selectedGenres) { selectedGenres = new Set(GENRES); }
      if (typeof updateGenreFilterButtonText === 'function') { updateGenreFilterButtonText(); }
      
      // 2. GitHubã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ãŒãªãã¦ã‚‚èª­ã¿è¾¼ã¿ï¼‰
      let remoteData = null;
      
      // ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ãªãã¦ã‚‚GitHubã‹ã‚‰èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
      console.log('GitHubã‹ã‚‰èª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³:', githubConfig.accessToken ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š', 'ï¼‰');
      
      try {
        // ã¾ãšGitHubã‹ã‚‰èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
        remoteData = await loadFromGitHubWithoutToken();
        console.log('GitHubã‹ã‚‰ã®èª­ã¿è¾¼ã¿æˆåŠŸ');
      } catch (e) {
        console.log('GitHubã‹ã‚‰ã®èª­ã¿è¾¼ã¿å¤±æ•—ã€åŸ‹ã‚è¾¼ã¿JSONã‹ã‚‰èª­ã¿è¾¼ã¿:', e.message);
        
        // GitHubã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸå ´åˆã¯åŸ‹ã‚è¾¼ã¿JSONã‹ã‚‰èª­ã¿è¾¼ã¿
        try {
          const eventsJsonElement = document.getElementById('events-json');
          if (!eventsJsonElement) {
            throw new Error('events-jsonè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
          
          // innerHTMLã‚’ä½¿ç”¨ã—ã¦ã‚ˆã‚Šå®‰å…¨ã«JSONã‚’å–å¾—
          const txt = eventsJsonElement.innerHTML.trim();
          console.log('åŸ‹ã‚è¾¼ã¿JSONãƒ†ã‚­ã‚¹ãƒˆé•·:', txt.length);
          console.log('åŸ‹ã‚è¾¼ã¿JSONãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€å¾Œã®50æ–‡å­—ï¼‰:', txt.slice(-50));
          
          // æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
          const lastChars = txt.slice(-10);
          console.log('æœ€å¾Œã®10æ–‡å­—ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰:', Array.from(lastChars).map(c => c.charCodeAt(0)));
          
          // å•é¡Œã®ã‚ã‚‹æ–‡å­—ã‚’ç‰¹å®š
          const problematicChars = txt.match(/[^\x20-\x7E\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g);
          if (problematicChars) {
            console.log('å•é¡Œã®ã‚ã‚‹æ–‡å­—:', problematicChars);
          }
          
          const embedded = JSON.parse(txt);
          console.log('åŸ‹ã‚è¾¼ã¿JSONè§£ææˆåŠŸ:', Object.keys(embedded).length, 'å€‹ã®å¹´');
          
          // ã‚¸ãƒ£ãƒ³ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
          if (embedded.genres) {
            setGenresFromRemote(embedded.genres);
            console.log('åŸ‹ã‚è¾¼ã¿JSONã‹ã‚‰ã‚¸ãƒ£ãƒ³ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿:', GENRES, GENRE_LABELS);
          }
          
          // æ™‚ä»£åŒºåˆ†ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
          if (embedded.eraSettings) {
            eraSettings = embedded.eraSettings;
            console.log('åŸ‹ã‚è¾¼ã¿JSONã‹ã‚‰æ™‚ä»£åŒºåˆ†ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿:', eraSettings.length, 'å€‹');
            // æ™‚ä»£åŒºåˆ†èƒŒæ™¯ã‚’å†æç”»
            if (typeof drawEraBackgrounds === 'function') {
              drawEraBackgrounds();
            }
          }
          
          const rawData = embedded.events ? embedded.events : embedded;
          console.log('ç”Ÿãƒ‡ãƒ¼ã‚¿å–å¾—:', Object.keys(rawData).length, 'å€‹ã®å¹´');
          
          remoteData = normalizeAll(rawData);
          console.log('ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–å®Œäº†:', Object.keys(remoteData).length, 'å€‹ã®å¹´');
        } catch (e2) {
          console.error('åŸ‹ã‚è¾¼ã¿JSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e2);
          console.error('ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:', e2.message);
          console.error('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', e2.stack);
          
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨
          console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨');
          const fallbackData = {
            "1952": [{"label":"ãƒ†ãƒ¬ãƒ“æ”¾é€é–‹å§‹"}],
            "1956": [{"label":"å›½ç”£åˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿"}],
            "1960": [{"label":"å›½é‰„äºˆç´„ã‚·ã‚¹ãƒ†ãƒ "},{"label":"ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚¾ãƒ¼ãƒ³"}],
            "1963": [{"label":"é‰„è…•ã‚¢ãƒˆãƒ "},{"label":"é‰„äºº28å·"}],
            "1966": [{"label":"ã‚¦ãƒ«ãƒˆãƒ©Q"},{"label":"ã‚µãƒ³ãƒ€ãƒ¼ãƒãƒ¼ãƒ‰"}],
            "1969": [{"label":"ä½å‹éŠ€è¡Œã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ã‚¹ãƒšãƒ³ã‚µ"},{"label":"ã‚¢ãƒãƒ­11å·ãƒ»æœˆç€é™¸"}],
            "1971": [{"label":"ä»®é¢ãƒ©ã‚¤ãƒ€ãƒ¼"}],
            "1973": [{"label":"ã€8æ™‚ã ãƒ§ï¼å…¨å“¡é›†åˆã€è¦–è´ç‡50%"}],
            "1977": [{"label":"Apple IIãªã©åˆæœŸãƒã‚¤ã‚³ãƒ³"}],
            "1978": [{"label":"ãƒã‚¤ã‚³ãƒ³å…¥ã‚Šè£½å“æ¬¡ã€…ç™»å ´"}],
            "1979": [{"label":"æ©Ÿå‹•æˆ¦å£«ã‚¬ãƒ³ãƒ€ãƒ "}],
            "1983": [{"label":"ä»»å¤©å ‚ãƒ•ã‚¡ãƒŸã‚³ãƒ³"}],
            "1984": [{"label":"ãƒ‰ãƒ©ã‚´ãƒ³ãƒœãƒ¼ãƒ«"}],
            "1986": [{"label":"PC-9801VM"},{"label":"ãƒ“ãƒ‡ã‚ªãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»AVãƒ“ãƒ‡ã‚ª"}],
            "1995": [{"label":"æ–°ä¸–ç´€ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³"},{"label":"GHOST IN THE SHELL æ”»æ®»æ©Ÿå‹•éšŠ"}],
            "1996": [{"label":"ãƒ‘ã‚½ã‚³ãƒ³é€šä¿¡æµè¡Œ"},{"label":"å¥³å­é«˜ç”Ÿã«ãƒã‚±ãƒ™ãƒ«ãƒ–ãƒ¼ãƒ "},{"label":"ãŸã¾ã”ã£ã¡"},{"label":"ãƒ›ãƒ³ãƒ€P2"}],
            "1999": [{"label":"iãƒ¢ãƒ¼ãƒ‰ãƒ»å†™ãƒ¡ãƒ¼ãƒ«"},{"label":"MATRIX"}],
            "2001": [{"label":"ãƒ¤ãƒ•ãƒ¼ï¼BBé–‹å§‹"}],
            "2005": [{"label":"YouTube"}],
            "2006": [{"label":"ã€ããã‚‹ã€ãŒæµè¡Œèªå¤§è³"}],
            "2007": [{"label":"é›»è„³ã‚³ã‚¤ãƒ«"}],
            "2010": [{"label":"iPhoneãƒ–ãƒ¬ãƒ¼ã‚¯"},{"label":"GAFAã®å½±éŸ¿åŠ›æ‹¡å¤§"}],
            "2016": [{"label":"DJI Phantom 4ï¼ãƒ‰ãƒ­ãƒ¼ãƒ³"}],
            "2018": [{"label":"Ready Player One"}],
            "2020": [{"label":"VRï¼ãƒ¡ã‚¿ãƒãƒ¼ã‚¹æ³¨ç›®"}],
            "2022": [{"label":"ChatGPTï¼ç”ŸæˆAI"}],
            "2023": [{"label":"Web3"}]
          };
          remoteData = normalizeAll(fallbackData);
          console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–å®Œäº†:', Object.keys(remoteData).length, 'å€‹ã®å¹´');
        }
      }
      
      console.log('remoteDataã®çŠ¶æ…‹:', remoteData);
      
      if (remoteData !== null && remoteData !== undefined) {
        console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸã€ã‚¤ãƒ™ãƒ³ãƒˆæ•°:', Object.keys(remoteData).length);
        events = remoteData;
        saveEvents();
        renderEvents();
        // ã‚¸ãƒ£ãƒ³ãƒ«ãŒæ›´æ–°ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ãƒ•ã‚£ãƒ«ã‚¿é¸æŠã‚’å…¨é¸æŠã«ãƒªã‚»ãƒƒãƒˆ
        if (window.selectedGenres) { selectedGenres = new Set(GENRES); }
        if (typeof updateGenreFilterButtonText === 'function') { updateGenreFilterButtonText(); }
        // æ™‚ä»£åŒºåˆ†èƒŒæ™¯ã‚’å†æç”»
        if (typeof drawEraBackgrounds === 'function') {
          drawEraBackgrounds();
        }
        
        // åŒæœŸå®Œäº†æ™‚åˆ»ã‚’è¨˜éŒ²
        localStorage.setItem('lastSync', new Date().toISOString());
        lastSavedEventsData = JSON.stringify(events);
        updateSyncStatus();
        
        // ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
        clearEditFlags();
        
        const source = githubConfig.accessToken ? 'GitHub API' : 'GitHub raw file';
        showInfo('ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†', `${source}ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
      } else {
        console.error('remoteDataãŒnullã¾ãŸã¯undefinedã§ã™');
        showError('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    } catch (error) {
      showError('ã‚¨ãƒ©ãƒ¼', `ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
    }
  }
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
  window.saveSettings = saveSettings;
  window.settingsLoadCsv = settingsLoadCsv;
  window.clearAllDataAndReload = clearAllDataAndReload;

  // åŒæœŸçŠ¶æ…‹ã®è¡¨ç¤º
  function updateSyncStatus() {
    const lastSync = localStorage.getItem('lastSync');
    const lastEdit = localStorage.getItem('lastEdit');
    
    if (lastEdit && lastEdit > lastSync) {
      // æœªåŒæœŸã®å¤‰æ›´ãŒã‚ã‚‹
      syncBtn.style.background = '#ffeb3b';
      syncBtn.style.color = '#000';
      syncBtn.title = 'æœªåŒæœŸã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ - ã‚¯ãƒªãƒƒã‚¯ã—ã¦åŒæœŸ';
    } else {
      // åŒæœŸæ¸ˆã¿
      syncBtn.style.background = '#4caf50';
      syncBtn.style.color = '#fff';
      syncBtn.title = 'åŒæœŸæ¸ˆã¿';
    }
  }

  // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½
  function autoSave() {
    try {
      const currentEvents = JSON.stringify(events);
      if (currentEvents !== lastSavedEventsData) {
        localStorage.setItem('autoSave', currentEvents);
        localStorage.setItem('lastEdit', new Date().toISOString());
        lastSavedEventsData = currentEvents;
        updateSyncStatus();
      }
    } catch (e) {
      console.error('è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  // 5ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜
  setInterval(autoSave, 5000);

  // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹æ™‚ã®ç¢ºèª
  function checkUnsavedChanges() {
    const lastSync = localStorage.getItem('lastSync');
    const lastEdit = localStorage.getItem('lastEdit');
    
    if (lastEdit && lastSync && lastEdit > lastSync) {
      return 'æœªåŒæœŸã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚\n\nãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹å‰ã«åŒæœŸã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚\n\næœ¬å½“ã«ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã¾ã™ã‹ï¼Ÿ';
    }
    return null;
  }

  // beforeunloadã‚¤ãƒ™ãƒ³ãƒˆã§ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹å‰ã®ç¢ºèª
  window.addEventListener('beforeunload', function(e) {
    const message = checkUnsavedChanges();
    if (message) {
      e.preventDefault();
      e.returnValue = message;
      return message;
    }
  });

  // åˆæœŸåŒ–æ™‚ã«åŒæœŸçŠ¶æ…‹ã‚’æ›´æ–°
  updateSyncStatus();
  
  // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«å¹´é½¢è¡¨ç¤ºã®ä½ç½®ã‚’å†èª¿æ•´
  window.addEventListener('resize', updateAgeDisplayPosition);
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã®å†…å®¹å¤‰æ›´ã‚’ç›£è¦–ã—ã¦å¹´é½¢è¡¨ç¤ºã®ä½ç½®ã‚’å†èª¿æ•´
  const header = document.querySelector('header');
  if (header) {
    const observer = new MutationObserver(() => {
      // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰ä½ç½®ã‚’èª¿æ•´ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå®Œäº†ã—ã¦ã‹ã‚‰ï¼‰
      setTimeout(updateAgeDisplayPosition, 10);
    });
    observer.observe(header, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['style', 'class']
    });
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  syncBtn.addEventListener('click', async () => {
    await syncWithConfirmation();
  });
  settingsBtn.addEventListener('click', function() {
    console.log('Settings button clicked');
    showSettings();
  });

  // åˆæœŸåŒ–æ™‚ã«è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆæ—¢ã«ä¸Šã§å®Ÿè¡Œæ¸ˆã¿ï¼‰

  // ===== CSV/TSV ãƒ­ãƒ¼ãƒ‰ =====
  function detectDelim(sample){ const cntTab=(sample.match(/\t/g)||[]).length; const cntSemi=(sample.match(/;/g)||[]).length; const cntComma=(sample.match(/,/g)||[]).length; const arr=[["\t",cntTab],[";",cntSemi],[",",cntComma]].sort((a,b)=>b[1]-a[1]); return arr[0][1]>0 ? arr[0][0] : ';'; }
  fileInput.addEventListener('change', async (e)=>{ const f=e.target.files && e.target.files[0]; if(!f) return; const text = await f.text(); const {addedCount, errors} = importSeparatedText(text); if(errors.length){ const summary = `æ­£å¸¸ã«è¿½åŠ : ${addedCount} ä»¶`; showError('CSV/TSVèª­è¾¼ã‚¨ãƒ©ãƒ¼', [summary, ...errors]); } else if(addedCount>0){ saveEvents(); renderEvents(); showInfo('èª­ã¿è¾¼ã¿å®Œäº†', `${addedCount} ä»¶ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`); } else { showInfo('çµæœ', 'è¿½åŠ ã•ã‚ŒãŸé …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); } if(addedCount>0){ saveEvents(); renderEvents(); } fileInput.value=''; });

  function importSeparatedText(text){
    const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/);
    let firstNonEmpty = lines.find(l=>l.trim().length>0) || '';
    const delim = detectDelim(firstNonEmpty);
    let addedCount=0; const errors=[];
    const seen=buildLabelGenreSet();
    for(let i=0;i<lines.length;i++){
      const raw=lines[i].trim(); 
      // æ”¹è¡Œã®ã¿ã®è¡Œã¨ã€Œ#ã€ã§å§‹ã¾ã‚‹è¡Œã‚’ç„¡è¦–
      if(!raw || raw.startsWith('#')) continue;
      const cols=raw.split(delim);
      if(i===0 && /å¹´/.test(cols[0])) continue;
      if(cols.length<3){ errors.push(`${i+1}è¡Œç›®: åˆ—æ•°ä¸è¶³ï¼ˆé–‹å§‹å¹´${delim}çµ‚äº†å¹´${delim}ãƒ©ãƒ™ãƒ«${delim}ã‚¸ãƒ£ãƒ³ãƒ«${delim}é‡è¦åº¦${delim}URL${delim}æ³¨é‡ˆï¼‰`); continue; }
      const startYearStr=(cols[0]||'').trim();
      const endYearStr=(cols[1]||'').trim();
      const label=(cols[2]||'').trim();
      const genreStr=(cols[3]||'').trim();
      const impStr=(cols[4]||'').trim();
      const url=(cols[5]||'').trim();
      const note=(cols[6]||'').trim();
      
      // é–‹å§‹å¹´ã®æ¤œè¨¼
      if(startYearStr && !(startYearStr.match(/^\d{4}$/) && parseInt(startYearStr,10)>=YEAR_MIN && parseInt(startYearStr,10)<=YEAR_MAX)){
        errors.push(`${i+1}è¡Œç›®: é–‹å§‹å¹´ãŒä¸æ­£ã¾ãŸã¯ç¯„å›²å¤–ï¼ˆ${startYearStr}ï¼‰`); continue;
      }
      
      // çµ‚äº†å¹´ã®æ¤œè¨¼ï¼ˆã€Œongoingã€ã‚‚è¨±å¯ï¼‰
      if(endYearStr && endYearStr.toLowerCase() !== 'ongoing' && !(endYearStr.match(/^\d{4}$/) && parseInt(endYearStr,10)>=YEAR_MIN && parseInt(endYearStr,10)<=YEAR_MAX)){
        errors.push(`${i+1}è¡Œç›®: çµ‚äº†å¹´ãŒä¸æ­£ã¾ãŸã¯ç¯„å›²å¤–ï¼ˆ${endYearStr}ï¼‰`); continue;
      }
      
      // é–‹å§‹å¹´ã¨çµ‚äº†å¹´ã®é–¢ä¿‚æ€§æ¤œè¨¼ï¼ˆã€Œongoingã€ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      if(startYearStr && endYearStr && endYearStr.toLowerCase() !== 'ongoing' && parseInt(startYearStr,10) > parseInt(endYearStr,10)){
        errors.push(`${i+1}è¡Œç›®: é–‹å§‹å¹´ãŒçµ‚äº†å¹´ã‚ˆã‚Šå¾Œã«ãªã£ã¦ã„ã¾ã™ï¼ˆ${startYearStr} > ${endYearStr}ï¼‰`); continue;
      }
      
      if(!label){ errors.push(`${i+1}è¡Œç›®: ãƒ©ãƒ™ãƒ«ãŒç©ºã§ã™`); continue; }
      const genres = genreStr ? genreStr.split('ãƒ»').map(g => g.trim().toUpperCase()) : [];
      const genreKey = genres.length > 0 ? genres.map(g=>String(g).toUpperCase()).sort().join('ãƒ»') : '';
      const key = `${label}|${genreKey}`;
      // å‹•çš„ã‚¸ãƒ£ãƒ³ãƒ«: ä¸æ­£ãƒã‚§ãƒƒã‚¯ã¯è¡Œã‚ãšã€ãã®ã¾ã¾å—ã‘å…¥ã‚Œ
      if(impStr){ const n=parseInt(impStr,10); if(!(n>=1 && n<=5)){ errors.push(`${i+1}è¡Œç›®: ä¸æ­£ãªé‡è¦åº¦ï¼ˆ${impStr}ï¼‰`); continue; } }
      
      // ã‚¢ã‚¤ãƒ†ãƒ ã®å¹´ã‚’æ±ºå®šï¼ˆé–‹å§‹å¹´ãŒã‚ã‚Œã°é–‹å§‹å¹´ã€ãªã‘ã‚Œã°çµ‚äº†å¹´ã€ã©ã¡ã‚‰ã‚‚ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ï¼‰
      let itemYear;
      if(startYearStr) {
        itemYear = parseInt(startYearStr,10);
      } else if(endYearStr && endYearStr.toLowerCase() !== 'ongoing') {
        itemYear = parseInt(endYearStr,10);
      } else if(endYearStr && endYearStr.toLowerCase() === 'ongoing') {
        // ongoingã®å ´åˆã¯é–‹å§‹å¹´ãŒå¿…è¦
        if(!startYearStr) {
          errors.push(`${i+1}è¡Œç›®: çµ‚äº†å¹´ãŒã€Œongoingã€ã®å ´åˆã¯é–‹å§‹å¹´ãŒå¿…è¦ã§ã™`); continue;
        }
        itemYear = parseInt(startYearStr,10);
      } else {
        errors.push(`${i+1}è¡Œç›®: é–‹å§‹å¹´ã¾ãŸã¯çµ‚äº†å¹´ã®ã„ãšã‚Œã‹ãŒå¿…è¦ã§ã™`); continue;
      }
      
      const item={ label }; 
      if(startYearStr) item.startYear=parseInt(startYearStr,10); 
      if(endYearStr) {
        if(endYearStr.toLowerCase() === 'ongoing') {
          item.endYear = 'ongoing';
        } else {
          item.endYear = parseInt(endYearStr,10);
        }
      } 
      if(genres.length > 0) item.genre=genres; 
      if(impStr) item.imp=parseInt(impStr,10); 
      if(url) item.url=url; 
      if(note) item.note=note;
      
      const deletedCol = (cols[7]||'').trim().toLowerCase();
      const isDeleted = deletedCol === 'true';

      if(!events[itemYear]) events[itemYear]=[]; 

      // æ—¢å­˜ã®åŒä¸€ã‚­ãƒ¼ï¼ˆé–‹å§‹å¹´ãƒ»ãƒ©ãƒ™ãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ä¸€è‡´ï¼‰ã‚’æ¤œç´¢
      const sameKey = (it)=>{
        const gA = Array.isArray(it.genre) ? it.genre.slice().map(g=>String(g).toUpperCase()).sort().join('ãƒ»') : (it.genre||'');
        return (it.label||'')===label && gA===genreKey && Number(it.startYear||itemYear)===Number(itemYear);
      };
      const arr = events[itemYear];
      const idx = arr.findIndex(sameKey);
      if(isDeleted){
        // (2) deleted=true ã®å ´åˆã¯è©²å½“é …ç›®ã‚’å‰Šé™¤
        if(idx!==-1){ arr.splice(idx,1); }
        // ãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰ã‚‚é™¤å»ã•ã‚Œã‚‹ã‚ˆã† tombstone ã‚’è¨˜éŒ²
        try{ addDeletionRecord(itemYear, { startYear: itemYear, label, genre: (genres.length>0? genres : genreKey) }); }catch(_e){}
      } else {
        // (1) åŒä¸€ã‚­ãƒ¼ãŒã‚ã‚Œã°ä¸Šæ›¸ãã€ãªã‘ã‚Œã°è¿½åŠ 
        if(idx!==-1){ arr[idx] = item; } else { arr.push(item); }
        // seen ã¯é‡è¤‡æ¤œå‡ºç”¨ã€‚ã“ã“ã§ã¯ä¸Šæ›¸ãå¯¾è±¡ã‚‚æ—¢å­˜æ‰±ã„ã«ã™ã‚‹
        seen.add(key);
        addedCount++;
      }
    }
    return {addedCount, errors};
  }

  // ===== ç©ºå¹´ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ã‚’é–‹ã =====
  function openEditorForEmptyYearAt(xCSS,yCSS){ const rect=stage.getBoundingClientRect(); const scale=1; const x=(xCSS-rect.left)/scale; const y=(yCSS-rect.top)/scale; if(x >= ORIGIN_X - HANDLE_LANE_W) return; const year = YEAR_MIN + Math.round((y-ORIGIN_Y)/PX_PER_YEAR); if(year<YEAR_MIN||year>YEAR_MAX) return; showEditModal(year, -1, { label: '', startYear: year, endYear: '' }); }
  stage.addEventListener('click', (e)=>{ if(e.target && e.target.tagName && e.target.tagName.toLowerCase()==='text') return; openEditorForEmptyYearAt(e.clientX, e.clientY); });

  // ===== ãƒ—ãƒ­ãƒ¼ãƒ– =====
  function makeProbe(color){
    const g=document.getElementById('probe-'+color);
    const state={eventYear:color==='blue'?1983:1999,birthYear:color==='blue'?1970:1964};
    const stroke=(color==='red'?'#ff3333':'#4da3ff');
    const eventLine=lineEl(ORIGIN_X,0,ORIGIN_X,0); eventLine.style.stroke=stroke; eventLine.style.strokeWidth=3; // æ°´å¹³ï¼ˆäº¤ç‚¹ã¾ã§ï¼‰
    const vLine=lineEl(0,0,0,ORIGIN_Y);           vLine.style.stroke=stroke; vLine.style.strokeWidth=3; vLine.setAttribute('pointer-events','stroke');
    const diag=lineEl(0,0,0,0);                    diag.style.stroke=stroke;  diag.style.strokeWidth=3; // å·¦ä¸Šæ–œã‚
    const eh=circleEl(HANDLE_X,0,8,'handle');      eh.setAttribute('stroke',stroke); eh.setAttribute('fill','#fff');
    const bh=circleEl(HANDLE_X,0,8,'handle');      bh.setAttribute('stroke',stroke); bh.setAttribute('fill','#fff');
    // å¹´é½¢è¡¨ç¤ºã‚’å›ºå®šä½ç½®ã®HTMLè¦ç´ ã¨ã—ã¦ä½œæˆ
    const ageTextElement = document.createElement('div');
    ageTextElement.style.cssText = `
      position: fixed;
      top: 78px;
      left: 0;
      font-size: 18px;
      font-weight: 700;
      color: #000;
      pointer-events: none;
      z-index: 101;
      display: none;
    `;
    ageTextElement.id = `age-text-${color}`;
    document.body.appendChild(ageTextElement);
    
    const ageText=textEl('',0,0,'ageTickText'); // SVGè¦ç´ ã¯éè¡¨ç¤ºã«ã™ã‚‹
    const eventYearText=textEl('', ORIGIN_X+8, 0, 'ageTickText'); eventYearText.style.fontSize='14px'; eventYearText.style.fill=stroke; eventYearText.setAttribute('text-anchor','start');
    const birthYearText=textEl('', ORIGIN_X+8, 0, 'ageTickText'); birthYearText.style.fontSize='14px'; birthYearText.style.fill=stroke; birthYearText.setAttribute('text-anchor','start');

    g.append(eventLine,vLine,diag,eh,bh,ageText,eventYearText,birthYearText);

    function redraw(){
      const yE=yFromBirthYear(state.eventYear);
      const yB=yFromBirthYear(state.birthYear);
      const age=Math.max(0,Math.min(AGE_MAX,state.eventYear-state.birthYear));
      const ix=xFromAge(age);
      eventLine.setAttribute('y1',yE);eventLine.setAttribute('y2',yE); eventLine.setAttribute('x1',ORIGIN_X);eventLine.setAttribute('x2',ix);
      vLine.setAttribute('x1',ix);vLine.setAttribute('x2',ix);vLine.setAttribute('y1',yE);vLine.setAttribute('y2',ORIGIN_Y);
      const tMax=Math.max(0,Math.min((ix-ORIGIN_X)/PX_PER_AGE,(yE-ORIGIN_Y)/PX_PER_YEAR));
      diag.setAttribute('x1',ix);diag.setAttribute('y1',yE); diag.setAttribute('x2',ix-PX_PER_AGE*tMax);diag.setAttribute('y2',yE-PX_PER_YEAR*tMax);
      eh.setAttribute('cx',HANDLE_X);eh.setAttribute('cy',yE);
      bh.setAttribute('cx',HANDLE_X);bh.setAttribute('cy',yB);
      // HTMLè¦ç´ ã®å¹´é½¢è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆç·šã®å³å´ã«è¡¨ç¤ºï¼‰
      ageTextElement.textContent = `${age}æ­³`;
      ageTextElement.style.left = `${ix + 10}px`;
      ageTextElement.style.display = 'block';
      
      // å¹´é½¢è¡¨ç¤ºã®ä½ç½®ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã«å¿œã˜ã¦èª¿æ•´
      updateAgeDisplayPosition();
      
      // SVGè¦ç´ ã¯éè¡¨ç¤º
      ageText.textContent = '';
      eventYearText.textContent = `${state.eventYear}å¹´`;
      eventYearText.setAttribute('x', ORIGIN_X+8);
      eventYearText.setAttribute('y', yE-6);
      const yAtAxis = yE - age*PX_PER_YEAR; const by = Math.round((yAtAxis - ORIGIN_Y)/PX_PER_YEAR) + YEAR_MIN;
      birthYearText.textContent = `${by}å¹´ç”Ÿ`;
      birthYearText.style.fill = '#000'; // ç”Ÿå¹´è¡¨ç¤ºã‚’é»’è‰²ã«
      birthYearText.setAttribute('x', ORIGIN_X+8);
      birthYearText.setAttribute('y', yAtAxis-6);
    }

    function startDrag(){ document.body.classList.add('dragging'); }
    function endDrag(){ document.body.classList.remove('dragging'); }
    function dragByYear(el,prop){ let dragging=false, startY=0, startVal=0; el.addEventListener('mousedown',e=>{ dragging=true; startY=e.clientY; startVal=state[prop]; startDrag(); e.preventDefault(); e.stopPropagation(); }); window.addEventListener('mousemove',e=>{ if(!dragging) return; const dy=e.clientY-startY; const dYear=Math.round(dy/PX_PER_YEAR); state[prop]=Math.max(YEAR_MIN,Math.min(YEAR_MAX,startVal+dYear)); redraw(); }); window.addEventListener('mouseup',()=>{ if(dragging){ dragging=false; endDrag(); } }); }
    dragByYear(eh,'eventYear'); dragByYear(bh,'birthYear'); dragByYear(vLine,'birthYear');

    state.redraw=redraw; redraw(); return state;
  }

  const probeBlue=makeProbe('blue');
  const probeRed=makeProbe('red');

  // ãƒ©ã‚¤ãƒ³è¡¨ç¤ºãƒˆã‚°ãƒ«ï¼ˆå°ä¸¸ãƒœã‚¿ãƒ³ï¼‰
  const blueGroup=document.getElementById('probe-blue');
  const redGroup =document.getElementById('probe-red');
  const toggleBlueBtn=document.getElementById('toggleBlue');
  const toggleRedBtn =document.getElementById('toggleRed');
  function setToggle(btn, group, on){ group.style.display = on ? '' : 'none'; btn.setAttribute('aria-pressed', on ? 'true' : 'false'); btn.classList.toggle('off', !on); }
  toggleBlueBtn.addEventListener('click',()=>{ const visible = blueGroup.style.display !== 'none'; setToggle(toggleBlueBtn, blueGroup, !visible); });
  toggleRedBtn.addEventListener('click',()=>{ const visible = redGroup.style.display !== 'none'; setToggle(toggleRedBtn, redGroup, !visible); });

  // ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´
  function onFilterChange(){ filterImp=selImp.value.trim(); renderEvents(); }
  selImp.addEventListener('change', onFilterChange);
  
  // ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°
  function showGenreFilterModal() {
    const genreLabels = GENRE_LABELS;
    
    let genreButtonsHtml = '';
    for (const genre of GENRES) {
      const isSelected = selectedGenres.has(genre);
      const label = (GENRE_LABELS && GENRE_LABELS[genre]) ? GENRE_LABELS[genre] : (genreLabels[genre] || genre);
      genreButtonsHtml += `
        <button class="genre-btn ${isSelected ? 'selected' : ''}" 
                data-genre="${genre}" 
                onclick="toggleGenre('${genre}')"
                style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; background: ${isSelected ? '#007bff' : '#f9f9f9'}; color: ${isSelected ? 'white' : 'black'};">
          ${label}
        </button>
      `;
    }
    
    const modalContent = `
      <div style="margin-bottom: 16px;">
        <button onclick="selectAllGenres()" style="margin-right: 8px; padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ã™ã¹ã¦ã‚’é¸æŠ</button>
        <button onclick="deselectAllGenres()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ã™ã¹ã¦ã‚’è§£é™¤</button>
      </div>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px;">
        ${genreButtonsHtml}
      </div>
      <div style="text-align: right;">
        <button onclick="applyGenreFilter()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">é©ç”¨</button>
      </div>
    `;
    
    openModal('ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ', modalContent);
  }
  
  function toggleGenre(genre) {
    if (selectedGenres.has(genre)) {
      selectedGenres.delete(genre);
    } else {
      selectedGenres.add(genre);
    }
    // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
    const btn = document.querySelector(`[data-genre="${genre}"]`);
    if (btn) {
      const isSelected = selectedGenres.has(genre);
      btn.classList.toggle('selected', isSelected);
      btn.style.background = isSelected ? '#007bff' : '#f9f9f9';
      btn.style.color = isSelected ? 'white' : 'black';
    }
  }
  
  function selectAllGenres() {
    selectedGenres.clear();
    for (const genre of GENRES) {
      selectedGenres.add(genre);
    }
    // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«æ›´æ–°
    document.querySelectorAll('.genre-btn').forEach(btn => {
      btn.classList.add('selected');
      btn.style.background = '#007bff';
      btn.style.color = 'white';
    });
  }
  
  function deselectAllGenres() {
    selectedGenres.clear();
    // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‚’éé¸æŠçŠ¶æ…‹ã«æ›´æ–°
    document.querySelectorAll('.genre-btn').forEach(btn => {
      btn.classList.remove('selected');
      btn.style.background = '#f9f9f9';
      btn.style.color = 'black';
    });
  }
  
  function applyGenreFilter() {
    closeModal();
    renderEvents();
    updateGenreFilterButtonText();
  }
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  window.toggleGenre = toggleGenre;
  window.selectAllGenres = selectAllGenres;
  window.deselectAllGenres = deselectAllGenres;
  window.applyGenreFilter = applyGenreFilter;
  window.addEraItem = addEraItem;
  window.saveEraSettings = saveEraSettings;
  
  // ã‚¸ãƒ£ãƒ³ãƒ«ã”ã¨ã®ç™»éŒ²ä»¶æ•°ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
  function getGenreCounts() {
    const counts = {};
    const genreLabels = GENRE_LABELS;
    
    // å„ã‚¸ãƒ£ãƒ³ãƒ«ã®ä»¶æ•°ã‚’åˆæœŸåŒ–
    for (const code of GENRES) counts[code] = 0;
    
    // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä»¶æ•°ã‚’è¨ˆç®—ï¼ˆé…åˆ—ã‚¸ãƒ£ãƒ³ãƒ«å¯¾å¿œï¼‰
    for (const items of Object.values(events)) {
      for (const item of (items || [])) {
        const g = item.genre;
        if (Array.isArray(g)) {
          for (const codeRaw of g) {
            const code = String(codeRaw || 'UNC').toUpperCase();
            if (!(code in counts)) counts[code] = 0; // æœªçŸ¥ã‚¸ãƒ£ãƒ³ãƒ«ã‚‚è¨ˆä¸Š
            counts[code]++;
          }
        } else {
          const code = String(g || 'UNC').toUpperCase();
          if (!(code in counts)) counts[code] = 0;
          counts[code]++;
        }
      }
    }
    
    return counts;
  }
  
  // ç·ç™»éŒ²ä»¶æ•°ã‚’å–å¾—ã™ã‚‹é–¢æ•°
  function getTotalItemCount() {
    let total = 0;
    for (const [year, items] of Object.entries(events)) {
      total += items.length;
    }
    return total;
  }
  
  // ã‚¸ãƒ£ãƒ³ãƒ«ä¸€è¦§ã‚’ä»¶æ•°ä»˜ãã§ç”Ÿæˆã™ã‚‹é–¢æ•°
  function generateGenreListWithCounts() {
    const counts = getGenreCounts();
    const genreLabels = GENRE_LABELS;
    
    return GENRES.map(genre => {
      const count = counts[genre] || 0;
      const label = (GENRE_LABELS && GENRE_LABELS[genre]) ? GENRE_LABELS[genre] : (genreLabels[genre] || genre);
      return `<li><strong>${genre}:</strong> ${label}ï¼ˆ${count}ï¼‰</li>`;
    }).join('');
  }
  
  function updateGenreFilterButtonText() {
    if (selectedGenres.size === 0) {
      genreFilterBtn.textContent = 'ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ';
    } else if (selectedGenres.size === GENRES.length) {
      genreFilterBtn.textContent = 'ã™ã¹ã¦ã®ã‚¸ãƒ£ãƒ³ãƒ«';
    } else {
      genreFilterBtn.textContent = `${selectedGenres.size}å€‹ã®ã‚¸ãƒ£ãƒ³ãƒ«`;
    }
  }
  
  // ã‚¸ãƒ£ãƒ³ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  genreFilterBtn.addEventListener('click', showGenreFilterModal);
  
  // æ™‚ä»£åŒºåˆ†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  const eraBtn = document.getElementById('eraBtn');
  eraBtn.addEventListener('click', showEraSettingsModal);

  // ãƒ˜ãƒ«ãƒ—
  document.getElementById('helpBtn').addEventListener('click', ()=>{
    const helpHtml = `
      <h4 style="color: red;">ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒãƒƒãƒ—ã‚’ç·¨é›†ã„ãŸã ã‘ã‚‹æ–¹ã¸</h4>
      <p><strong>ï¼‘ï¼‰</strong>ç®¡ç†è€…ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æä¾›ã•ã‚Œã¦ã„ã‚‹æ–¹ã¯è¨­å®šã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚<br>
      ã€€ç·¨é›†ã—ãŸå†…å®¹ã¯ã€ŒåŒæœŸã€ãƒœã‚¿ãƒ³ã®æŠ¼ä¸‹ã§ãƒªãƒ¢ãƒ¼ãƒˆDBã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
      <p><strong>ï¼’ï¼‰</strong>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãŒç©ºã®çŠ¶æ…‹ã§ä½¿ã†ã“ã¨ã‚‚ã§ãã¾ã™ã€‚<br>
      ã€€ç·¨é›†ã—ãŸå†…å®¹ã¯ã€ŒåŒæœŸã€ãƒœã‚¿ãƒ³ã®æŠ¼ä¸‹ã§ä¿®æ­£å†…å®¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã§ãã¾ã™ã€‚<br>
      ã€€â˜…ãƒªãƒ¢ãƒ¼ãƒˆDBã«ã¯åæ˜ ã•ã‚Œã¾ã›ã‚“ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚<br>
      ã€€ä¿®æ­£å†…å®¹ã¯ç®¡ç†è€…ã«ãŠé€ã‚Šã„ãŸã ã‘ã‚‹ã¨ã¨ãã«ç«¶åˆã™ã‚‹å†…å®¹ãŒãªã„é™ã‚Šåæ˜ ã•ã›ã¦ã„ãŸã ãæ–¹é‡ã§ã™ã€‚</p>
      <p>â€»ã‚µãƒ¼ãƒ“ã‚¹ã¯è©¦é¨“é‹ç”¨ä¸­ã§ã™ã€‚<br>
      â€»è©³ã—ã„ä½¿ã„æ–¹ã¯ã€<a href="https://github.com/hortense667/nativemap" target="_blank">https://github.com/hortense667/nativemap</a> ã‚’ã”è¦§ãã ã•ã„ã€‚</p>
      <hr style="margin: 20px 0;">
      <h4>ä½¿ã„ã‹ãŸã®ä¾‹ï¼ˆä»»å¤©å ‚ãƒ•ã‚¡ãƒŸã‚³ãƒ³ï¼‰</h4>
      <p>ä»»å¤©å ‚ã®ãƒ•ã‚¡ãƒŸã‚³ãƒ³ç™ºå£²æ™‚ã®å¹´é½¢ã‚’çŸ¥ã‚ŠãŸã„ã¨ã—ã¾ã™ã€‚</p>
      <ol>
        <li><strong>ã‚¤ãƒ™ãƒ³ãƒˆå¹´ã‚’åˆã‚ã›ã‚‹ï¼š</strong> ãƒ‰ãƒ©ãƒƒã‚°å°‚ç”¨ãƒ¬ãƒ¼ãƒ³ã®<strong>æ°´è‰²ã®ä¸¸</strong>ã‚’ä¸Šä¸‹ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€å·¦ã‚«ãƒ©ãƒ ã®ãƒ©ãƒ™ãƒ«<strong>ã€Œ83 ä»»å¤©å ‚ãƒ•ã‚¡ãƒŸã‚³ãƒ³ã€</strong>ã¨åŒã˜é«˜ã•ã«æƒãˆã¾ã™ã€‚ç¸¦è»¸ã®å†…å´ã« <em>ã€Œ1983å¹´ã€</em> ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
        <li><strong>ç”Ÿå¹´ã‚’åˆã‚ã›ã‚‹ï¼š</strong> æ°´è‰²ã®æ–œã‚ç·šã®å·¦ç«¯ï¼ˆç¸¦è»¸ã¨äº¤ã‚ã‚‹ä½ç½®ï¼‰è¿‘ãã®<strong>æ°´è‰²ã®ä¸¸</strong>ã‚’ä¸Šä¸‹ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€ç”Ÿå¹´ï¼ˆä¾‹ï¼š<em>1965å¹´ç”Ÿ</em>ï¼‰ã«åˆã‚ã›ã¾ã™ã€‚ä¸Šéƒ¨ã«ã¯ <em>ã€Œ18æ­³ã€</em> ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
      </ol>
      <p>åŒã˜æ“ä½œã¯èµ¤ã„ä¸¸ï¼ˆèµ¤è‰²ãƒ©ã‚¤ãƒ³ï¼‰ã§ã‚‚è¡Œãˆã¾ã™ã€‚å³ä¸Šã®å°ã•ãªä¸¸ãƒœã‚¿ãƒ³ã§å„ãƒ©ã‚¤ãƒ³ã®è¡¨ç¤ºã‚’ã‚ªãƒ³/ã‚ªãƒ•ã§ãã¾ã™ã€‚</p>
      <h4>åŸºæœ¬æ“ä½œ</h4>
      <ul>
        <li><strong>ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼š</strong>ãƒ›ã‚¤ãƒ¼ãƒ«ï¼ãƒˆãƒ©ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ï¼çŸ¢å°ã‚­ãƒ¼</li>
        <li><strong>ãƒ©ãƒ™ãƒ«ç·¨é›†ï¼š</strong>å·¦ã‚«ãƒ©ãƒ ã®å¹´è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚</li>
        <li><strong>æ¤œç´¢ï¼š</strong>æ¤œç´¢æ¬„ â†’ ã€Œæ¤œç´¢ã€ã€Œå‰ã€ã€Œæ¬¡ã€ã€‚ãƒ©ãƒ™ãƒ«ï¼ˆä½œå“åã‚„è£½å“åï¼‰ã‚’æ¤œç´¢å¯¾è±¡ã¨ã—ã¾ã™</li>
        <li><strong>è¡¨ç¤ºåˆ‡æ›¿ï¼š</strong>ã€Œã‚¸ãƒ£ãƒ³ãƒ«ã€ã€Œé‡è¦åº¦ã€ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆé‡è¦åº¦ã¯é¸æŠå€¤ä»¥ä¸Šã®ã¿è¡¨ç¤ºï¼‰</li>
      </ul>
      <h4>æ™‚ä»£åŒºåˆ†ï¼ˆèƒŒæ™¯ã®è‰²å¸¯ï¼‰</h4>
      <ul>
        <li><strong>ã€Œæ™‚ä»£åŒºåˆ†ã€</strong>ãƒœã‚¿ãƒ³ã‚’é–‹ãã€åç§°ãƒ»æœŸé–“ãƒ»è‰²ãƒ»é€æ˜åº¦ã‚’è¨­å®šã—ã¾ã™ã€‚</li>
        <li>è¡¨ç¤ºãƒã‚§ãƒƒã‚¯ã§ON/OFFã‚’åˆ‡æ›¿ã€‚è¡¨ç¤ºæ™‚ã«å½“è©²æœŸé–“ã‚’å¡—ã‚‹ã“ã¨ã‚‚ON/OFFã§ãã¾ã™ã€‚é‡ãªã‚Šã¯ä¸Šã‹ã‚‰é †ã«æç”»ã•ã‚Œã¾ã™ã€‚</li>
        <li>ä¿å­˜ã™ã‚‹ã¨ç”»é¢ã«è‰²å¸¯ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚</li>
        <li>æ™‚ä»£åŒºåˆ†ã¯åŒæœŸã—ã¦ã‚‚ãƒªãƒ¢ãƒ¼ãƒˆã«ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚åŸºæœ¬æ™‚ä»£åŒºåˆ†ï¼ˆãƒ†ãƒ¬ãƒ“ã‚„ã‚²ãƒ¼ãƒ ãªã©ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã”ã¨ã®æ™‚ä»£åŒºåˆ†ï¼‰ã®ã¿ç·¨é›†ãƒ»ä¿å­˜å¯èƒ½ã§ã™ã€‚</li>
      </ul>
      <h4>è©³ç´°ä¸€è¦§</h4>
      <p>å·¦ã‚«ãƒ©ãƒ ï¼ˆå¹´ã”ã¨ã®ä¸€è¦§ï¼‰ã§ä½œå“ã‚„è£½å“åã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®å¹´ã®<strong>è©³ç´°ä¸€è¦§</strong>ãŒé–‹ãã¾ã™ã€‚ã“ã“ã‹ã‚‰æ¬¡ãŒå¯èƒ½ã§ã™ã€‚</p>
      <ul>
        <li><strong>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚¯ã‚’é–‹ãï¼š</strong> ãƒ†ãƒ¬ãƒ“ç•ªçµ„ã‚„ãƒãƒ³ã‚¬é€£è¼‰ãªã©æœŸé–“ã®ã‚ã‚‹é …ç›®ã¯ã€é–‹å§‹/çµ‚äº†å¹´ã‚’æ™‚ä»£åŒºåˆ†ã«ç™»éŒ²ã—ã¾ã™ã€‚</li>
        <li><strong>ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’é–‹ãï¼š</strong> åœ°çƒå„€ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ Wikipedia ãªã©é–¢é€£ãƒšãƒ¼ã‚¸ã‚’æ–°è¦ã‚¿ãƒ–ã§è¡¨ç¤ºã€‚</li>
        <li><strong>å†…å®¹ã®ç·¨é›†ï¼š</strong> ãƒšãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ãƒ©ãƒ™ãƒ«ã€ã‚¸ãƒ£ãƒ³ãƒ«ã€é‡è¦åº¦ã€URLã€æ³¨é‡ˆã‚’ç·¨é›†ã€‚</li>
        <li><strong>æ–°è¦ç™»éŒ²ï¼š</strong> ä¸€è¦§ä¸‹éƒ¨ã®ã€Œè¿½åŠ ã€ã‹ã‚‰ã€æ–°è¦é …ç›®ã‚’è¿½åŠ ã€‚</li>
        <li><strong>é †åºã®å¤‰æ›´ï¼š</strong> é …ç›®ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</li>
      </ul>
      <h4>æ–°è¦ç™»éŒ²</h4>
      <p>å·¦ã‚«ãƒ©ãƒ ã®ä½œå“ãƒ»è£½å“åãŒä¸¦ã¶ã‚¨ãƒªã‚¢ã®<strong>ç©ºç™½éƒ¨åˆ†</strong>ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€<strong>æ–°è¦ç™»éŒ²</strong>ãŒã§ãã¾ã™ã€‚ãƒ©ãƒ™ãƒ«ã€ã‚¸ãƒ£ãƒ³ãƒ«ã€é‡è¦åº¦ã€URLã€æ³¨é‡ˆã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
      <h4>ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ</h4>
      <p><strong>é‡è¦ï¼š</strong>ç·¨é›†ã‚’é–‹å§‹ã™ã‚‹å‰ã«å¿…ãš<strong>ã€ŒåŒæœŸã€</strong>ã§æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ç·¨é›†ä½œæ¥­ãŒçµ‚ã‚ã£ãŸã‚‰å¿…ãš<strong>ã€ŒåŒæœŸã€</strong>ã§GitHubã¸ä¿å­˜ãƒ»åæ˜ ã—ã¦ãã ã•ã„ï¼ˆä¸¦ã³æ›¿ãˆãƒ»è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¿®æ­£ã®ã™ã¹ã¦ãŒå¯¾è±¡ï¼‰ã€‚</p>
      <p><strong>GitHubã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆï¼š</strong>ã€ŒåŒæœŸã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å¤‰æ›´ã•ã‚ŒãŸé …ç›®ã®ã¿ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†è€…ã«é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã§ãã¾ã™ã€‚</p>
      <h4>CSV/TSVèª­ã¿è¾¼ã¿å½¢å¼</h4>
      <p>ã€Œãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§CSV/TSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ä¸€æ‹¬ã§ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</p>
      <p><strong>å½¢å¼ï¼š</strong> <code>é–‹å§‹å¹´;çµ‚äº†å¹´;ãƒ©ãƒ™ãƒ«;ã‚¸ãƒ£ãƒ³ãƒ«;é‡è¦åº¦;URL;æ³¨é‡ˆ</code></p>
      <p><strong>ä¾‹ï¼š</strong> <code>1946;;ENIAC;HAR;5;https://ja.wikipedia.org/wiki/ENIAC;åˆã®å¤§è¦æ¨¡é›»å­è¨ˆç®—æ©Ÿ</code></p>
      <h5>ã‚¸ãƒ£ãƒ³ãƒ«ä¸€è¦§ï¼ˆã‚«ãƒƒã‚³å†…ã¯ç™»éŒ²ä»¶æ•°ï¼ç·ç™»éŒ²ä»¶æ•°ï¼š${getTotalItemCount()}ä»¶ï¼‰</h5>
      <ul>
        ${generateGenreListWithCounts()}
      </ul>
      <h5>é‡è¦åº¦</h5>
      <ul>
        <li><strong>1:</strong> å‚è€ƒç¨‹åº¦</li>
        <li><strong>2:</strong> ã‚„ã‚„é‡è¦</li>
        <li><strong>3:</strong> é‡è¦</li>
        <li><strong>4:</strong> ã‹ãªã‚Šé‡è¦</li>
        <li><strong>5:</strong> æœ€é‡è¦</li>
      </ul>
      <div class="credit">(c) 2025 Satoshi Endo CC-BY 4.0</div>
    `;
    openModal('ãƒ˜ãƒ«ãƒ— - ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒãƒƒãƒ— 1.0', helpHtml);
  });

  // ===== ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ =====
  function runSmokeTests(){ try { renderEvents(); console.debug('[TEST] renderEvents (clip no-ellipsis): OK'); } catch(e){ console.error('[TEST] renderEvents threw', e); } }
  setTimeout(runSmokeTests, 0);
})();
</script>
</body>
</html>
